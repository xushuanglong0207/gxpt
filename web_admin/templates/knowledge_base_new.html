{% extends "base.html" %}

{% block title %}高效知识库 - 专业笔记管理系统{% endblock %}

{% block styles %}
<link href="{{ url_for('static', filename='editor/css/knowledge-pro.css') }}" rel="stylesheet">
<link href="{{ url_for('static', filename='css/prism.css') }}" rel="stylesheet">
<style>
    .knowledge-main {
        display: flex;
        min-height: calc(100vh - 180px);
        width: 100%;
        max-width: 100%;
        margin: 0;
        padding: 0;
    }
    
    .knowledge-sidebar {
        width: 350px;
        background-color: #f8f9fa;
        border-right: 1px solid #dee2e6;
        padding: 1rem;
        transition: all 0.3s ease;
        flex-shrink: 0;
    }
    
    .knowledge-content {
        flex: 1;
        padding: 1.5rem;
        overflow-y: auto;
        min-width: 0;
    }
    
    .kb-content-main {
        position: relative;
        min-height: calc(100vh - 250px);
        width: 100%;
        resize: both;
        overflow: auto;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        padding-bottom: 15px;
        height: calc(100vh - 250px);
        max-width: 100%;
        min-width: 90%;
    }
    
    /* 编辑器内部文章结构样式 */
    .kb-editor-outline {
        position: absolute;
        right: 0;
        top: 0;
        width: 300px;
        height: 100%;
        background-color: #f8f9fa;
        border-left: 1px solid #dee2e6;
        transition: transform 0.3s ease;
        z-index: 100;
        transform: translateX(100%); /* 默认收起 */
    }
    
    .kb-editor-outline.collapsed {
        transform: translateX(100%);
    }
    
    .kb-outline-toggle {
        position: absolute;
        right: 0; /* 默认位置在右侧 */
        top: 10px;
        z-index: 101;
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        padding: 5px 10px;
        cursor: pointer;
        transition: right 0.3s ease;
    }
    
    .kb-outline-toggle.collapsed {
        right: 0;
    }
    
    .kb-outline-toggle:not(.collapsed) {
        right: 300px;
    }
    
    .kb-outline-title {
        font-weight: 600;
        margin-bottom: 10px;
        padding: 10px;
        border-bottom: 1px solid #dee2e6;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .kb-outline-list {
        list-style: none;
        margin: 0;
        padding: 10px;
        overflow-y: auto;
        height: calc(100% - 50px);
    }
    
    .kb-outline-item {
        margin: 5px 0;
        cursor: pointer;
        padding: 3px 5px;
        border-radius: 3px;
        transition: background-color 0.2s;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
    
    .kb-outline-item:hover {
        background-color: #e9ecef;
        color: #0d6efd;
    }
    
    .kb-outline-h1 { margin-left: 0; font-weight: 600; }
    .kb-outline-h2 { margin-left: 15px; font-weight: 500; }
    .kb-outline-h3 { margin-left: 30px; }
    .kb-outline-h4 { margin-left: 45px; }
    .kb-outline-h5 { margin-left: 60px; }
    .kb-outline-h6 { margin-left: 75px; }
    
    /* 确保编辑器内容区域填满可用空间 */
    .knowledge-pro-editor {
        width: 100% !important;
        height: 100% !important;
        display: flex;
        flex-direction: column;
    }
    
    .knowledge-editor-content {
        flex: 1;
        overflow: auto !important;
        width: 100% !important;
        height: calc(100% - 40px) !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="knowledge-main" id="knowledge-container">
    <!-- 左侧边栏 -->
    <div class="knowledge-sidebar" id="sidebar">
        <div class="sidebar-header">
            <h5 class="sidebar-title mb-0">知识模块</h5>
            <div class="sidebar-actions">
                <button class="btn btn-sm btn-primary" id="createModuleBtn">
                    <i class="fas fa-plus"></i> <span>新建模块</span>
                </button>
                <button class="btn btn-sm btn-light toggle-sidebar ml-2" id="toggleSidebar">
                    <i class="fas fa-chevron-left"></i>
                </button>
            </div>
        </div>
        
        <!-- 搜索框 -->
        <div class="search-box mb-3">
            <div class="input-group">
                <input type="text" class="form-control" id="searchKnowledge" placeholder="搜索知识库..." aria-label="搜索知识库">
                <button class="btn btn-outline-secondary" type="button" id="searchBtn">
                    <i class="fas fa-search"></i>
                </button>
            </div>
        </div>
        
        <!-- 模块树 -->
        <div class="kb-module-tree" id="moduleTree">
            <!-- 模块加载中提示 -->
            <div class="kb-loading" id="moduleLoading">
                <i class="fas fa-circle-notch fa-spin"></i> 正在加载...
            </div>
            
            <!-- 模块内容将通过JavaScript动态生成 -->
        </div>
    </div>
    
    <!-- 右侧内容区 -->
    <div class="knowledge-content" id="content">
        <!-- 警报容器 -->
        <div id="alerts-container" class="alerts-container position-fixed" style="top: 70px; right: 20px; z-index: 1050; width: 350px;"></div>
        
        <!-- 欢迎页 -->
        <div class="kb-welcome" id="welcomeContainer">
            <div class="kb-welcome-icon">
                <i class="fas fa-book-reader"></i>
            </div>
            <h2 class="kb-welcome-title">欢迎使用高效知识库</h2>
            <p class="kb-welcome-desc">
                高效知识库是一个强大的笔记管理系统，帮助您组织和管理各类知识资料。
                <br>您可以从左侧创建模块或文章，开始构建自己的知识体系。
            </p>
            <div class="kb-welcome-actions">
                <button class="btn btn-primary" id="createFirstModuleBtn">
                    <i class="fas fa-folder-plus"></i> 创建首个模块
                </button>
                <button class="btn btn-outline-primary" id="learnMoreBtn">
                    <i class="fas fa-question-circle"></i> 了解更多
                </button>
            </div>
        </div>
        
        <!-- 文章内容区 -->
        <div class="kb-content-area" id="contentArea" style="display: none;">
            <div class="kb-content-header" id="contentHeader">
                <h1 class="kb-content-title" id="articleTitle">文章标题</h1>
                <div class="kb-content-meta" id="articleMeta">
                    <span class="article-time">更新于: <span id="updateTime">2023-03-25 10:30</span></span>
                    <span class="article-author">作者: <span id="authorName">系统管理员</span></span>
                </div>
                <div class="kb-content-actions">
                    <button class="btn btn-primary" id="editBtn">
                        <i class="fas fa-edit"></i> 编辑
                    </button>
                    <button class="btn btn-success" id="saveBtn" style="display: none;">
                        <i class="fas fa-save"></i> 保存
                    </button>
                </div>
            </div>
            
            <div class="kb-content-main" id="contentMain">
                <!-- 编辑器将在这里初始化 -->
                <div id="editor"></div>
                
                <!-- 编辑器内部文章结构 -->
                <div class="kb-editor-outline" id="editorOutline">
                    <div class="kb-outline-title">
                        <span>文章结构</span>
                        <button class="btn btn-sm btn-outline-secondary" id="refreshOutline">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                    </div>
                    <ul class="kb-outline-list" id="outlineList">
                        <li class="text-muted">暂无标题结构</li>
                    </ul>
                </div>
                
                <!-- 文章结构切换按钮 -->
                <button class="kb-outline-toggle" id="outlineToggle">
                    <i class="fas fa-list"></i> 文章结构
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 创建模块模态框 -->
<div class="modal fade" id="createModuleModal" tabindex="-1" aria-labelledby="createModuleModalLabel">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="createModuleModalLabel">创建新模块</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="关闭"></button>
            </div>
            <div class="modal-body">
                <form id="createModuleForm">
                    <div class="mb-3">
                        <label for="moduleName" class="form-label">模块名称</label>
                        <input type="text" class="form-control" id="moduleName" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label for="parentModule" class="form-label">父级模块</label>
                        <select class="form-select" id="parentModule" name="parent_id">
                            <option value="">无（顶级模块）</option>
                            <!-- 模块选项将通过JavaScript动态生成 -->
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="moduleDesc" class="form-label">模块描述（可选）</label>
                        <textarea class="form-control" id="moduleDesc" name="description" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" id="confirmCreateModule">创建</button>
            </div>
        </div>
    </div>
</div>

<!-- 创建文章模态框 -->
<div class="modal fade" id="createArticleModal" tabindex="-1" aria-labelledby="createArticleModalLabel">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="createArticleModalLabel">创建新文章</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="关闭"></button>
            </div>
            <div class="modal-body">
                <form id="createArticleForm">
                    <div class="mb-3">
                        <label for="articleTitleInput" class="form-label">文章标题</label>
                        <input type="text" class="form-control" id="articleTitleInput" name="title" required>
                    </div>
                    <div class="mb-3">
                        <label for="moduleId" class="form-label">所属模块</label>
                        <select class="form-select" id="moduleId" name="module_id" required>
                            <option value="">请选择模块</option>
                            <!-- 模块选项将通过JavaScript动态生成 -->
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" id="confirmCreateArticle">创建</button>
            </div>
        </div>
    </div>
</div>

<!-- 重命名模态框 -->
<div class="modal fade" id="renameModal" tabindex="-1" aria-labelledby="renameModalLabel">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="renameModalLabel">重命名</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="关闭"></button>
            </div>
            <div class="modal-body">
                <form id="renameForm">
                    <input type="hidden" id="renameItemId" name="id">
                    <input type="hidden" id="renameItemType" name="type">
                    <div class="mb-3">
                        <label for="newName" class="form-label">新名称</label>
                        <input type="text" class="form-control" id="newName" name="name" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" id="confirmRename">保存</button>
            </div>
        </div>
    </div>
</div>

<!-- 确认删除模态框 -->
<div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-labelledby="deleteConfirmModalLabel">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteConfirmModalLabel">确认删除</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="关闭"></button>
            </div>
            <div class="modal-body">
                <p id="deleteConfirmMessage">确定要删除这个项目吗？此操作不可撤销。</p>
                <input type="hidden" id="deleteItemId">
                <input type="hidden" id="deleteItemType">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-danger" id="confirmDelete">删除</button>
            </div>
        </div>
    </div>
</div>

<!-- 帮助提示模态框 -->
<div class="modal fade" id="helpModal" tabindex="-1" aria-labelledby="helpModalLabel">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="helpModalLabel">知识库使用指南</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="关闭"></button>
            </div>
            <div class="modal-body">
                <h4>基本功能</h4>
                <ul>
                    <li><strong>模块管理</strong>：创建、重命名和删除知识模块</li>
                    <li><strong>文章管理</strong>：在模块中添加、编辑、重命名和删除文章</li>
                    <li><strong>富文本编辑</strong>：支持格式化文本、插入图片、表格等多种格式化功能</li>
                    <li><strong>快捷键</strong>：支持常用编辑快捷键，如Ctrl+B（加粗）、Ctrl+S（保存）等</li>
                </ul>
                
                <h4>快捷键</h4>
                <table class="table table-bordered">
                    <thead>
                        <tr>
                            <th>功能</th>
                            <th>快捷键</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>保存文章</td>
                            <td><kbd>Ctrl</kbd> + <kbd>S</kbd></td>
                        </tr>
                        <tr>
                            <td>加粗</td>
                            <td><kbd>Ctrl</kbd> + <kbd>B</kbd></td>
                        </tr>
                        <tr>
                            <td>斜体</td>
                            <td><kbd>Ctrl</kbd> + <kbd>I</kbd></td>
                        </tr>
                        <tr>
                            <td>下划线</td>
                            <td><kbd>Ctrl</kbd> + <kbd>U</kbd></td>
                        </tr>
                        <tr>
                            <td>撤销</td>
                            <td><kbd>Ctrl</kbd> + <kbd>Z</kbd></td>
                        </tr>
                        <tr>
                            <td>重做</td>
                            <td><kbd>Ctrl</kbd> + <kbd>Y</kbd></td>
                        </tr>
                    </tbody>
                </table>
                
                <h4>使用技巧</h4>
                <p>1. <strong>模块组织</strong>：建议根据主题或项目创建顶级模块，然后在其中创建子模块进行细分</p>
                <p>2. <strong>文章编辑</strong>：编辑完成后记得点击"保存"按钮或使用Ctrl+S快捷键保存内容</p>
                <p>3. <strong>快速搜索</strong>：使用搜索框快速查找模块或文章</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">了解了</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='editor/js/knowledge-pro.js') }}"></script>
<script src="{{ url_for('static', filename='js/prism.js') }}"></script>
<script>
// 知识库管理系统JavaScript实现
document.addEventListener('DOMContentLoaded', function() {
    // 全局变量
    let currentModules = [];
    let currentArticle = null;
    let currentModuleId = null;
    let editor = null;
    let lastFocusedElement = null; // 用于记录模态框打开前的焦点元素
    
    // DOM元素缓存
    const sidebar = document.getElementById('sidebar');
    const moduleTree = document.getElementById('moduleTree');
    const welcomeContainer = document.getElementById('welcomeContainer');
    const contentArea = document.getElementById('contentArea');
    const editorElement = document.getElementById('editor');
    const createModuleBtn = document.getElementById('createModuleBtn');
    const createFirstModuleBtn = document.getElementById('createFirstModuleBtn');
    const learnMoreBtn = document.getElementById('learnMoreBtn');
    const articleTitle = document.getElementById('articleTitle');
    const updateTime = document.getElementById('updateTime');
    const authorName = document.getElementById('authorName');
    const editBtn = document.getElementById('editBtn');
    const saveBtn = document.getElementById('saveBtn');
    
    // 模态框相关元素
    const createModuleModal = new bootstrap.Modal(document.getElementById('createModuleModal'));
    const createArticleModal = new bootstrap.Modal(document.getElementById('createArticleModal'));
    const renameModal = new bootstrap.Modal(document.getElementById('renameModal'));
    const deleteConfirmModal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
    const helpModal = new bootstrap.Modal(document.getElementById('helpModal'));
    
    // 设置模态框事件处理程序，解决ARIA可访问性问题
    function setupModalEvents() {
        const modals = [
            'createModuleModal', 
            'createArticleModal', 
            'renameModal', 
            'deleteConfirmModal', 
            'helpModal'
        ];
        
        modals.forEach(modalId => {
            const modalElement = document.getElementById(modalId);
            
            // 记录模态框打开前的焦点元素
            modalElement.addEventListener('show.bs.modal', function() {
                lastFocusedElement = document.activeElement;
            });
            
            // 模态框关闭后恢复焦点
            modalElement.addEventListener('hidden.bs.modal', function() {
                if (lastFocusedElement) {
                    lastFocusedElement.focus();
                }
            });
            
            // 确保模态框中的任何表单输入聚焦时，aria-hidden属性被移除
            modalElement.querySelectorAll('input, button, select, textarea').forEach(element => {
                element.addEventListener('focus', function() {
                    const modal = this.closest('.modal');
                    if (modal && modal.getAttribute('aria-hidden') === 'true') {
                        modal.removeAttribute('aria-hidden');
                    }
                });
            });
        });
    }
    
    // 初始化编辑器
    function initEditor() {
        if (editor) return editor;
        
        editor = KnowledgePro.init('editor', {
            height: '500px',
            placeholder: '开始写作您的文档...',
            callbacks: {
                onInit: function(api) {
                    console.log('编辑器初始化完成');
                    // 确保编辑器初始化后文章结构是收起的
                    const editorOutline = document.getElementById('editorOutline');
                    const outlineToggle = document.getElementById('outlineToggle');
                    if (editorOutline && outlineToggle) {
                        editorOutline.classList.add('collapsed');
                        outlineToggle.classList.add('collapsed');
                        const icon = outlineToggle.querySelector('i');
                        if (icon) {
                            icon.className = 'fas fa-list';
                        }
                    }
                },
                onChange: function(content) {
                    // 内容变化时更新文章结构
                    setTimeout(updateArticleOutline, 300);
                },
                onSave: function(content) {
                    saveCurrentArticle(content);
                }
            }
        });
        
        return editor;
    }
    
    // 加载模块列表
    function loadModules() {
        moduleTree.innerHTML = '<div class="kb-loading"><i class="fas fa-circle-notch fa-spin"></i> 正在加载...</div>';
        
        fetch('/api/knowledge/modules')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    currentModules = data.modules;
                    renderModules(currentModules);
                    
                    // 如果没有模块，显示欢迎页
                    if (currentModules.length === 0) {
                        showWelcomePage();
                    }
                } else {
                    moduleTree.innerHTML = '<div class="kb-empty"><i class="fas fa-exclamation-circle"></i><p>加载失败: ' + data.message + '</p></div>';
                }
            })
            .catch(error => {
                console.error('加载模块失败:', error);
                moduleTree.innerHTML = '<div class="kb-empty"><i class="fas fa-exclamation-circle"></i><p>加载失败，请刷新页面重试</p></div>';
            });
    }
    
    // 渲染模块树
    function renderModules(modules) {
        if (!modules || modules.length === 0) {
            moduleTree.innerHTML = '<div class="kb-empty"><i class="fas fa-folder-open"></i><h4>暂无知识模块</h4><p>点击"新建模块"按钮创建您的第一个知识模块</p></div>';
            return;
        }
        
        let html = '';
        modules.forEach(module => {
            html += renderModuleItem(module);
        });
        
        moduleTree.innerHTML = html;
        
        // 绑定模块点击事件
        document.querySelectorAll('.kb-module-header').forEach(el => {
            el.addEventListener('click', function(e) {
                if (e.target.tagName === 'BUTTON' || e.target.closest('button')) {
                    return; // 如果点击的是按钮，不处理折叠
                }
                
                const moduleItem = this.closest('.kb-module');
                const children = moduleItem.querySelector('.kb-module-children');
                
                if (children) {
                    children.style.display = children.style.display === 'none' ? 'block' : 'none';
                    const icon = this.querySelector('.kb-module-icon i');
                    if (icon) {
                        icon.className = children.style.display === 'none' ? 'fas fa-folder' : 'fas fa-folder-open';
                    }
                }
            });
        });
        
        // 绑定文章点击事件
        document.querySelectorAll('.kb-article-item').forEach(el => {
            el.addEventListener('click', function(e) {
                if (e.target.tagName === 'BUTTON' || e.target.closest('button')) {
                    return; // 如果点击的是按钮，不处理
                }
                
                const articleId = this.getAttribute('data-id');
                loadArticle(articleId);
                
                // 更新选中状态
                document.querySelectorAll('.kb-article-item.active').forEach(item => item.classList.remove('active'));
                this.classList.add('active');
            });
        });
    }
    
    // 渲染单个模块项
    function renderModuleItem(module) {
        let html = `
        <div class="kb-module" data-id="${module.id}">
            <div class="kb-module-header">
                <div class="kb-module-icon">
                    <i class="fas ${module.children && module.children.length > 0 ? 'fa-folder-open' : 'fa-folder'}"></i>
                </div>
                <div class="kb-module-name">${module.name}</div>
                <div class="kb-module-actions">
                    <button class="btn-add-article" title="新建文章" onclick="createArticle('${module.id}')">
                        <i class="fas fa-file-medical"></i>
                    </button>
                    <button class="btn-add-submodule" title="新建子模块" onclick="createSubmodule('${module.id}')">
                        <i class="fas fa-folder-plus"></i>
                    </button>
                    <button class="btn-rename" title="重命名" onclick="renameModule('${module.id}')">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn-delete" title="删除" onclick="deleteModule('${module.id}')">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>`;
        
        // 渲染子模块和文章
        if ((module.children && module.children.length > 0) || (module.articles && module.articles.length > 0)) {
            html += '<div class="kb-module-children">';
            
            // 渲染子模块
            if (module.children && module.children.length > 0) {
                module.children.forEach(child => {
                    html += renderModuleItem(child);
                });
            }
            
            // 渲染文章
            if (module.articles && module.articles.length > 0) {
                html += '<div class="kb-articles">';
                module.articles.forEach(article => {
                    html += `
                    <div class="kb-article-item" data-id="${article.id}">
                        <div class="kb-article-icon">
                            <i class="fas fa-file-alt"></i>
                        </div>
                        <div class="kb-article-title">${article.title}</div>
                        <div class="kb-article-actions">
                            <button class="btn-rename" title="重命名" onclick="renameArticle('${article.id}')">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn-delete" title="删除" onclick="deleteArticle('${article.id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>`;
                });
                html += '</div>';
            }
            
            html += '</div>';
        }
        
        html += '</div>';
        return html;
    }
    
    // 显示欢迎页
    function showWelcomePage() {
        welcomeContainer.style.display = 'block';
        contentArea.style.display = 'none';
    }
    
    // 加载文章内容
    function loadArticle(articleId) {
        if (!articleId) {
            console.error('无效的文章ID');
            return;
        }
        
        // 显示文章内容区域，隐藏欢迎页
        welcomeContainer.style.display = 'none';
        contentArea.style.display = 'block';
        
        // 确保文章结构默认收起
        const editorOutline = document.getElementById('editorOutline');
        const outlineToggle = document.getElementById('outlineToggle');
        if (editorOutline && outlineToggle) {
            editorOutline.classList.add('collapsed');
            outlineToggle.classList.add('collapsed');
            const icon = outlineToggle.querySelector('i');
            if (icon) {
                icon.className = 'fas fa-list';
            }
        }
        
        // 如果文章内容区没有编辑器元素，则添加一个
        if (!document.getElementById('editor')) {
            const editorContainer = document.getElementById('contentMain');
            if (editorContainer) {
                editorContainer.innerHTML = '<div id="editor"></div>';
            }
        }
        
        // 获取编辑器元素的引用
        const editorElement = document.getElementById('editor');
        
        // 显示加载状态
        editorElement.innerHTML = `
            <div class="kb-loading">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">正在加载...</span>
                </div>
                <p class="mt-3">正在加载文章内容...</p>
            </div>
        `;
        
        // 清除之前的编辑器实例（如果存在）
        if (editor) {
            editor.destroy();
            editor = null;
        }
        
        console.log(`正在加载文章: ${articleId}`);
        
        // 记录尝试次数以便实现重试逻辑
        let attemptCount = 0;
        const maxAttempts = 3;
        
        function attemptLoadArticle() {
            attemptCount++;
            console.log(`尝试加载文章(${attemptCount}/${maxAttempts}): ${articleId}`);
            
            // 添加随机参数防止缓存
            let fetchUrl = `/api/knowledge/article/${articleId}?t=${new Date().getTime()}`;
            
            fetch(fetchUrl)
                .then(response => {
                    console.log(`文章加载响应状态: ${response.status}`);
                    if (!response.ok) {
                        throw new Error(`服务器响应错误: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('文章数据加载成功:', data);
                    
                    if (data.success) {
                        // 保存当前文章到全局变量
                        currentArticle = {
                            id: data.id,
                            title: data.title,
                            content: data.content || '',
                            module_id: data.module_id,
                            created_at: data.created_at,
                            updated_at: data.updated_at,
                            created_by: data.created_by,
                            updated_by: data.updated_by
                        };
                        
                        // 更新UI
                        articleTitle.textContent = data.title || '无标题';
                        updateTime.textContent = formatDate(data.updated_at || data.created_at);
                        authorName.textContent = data.created_by || '未知用户';
                        
                        // 初始化编辑器（如果没有初始化）
                        if (!editor) {
                            editor = initEditor();
                        }
                        
                        // 设置编辑器内容
                        editor.setContent(data.content || '');
                        
                        // 默认设置为阅读模式
                        setEditorMode('read');
                        
                        // 更新文章项在左侧的选中状态
                        document.querySelectorAll('.kb-article-item').forEach(item => {
                            if (item.getAttribute('data-id') === articleId) {
                                item.classList.add('active');
                            } else {
                                item.classList.remove('active');
                            }
                        });
                    } else {
                        // 处理加载失败的情况
                        if (attemptCount < maxAttempts) {
                            // 延迟重试
                            editorElement.innerHTML = `
                                <div class="kb-loading">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">正在加载...</span>
                                    </div>
                                    <p class="mt-3">正在尝试重新加载... (${attemptCount}/${maxAttempts})</p>
                                </div>
                            `;
                            setTimeout(attemptLoadArticle, 1000); // 1秒后重试
                        } else {
                            // 达到最大重试次数，显示错误
                            editorElement.innerHTML = `
                                <div class="kb-error">
                                    <i class="fas fa-exclamation-circle"></i>
                                    <h4>加载文章失败</h4>
                                    <p>${data.error || '未知错误'}</p>
                                    <button class="btn btn-outline-primary mt-3" onclick="loadArticle('${articleId}')">
                                        <i class="fas fa-sync-alt"></i> 重试
                                    </button>
                                </div>
                            `;
                        }
                    }
                })
                .catch(error => {
                    console.error('加载文章失败:', error);
                    
                    if (attemptCount < maxAttempts) {
                        // 延迟重试
                        editorElement.innerHTML = `
                            <div class="kb-loading">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">正在加载...</span>
                                </div>
                                <p class="mt-3">连接服务器失败，正在重试... (${attemptCount}/${maxAttempts})</p>
                            </div>
                        `;
                        setTimeout(attemptLoadArticle, 1500); // 1.5秒后重试
                    } else {
                        // 达到最大重试次数，显示错误
                        editorElement.innerHTML = `
                            <div class="kb-error">
                                <i class="fas fa-exclamation-circle"></i>
                                <h4>加载文章失败</h4>
                                <p>连接服务器时出错: ${error.message}</p>
                                <button class="btn btn-outline-primary mt-3" onclick="loadArticle('${articleId}')">
                                    <i class="fas fa-sync-alt"></i> 重试
                                </button>
                            </div>
                        `;
                    }
                });
        }
        
        // 开始第一次尝试加载
        attemptLoadArticle();
    }
    
    // 保存当前文章
    function saveCurrentArticle() {
        if (!currentArticle || !editor) {
            alert('没有可保存的文章');
            return;
        }
        
        const content = editor.getContent();
        
        // 显示保存中提示
        const saveText = saveBtn.innerHTML;
        saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 保存中...';
        saveBtn.disabled = true;
        
        // 发送保存请求
        fetch(`/api/knowledge/article/${currentArticle.id}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                content: content,
                title: currentArticle.title || ''
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // 更新当前文章
                Object.assign(currentArticle, data);
                
                // 更新界面
                updateTime.textContent = formatDate(data.updated_at || currentArticle.updated_at);
                
                // 切换到阅读模式
                setEditorMode('read');
                
                // 显示成功提示
                showAlert('success', '文章保存成功！');
            } else {
                showAlert('danger', '保存失败: ' + (data.message || '未知错误'));
            }
        })
        .catch(error => {
            console.error('保存文章失败:', error);
            showAlert('danger', '保存失败，请稍后重试');
        })
        .finally(() => {
            // 恢复按钮状态
            saveBtn.innerHTML = saveText;
            saveBtn.disabled = false;
        });
    }
    
    // 设置编辑器模式
    function setEditorMode(mode) {
        if (!editor) return;
        
        editor.setMode(mode);
        
        if (mode === 'edit') {
            editBtn.style.display = 'none';
            saveBtn.style.display = 'inline-block';
        } else {
            editBtn.style.display = 'inline-block';
            saveBtn.style.display = 'none';
        }
    }
    
    // 显示提示信息
    function showAlert(type, message) {
        const alertsContainer = document.getElementById('alerts-container');
        
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
        alertDiv.role = 'alert';
        
        alertDiv.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        `;
        
        alertsContainer.appendChild(alertDiv);
        
        // 5秒后自动关闭
        setTimeout(() => {
            const closeButton = alertDiv.querySelector('.btn-close');
            if (closeButton) {
                closeButton.click();
            }
        }, 5000);
    }
    
    // 格式化日期
    function formatDate(dateString) {
        if (!dateString) return '未知';
        
        try {
            // 尝试直接解析
            let date = new Date(dateString);
            
            // 检查是否是有效日期
            if (isNaN(date.getTime())) {
                // 尝试解析ISO格式
                if (typeof dateString === 'string') {
                    // 替换T和Z
                    dateString = dateString.replace('T', ' ').replace('Z', '');
                    
                    // 尝试不同的格式
                    if (dateString.includes('-')) {
                        // ISO格式：YYYY-MM-DD HH:MM:SS
                        const parts = dateString.split(/[- :]/);
                        if (parts.length >= 6) {
                            date = new Date(parts[0], parts[1] - 1, parts[2], parts[3], parts[4], parts[5]);
                        } else if (parts.length >= 3) {
                            date = new Date(parts[0], parts[1] - 1, parts[2]);
                        }
                    } else if (dateString.includes('/')) {
                        // 美式格式：MM/DD/YYYY
                        const parts = dateString.split(/[/ :]/);
                        if (parts.length >= 6) {
                            date = new Date(parts[2], parts[0] - 1, parts[1], parts[3], parts[4], parts[5]);
                        } else if (parts.length >= 3) {
                            date = new Date(parts[2], parts[0] - 1, parts[1]);
                        }
                    }
                }
            }
            
            // 如果仍然无效，返回原始字符串
            if (isNaN(date.getTime())) {
                console.warn('无法解析日期:', dateString);
                return dateString;
            }
            
            // 格式化为本地日期时间
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            
            return `${year}-${month}-${day} ${hours}:${minutes}`;
        } catch (error) {
            console.error('日期格式化错误:', error);
            return dateString || '未知';
        }
    }
    
    // 初始化事件绑定
    function initEvents() {
        // 创建模块按钮点击事件
        createModuleBtn.addEventListener('click', function() {
            // 清空父模块选择列表
            const parentSelect = document.getElementById('parentModule');
            parentSelect.innerHTML = '<option value="">无（顶级模块）</option>';
            
            // 填充模块列表选项
            function addModuleOptions(modules, level = 0) {
                if (!modules || !modules.length) return;
                
                modules.forEach(module => {
                    const indent = '　'.repeat(level); // 使用全角空格进行缩进
                    const option = document.createElement('option');
                    option.value = module.id;
                    option.textContent = indent + module.name;
                    parentSelect.appendChild(option);
                    
                    // 递归添加子模块
                    if (module.children && module.children.length) {
                        addModuleOptions(module.children, level + 1);
                    }
                });
            }
            
            // 添加所有模块选项
            addModuleOptions(currentModules);
            
            // 清空模块名称和描述
            document.getElementById('moduleName').value = '';
            document.getElementById('moduleDesc').value = '';
            
            // 弹出创建模块模态框
            createModuleModal.show();
        });
        
        // 创建第一个模块按钮点击事件
        createFirstModuleBtn.addEventListener('click', function() {
            // 清空父模块选择列表
            const parentSelect = document.getElementById('parentModule');
            parentSelect.innerHTML = '<option value="">无（顶级模块）</option>';
            
            // 清空模块名称和描述
            document.getElementById('moduleName').value = '';
            document.getElementById('moduleDesc').value = '';
            
            // 显示模态框
            createModuleModal.show();
        });
        
        // 了解更多按钮点击事件
        learnMoreBtn.addEventListener('click', function() {
            helpModal.show();
        });
        
        // 编辑按钮点击事件
        editBtn.addEventListener('click', function() {
            setEditorMode('edit');
        });
        
        // 保存按钮点击事件
        saveBtn.addEventListener('click', function() {
            saveCurrentArticle();
        });
        
        // 确认重命名按钮点击事件
        document.getElementById('confirmRename').addEventListener('click', function() {
            const id = document.getElementById('renameItemId').value;
            const type = document.getElementById('renameItemType').value;
            const newName = document.getElementById('newName').value.trim();
            
            if (!newName) {
                alert('请输入新名称');
                return;
            }
            
            if (type === 'module') {
                renameModuleById(id, newName);
            } else if (type === 'article') {
                renameArticleById(id, newName);
            }
        });
        
        // 确认删除按钮点击事件
        document.getElementById('confirmDelete').addEventListener('click', function() {
            const id = document.getElementById('deleteItemId').value;
            const type = document.getElementById('deleteItemType').value;
            
            console.log(`确认删除: 类型=${type}, ID=${id}`);
            
            if (type === 'module') {
                deleteModuleById(id);
            } else if (type === 'article') {
                deleteArticleById(id);
            } else {
                console.error(`未知的删除类型: ${type}`);
            }
        });
        
        // 添加全局函数，以便在HTML中调用
        window.createArticle = function(moduleId) {
            currentModuleId = moduleId;
            
            // 清空并填充模块选择列表
            const moduleSelect = document.getElementById('moduleId');
            moduleSelect.innerHTML = '<option value="">请选择模块</option>';
            
            // 填充模块列表选项
            function addModuleOptions(modules, level = 0) {
                if (!modules || !modules.length) return;
                
                modules.forEach(module => {
                    const indent = '　'.repeat(level); // 使用全角空格进行缩进
                    const option = document.createElement('option');
                    option.value = module.id;
                    option.textContent = indent + module.name;
                    
                    // 如果传入了模块ID，则默认选中
                    if (module.id === moduleId) {
                        option.selected = true;
                    }
                    
                    moduleSelect.appendChild(option);
                    
                    // 递归添加子模块
                    if (module.children && module.children.length) {
                        addModuleOptions(module.children, level + 1);
                    }
                });
            }
            
            // 添加所有模块选项
            addModuleOptions(currentModules);
            
            // 显示模态框
            createArticleModal.show();
        };
        
        window.createSubmodule = function(parentId) {
            // 清空并填充父模块选择列表
            const parentSelect = document.getElementById('parentModule');
            parentSelect.innerHTML = '<option value="">无（顶级模块）</option>';
            
            // 填充模块列表选项
            function addModuleOptions(modules, level = 0) {
                if (!modules || !modules.length) return;
                
                modules.forEach(module => {
                    const indent = '　'.repeat(level); // 使用全角空格进行缩进
                    const option = document.createElement('option');
                    option.value = module.id;
                    option.textContent = indent + module.name;
                    
                    // 如果传入了父模块ID，则默认选中
                    if (module.id === parentId) {
                        option.selected = true;
                    }
                    
                    parentSelect.appendChild(option);
                    
                    // 递归添加子模块
                    if (module.children && module.children.length) {
                        addModuleOptions(module.children, level + 1);
                    }
                });
            }
            
            // 添加所有模块选项
            addModuleOptions(currentModules);
            
            // 显示模态框
            createModuleModal.show();
        };
        
        window.renameModule = function(moduleId) {
            const module = findModuleById(moduleId);
            if (module) {
                document.getElementById('renameItemId').value = moduleId;
                document.getElementById('renameItemType').value = 'module';
                document.getElementById('newName').value = module.name;
                renameModal.show();
            }
        };
        
        window.renameArticle = function(articleId) {
            // 找到对应的文章
            fetch(`/api/knowledge/article/${articleId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        document.getElementById('renameItemId').value = articleId;
                        document.getElementById('renameItemType').value = 'article';
                        document.getElementById('newName').value = data.title || '';
                        renameModal.show();
                    } else {
                        alert('获取文章信息失败: ' + (data.message || '未知错误'));
                    }
                })
                .catch(error => {
                    console.error('获取文章信息失败:', error);
                    alert('获取文章信息失败，请稍后重试');
                });
        };
        
        window.deleteModule = function(moduleId) {
            const module = findModuleById(moduleId);
            if (module) {
                document.getElementById('deleteItemId').value = moduleId;
                document.getElementById('deleteItemType').value = 'module';
                document.getElementById('deleteConfirmMessage').textContent = `确定要删除模块"${module.name}"吗？此操作将删除该模块及其包含的所有子模块和文章，且不可撤销。`;
                deleteConfirmModal.show();
            }
        };
        
        window.deleteArticle = function(articleId) {
            // 添加日志帮助调试
            console.log(`准备显示删除确认对话框: ${articleId}`);
            
            // 找到对应的文章
            fetch(`/api/knowledge/article/${articleId}`)
                .then(response => {
                    console.log(`获取文章信息响应状态: ${response.status}`);
                    if (!response.ok) {
                        throw new Error(`服务器响应错误: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('获取文章信息响应数据:', data);
                    if (data.success) {
                        document.getElementById('deleteItemId').value = articleId;
                        document.getElementById('deleteItemType').value = 'article';
                        document.getElementById('deleteConfirmMessage').textContent = `确定要删除文章"${data.title || '未命名'}"吗？此操作不可撤销。`;
                        deleteConfirmModal.show();
                    } else {
                        alert('获取文章信息失败: ' + (data.message || '未知错误'));
                    }
                })
                .catch(error => {
                    console.error('获取文章信息失败:', error);
                    alert('获取文章信息失败，请稍后重试。错误: ' + error.message);
                });
        };
        
        // 确认创建模块
        document.getElementById('confirmCreateModule').addEventListener('click', function() {
            const name = document.getElementById('moduleName').value.trim();
            const parentId = document.getElementById('parentModule').value;
            const description = document.getElementById('moduleDesc').value.trim();
            
            if (!name) {
                alert('请输入模块名称');
                return;
            }
            
            // 发送创建模块请求
            fetch('/api/knowledge/module', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    name: name,
                    parent_id: parentId || null,
                    description: description
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    createModuleModal.hide();
                    // 重置表单
                    document.getElementById('createModuleForm').reset();
                    // 重新加载模块列表
                    loadModules();
                    // 隐藏欢迎页
                    welcomeContainer.style.display = 'none';
                } else {
                    alert('创建模块失败: ' + data.message);
                }
            })
            .catch(error => {
                console.error('创建模块失败:', error);
                alert('创建模块失败，请稍后重试');
            });
        });
        
        // 确认创建文章
        document.getElementById('confirmCreateArticle').addEventListener('click', function() {
            const title = document.getElementById('articleTitleInput').value.trim();
            const moduleId = document.getElementById('moduleId').value;
            
            if (!title) {
                alert('请输入文章标题');
                return;
            }
            
            if (!moduleId) {
                alert('请选择所属模块');
                return;
            }
            
            // 发送创建文章请求
            fetch('/api/knowledge/article', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    title: title,
                    module_id: moduleId,
                    content: ''
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    createArticleModal.hide();
                    // 重置表单
                    document.getElementById('createArticleForm').reset();
                    // 重新加载模块列表
                    loadModules();
                    // 加载新创建的文章
                    setTimeout(() => {
                        loadArticle(data.article_id);
                    }, 500);
                } else {
                    alert('创建文章失败: ' + data.message);
                }
            })
            .catch(error => {
                console.error('创建文章失败:', error);
                alert('创建文章失败，请稍后重试');
            });
        });
        
        // 搜索功能
        const searchInput = document.getElementById('searchKnowledge');
        const searchBtn = document.getElementById('searchBtn');
        
        // 搜索按钮点击触发搜索
        searchBtn.addEventListener('click', function() {
            searchArticles();
        });
        
        // 回车键触发搜索
        searchInput.addEventListener('keyup', function(event) {
            if (event.key === 'Enter') {
                searchArticles();
            }
        });
    }
    
    // 重命名模块
    function renameModuleById(moduleId, newName) {
        fetch(`/api/knowledge/module/${moduleId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                name: newName
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                renameModal.hide();
                // 重新加载模块列表
                loadModules();
                // 显示成功提示
                showAlert('success', '模块重命名成功');
            } else {
                alert('重命名失败: ' + data.message);
            }
        })
        .catch(error => {
            console.error('重命名模块失败:', error);
            alert('重命名失败，请稍后重试');
        });
    }
    
    // 重命名文章
    function renameArticleById(articleId, newName) {
        console.log(`准备重命名文章: ${articleId} 为 ${newName}`);
        
        fetch(`/api/knowledge/article/${articleId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                title: newName
            })
        })
        .then(response => {
            console.log(`重命名文章响应状态: ${response.status}`);
            if (!response.ok) {
                throw new Error(`服务器响应错误: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('重命名文章响应数据:', data);
            if (data.success) {
                renameModal.hide();
                
                // 如果当前打开的文章是正在重命名的文章，更新标题
                if (currentArticle && currentArticle.id === articleId) {
                    currentArticle.title = newName;
                    articleTitle.textContent = newName;
                }
                
                // 立即更新模块树中对应文章的标题
                updateArticleTitleInTree(articleId, newName);
                
                // 重新加载模块列表以确保所有地方都更新
                loadModules();
                
                // 显示成功提示
                showAlert('success', '文章重命名成功');
            } else {
                alert('重命名失败: ' + (data.message || '未知错误'));
            }
        })
        .catch(error => {
            console.error('重命名文章失败:', error);
            alert('重命名失败，请稍后重试。错误: ' + error.message);
        });
    }

    // 添加一个函数用于立即更新文章树中的标题
    function updateArticleTitleInTree(articleId, newTitle) {
        // 查找DOM中的文章项并更新标题
        const articleItem = document.querySelector(`.kb-article-item[data-id="${articleId}"]`);
        if (articleItem) {
            const titleElement = articleItem.querySelector('.kb-article-title');
            if (titleElement) {
                titleElement.textContent = newTitle;
            }
        }
    }
    
    // 删除模块
    function deleteModuleById(moduleId) {
        fetch(`/api/knowledge/module/${moduleId}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                deleteConfirmModal.hide();
                
                // 重新加载模块列表
                loadModules();
                
                // 显示成功提示
                showAlert('success', '模块删除成功');
                
                // 如果没有模块了，显示欢迎页
                if (currentModules.length === 1 && currentModules[0].id === moduleId) {
                    showWelcomePage();
                }
            } else {
                alert('删除失败: ' + data.message);
            }
        })
        .catch(error => {
            console.error('删除模块失败:', error);
            alert('删除失败，请稍后重试');
        });
    }
    
    // 删除文章
    function deleteArticleById(articleId) {
        // 添加日志帮助调试
        console.log(`准备删除文章: ${articleId}`);
        
        fetch(`/api/knowledge/article/${articleId}`, {
            method: 'DELETE'
        })
        .then(response => {
            console.log(`删除文章响应状态: ${response.status}`);
            if (!response.ok) {
                throw new Error(`服务器响应错误: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('删除文章响应数据:', data);
            if (data.success) {
                deleteConfirmModal.hide();
                
                // 如果当前打开的文章是正在删除的文章，清空编辑器
                if (currentArticle && currentArticle.id === articleId) {
                    currentArticle = null;
                    showWelcomePage();
                }
                
                // 重新加载模块列表
                loadModules();
                
                // 显示成功提示
                showAlert('success', '文章删除成功');
            } else {
                alert('删除失败: ' + (data.message || '未知错误'));
            }
        })
        .catch(error => {
            console.error('删除文章失败:', error);
            alert('删除失败，请稍后重试。错误: ' + error.message);
        });
    }
    
    // 工具函数：根据ID查找模块
    function findModuleById(id, modulesList) {
        modulesList = modulesList || currentModules;
        
        for (let i = 0; i < modulesList.length; i++) {
            const module = modulesList[i];
            if (module.id === id) {
                return module;
            }
            
            if (module.children && module.children.length > 0) {
                const found = findModuleById(id, module.children);
                if (found) {
                    return found;
                }
            }
        }
        
        return null;
    }
    
    // 添加搜索文章函数
    function searchArticles() {
        const keyword = document.getElementById('searchKnowledge').value.trim();
        if (!keyword) {
            // 如果搜索框为空，显示所有模块
            loadModules();
            return;
        }
        
        // 显示加载状态
        moduleTree.innerHTML = '<div class="kb-loading"><i class="fas fa-circle-notch fa-spin"></i> 正在搜索...</div>';
        
        // 发送搜索请求
        fetch('/api/knowledge/search', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                keyword: keyword
            })
        })
        .then(response => {
            console.log(`搜索响应状态: ${response.status}`);
            if (!response.ok) {
                throw new Error(`服务器响应错误: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('搜索响应数据:', data);
            
            // 检查响应是否成功
            if (data.success && data.articles && data.articles.length > 0) {
                // 显示搜索结果
                let html = `<div class="kb-search-results">
                    <div class="kb-search-header">
                        <h5>搜索结果: ${data.articles.length} 个匹配项</h5>
                        <button class="btn btn-sm btn-outline-secondary" onclick="loadModules()">
                            <i class="fas fa-times"></i> 清除搜索
                        </button>
                    </div>`;
                
                data.articles.forEach(article => {
                    // 构建文章预览，确保安全处理可能缺失的字段
                    const moduleText = article.module || '未分类';
                    const dateText = formatDate(article.updated_at || article.created_at);
                    const summary = article.summary || '';
                    
                    html += `
                    <div class="kb-article-item" data-id="${article.id}">
                        <div class="kb-article-icon">
                            <i class="fas fa-file-alt"></i>
                        </div>
                        <div class="kb-article-info">
                            <div class="kb-article-title">${article.title || '无标题'}</div>
                            <div class="kb-article-meta">
                                <small>${moduleText} · ${dateText}</small>
                            </div>
                            ${summary ? `<div class="kb-article-summary">${summary}</div>` : ''}
                        </div>
                    </div>`;
                });
                
                html += '</div>';
                moduleTree.innerHTML = html;
                
                // 绑定文章点击事件
                document.querySelectorAll('.kb-article-item').forEach(el => {
                    el.addEventListener('click', function() {
                        const articleId = this.getAttribute('data-id');
                        if (!articleId) return;
                        
                        loadArticle(articleId);
                        
                        // 更新选中状态
                        document.querySelectorAll('.kb-article-item.active').forEach(item => item.classList.remove('active'));
                        this.classList.add('active');
                    });
                });
            } else {
                // 没有搜索结果
                moduleTree.innerHTML = `<div class="kb-empty">
                    <i class="fas fa-search"></i>
                    <h4>未找到匹配的文章</h4>
                    <p>尝试使用其他关键词，或者 <a href="#" onclick="loadModules(); return false;">返回模块列表</a></p>
                </div>`;
            }
        })
        .catch(error => {
            console.error('搜索失败:', error);
            moduleTree.innerHTML = `<div class="kb-empty">
                <i class="fas fa-exclamation-circle"></i>
                <h4>搜索失败</h4>
                <p>错误信息: ${error.message}</p>
                <button class="btn btn-outline-primary mt-3" onclick="searchArticles()">
                    <i class="fas fa-sync-alt"></i> 重试
                </button>
                <button class="btn btn-outline-secondary mt-3 ml-2" onclick="loadModules()">
                    <i class="fas fa-arrow-left"></i> 返回模块列表
                </button>
            </div>`;
        });
    }
    
    // 初始化应用
    function init() {
        loadModules();
        initEvents();
        setupModalEvents();
        
        // 全局保存功能
        window.saveArticle = saveCurrentArticle;
    }
    
    // 启动应用
    init();
    
    // 添加文章结构切换功能
    const outlineToggle = document.getElementById('outlineToggle');
    const editorOutline = document.getElementById('editorOutline');
    
    if (outlineToggle && editorOutline) {
        outlineToggle.addEventListener('click', function() {
            editorOutline.classList.toggle('collapsed');
            outlineToggle.classList.toggle('collapsed');
            
            // 更新按钮图标
            const icon = outlineToggle.querySelector('i');
            if (icon) {
                icon.className = editorOutline.classList.contains('collapsed') ? 
                    'fas fa-list' : 'fas fa-times';
            }
        });
    }
    
    // 修改编辑器初始化函数
    function initEditor() {
        if (editor) return editor;
        
        editor = KnowledgePro.init('editor', {
            height: '500px',
            placeholder: '开始写作您的文档...',
            callbacks: {
                onInit: function(api) {
                    console.log('编辑器初始化完成');
                    // 确保编辑器初始化后文章结构是收起的
                    const editorOutline = document.getElementById('editorOutline');
                    const outlineToggle = document.getElementById('outlineToggle');
                    if (editorOutline && outlineToggle) {
                        editorOutline.classList.add('collapsed');
                        outlineToggle.classList.add('collapsed');
                        const icon = outlineToggle.querySelector('i');
                        if (icon) {
                            icon.className = 'fas fa-list';
                        }
                    }
                },
                onChange: function(content) {
                    // 内容变化时更新文章结构
                    setTimeout(updateArticleOutline, 300);
                },
                onSave: function(content) {
                    saveCurrentArticle(content);
                }
            }
        });
        
        return editor;
    }
    
    // 修改文章结构更新函数
    window.updateArticleOutline = function() {
        const outlineList = document.getElementById('outlineList');
        if (!outlineList || !window.editor) return;
        
        const content = window.editor.getContent();
        
        // 创建临时容器解析HTML
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = content;
        
        // 查找所有标题元素
        const headings = tempDiv.querySelectorAll('h1, h2, h3, h4, h5, h6');
        
        if (headings.length === 0) {
            outlineList.innerHTML = '<li class="text-muted">暂无标题结构</li>';
            return;
        }
        
        // 生成大纲
        let outlineHtml = '';
        
        headings.forEach((heading, index) => {
            // 为每个标题元素添加ID，如果没有的话
            if (!heading.id) {
                heading.id = `heading-${index}`;
            }
            
            const level = heading.tagName.toLowerCase();
            const text = heading.textContent.trim();
            
            // 创建大纲项
            outlineHtml += `
                <li class="kb-outline-item kb-outline-${level}" data-id="${heading.id}">
                    ${text}
                </li>
            `;
        });
        
        outlineList.innerHTML = outlineHtml;
        
        // 为大纲项添加点击事件
        document.querySelectorAll('.kb-outline-item').forEach(item => {
            item.addEventListener('click', function() {
                const headingId = this.getAttribute('data-id');
                scrollToHeading(headingId);
            });
        });
    };
    
    // 滚动到指定标题
    function scrollToHeading(headingId) {
        if (!headingId || !window.editor) return;
        
        const editorContent = document.querySelector('.knowledge-editor-content');
        if (!editorContent) return;
        
        // 查找编辑器内容中的标题
        const heading = editorContent.querySelector(`#${headingId}`);
        if (heading) {
            heading.scrollIntoView({behavior: 'smooth', block: 'center'});
        }
    }
    
    // 监听编辑器初始化完成事件
    const originalInitEditor = window.initEditor;
    if (typeof originalInitEditor === 'function') {
        window.initEditor = function() {
            const editor = originalInitEditor();
            
            // 在编辑器初始化完成后，更新文章结构
            if (editor) {
                setTimeout(function() {
                    updateArticleOutline();
                }, 500);
            }
            
            return editor;
        };
    }
});
</script>

<!-- 知识库可调整大小编辑器和文章结构功能 -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // 初始化可调整大小的编辑器
    const contentMain = document.getElementById('contentMain');
    
    // 如果找到内容区，添加调整大小的手柄
    if (contentMain) {
        contentMain.style.resize = 'both';
        contentMain.style.overflow = 'auto';
        contentMain.style.minHeight = 'calc(100vh - 250px)';
        contentMain.style.minWidth = '90%';
        contentMain.style.maxWidth = '100%';
        contentMain.style.width = '100%';
        contentMain.style.height = 'calc(100vh - 250px)';
        
        // 确保编辑器内容区域也能跟随调整
        const editorElement = document.getElementById('editor');
        if (editorElement) {
            editorElement.style.width = '100%';
            editorElement.style.height = '100%';
            editorElement.style.position = 'relative';
            editorElement.style.overflow = 'auto';
        }
        
        // 监听editorElement的内容变化
        const observer = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutation) {
                const editorContainer = document.querySelector('.knowledge-pro-editor');
                if (editorContainer) {
                    editorContainer.style.width = '100%';
                    editorContainer.style.height = '100%';
                    
                    const editorContent = editorContainer.querySelector('.knowledge-editor-content');
                    if (editorContent) {
                        editorContent.style.width = '100%';
                        editorContent.style.height = 'calc(100% - 40px)';
                        editorContent.style.overflow = 'auto';
                    }
                }
            });
        });
        
        if (editorElement) {
            observer.observe(editorElement, { 
                childList: true, 
                subtree: true,
                attributes: true,
                characterData: true
            });
        }
    }
    
    // 添加CSS样式
    function addStyles() {
        const style = document.createElement('style');
        style.textContent = `
            /* 确保内容区域清除浮动 */
            .kb-content-area::after {
                content: "";
                display: table;
                clear: both;
            }
            
            /* 可调整大小的编辑器容器 */
            .kb-content-main {
                position: relative;
                min-height: 300px;
                min-width: 75%;
                resize: both; /* 支持双向调整 */
                overflow: auto;
                border: 1px solid #dee2e6;
                border-radius: 4px;
                float: left;
                width: calc(90% - 15px);
                margin-right: 15px;
                padding-bottom: 15px; /* 为调整手柄留出空间 */
                max-width: 95%; /* 更大的最大宽度 */
            }
            
            /* 确保编辑器填满容器 */
            .knowledge-pro-editor {
                width: 100% !important;
                height: 100% !important;
                display: flex;
                flex-direction: column;
            }
            
            /* 确保编辑内容区域填满可用空间 */
            .knowledge-editor-content {
                flex: 1;
                overflow: auto !important;
                width: 100% !important;
                height: calc(100% - 40px) !important; /* 减去工具栏高度 */
            }
            
            /* 大小调整手柄 */
            .kb-resize-handle {
                height: 15px;
                background-color: #f1f1f1;
                cursor: nwse-resize; /* 显示双向调整光标 */
                text-align: center;
                border-radius: 0 0 5px 5px;
                position: absolute;
                bottom: 0;
                left: 0;
                right: 0;
                z-index: 10;
            }
            
            .kb-resize-handle:hover {
                background-color: #e0e0e0;
            }
            
            .kb-resize-handle::after {
                content: "⋯";
                color: #999;
                display: inline-block;
                line-height: 15px;
            }
            
            /* 响应式布局 */
            @media (max-width: 768px) {
                .kb-content-main {
                    float: none;
                    width: 100%;
                    margin-right: 0;
                    max-width: 100%;
                }
            }
        `;
        document.head.appendChild(style);
    }
    
    // 添加样式
    addStyles();
});
</script>
{% endblock %}