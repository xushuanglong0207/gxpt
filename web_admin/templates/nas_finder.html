{% extends "base.html" %}

{% block title %}UGREEN NAS 设备查询{% endblock %}

{% block styles %}
<!-- 预加载关键资源 -->
<link rel="preload" href="{{ url_for('static', filename='js/jquery.min.js') }}" as="script" crossorigin="anonymous">
<link rel="preload" href="{{ url_for('static', filename='js/toastr.min.js') }}" as="script" crossorigin="anonymous">
<link rel="preload" href="{{ url_for('static', filename='js/bootstrap.bundle.min.js') }}" as="script" crossorigin="anonymous">
<link rel="preload" href="{{ url_for('static', filename='css/toastr.min.css') }}" as="style" crossorigin="anonymous">

<style>
    :root {
        --primary-color: #4361ee;
        --primary-hover: #3a56d4;
        --secondary-color: #3f37c9;
        --success-color: #4cc9f0;
        --accent-color: #4895ef;
        --light-bg: #f8f9fa;
        --card-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        --hover-shadow: 0 10px 25px rgba(0, 0, 0, 0.12);
        --transition-normal: all 0.3s ease;
        --border-radius: 0.5rem;
    }

    /* 全局增强 */
    .card {
        border: none;
        border-radius: var(--border-radius);
        box-shadow: var(--card-shadow);
        transition: var(--transition-normal);
        overflow: hidden;
    }
    
    .card:hover {
        box-shadow: var(--hover-shadow);
    }
    
    .card-header {
        border-bottom: 1px solid rgba(0,0,0,0.05);
        background-color: white;
    }
    
    .btn {
        border-radius: 0.4rem;
        transition: var(--transition-normal);
        font-weight: 500;
    }
    
    .btn-primary {
        background-color: var(--primary-color);
        border-color: var(--primary-color);
    }
    
    .btn-primary:hover {
        background-color: var(--primary-hover);
        border-color: var(--primary-hover);
        transform: translateY(-2px);
    }
    
    .btn-success {
        background-color: var(--success-color);
        border-color: var(--success-color);
    }
    
    .btn-success:hover {
        transform: translateY(-2px);
    }
    
    .form-control, .form-select {
        border-radius: 0.4rem;
        border: 1px solid rgba(0,0,0,0.1);
        padding: 0.6rem 1rem;
        transition: var(--transition-normal);
    }
    
    .form-control:focus, .form-select:focus {
        border-color: var(--accent-color);
        box-shadow: 0 0 0 0.2rem rgba(67, 97, 238, 0.15);
    }
    
    .input-group .btn {
        padding: 0.6rem 1.2rem;
    }
    
    .table {
        border-collapse: separate;
        border-spacing: 0;
    }
    
    .table thead th {
        border-bottom: 2px solid var(--accent-color);
        padding: 0.75rem 1rem;
        font-weight: 600;
        color: #444;
    }
    
    .table tbody tr {
        transition: var(--transition-normal);
    }
    
    .table tbody tr:hover {
        background-color: rgba(72, 149, 239, 0.05);
    }
    
    .table tbody td {
        padding: 0.75rem 1rem;
        vertical-align: middle;
        border-bottom: 1px solid rgba(0,0,0,0.05);
    }
    
    /* 特定组件增强 */
    .device-card {
        margin-bottom: 20px;
        transition: var(--transition-normal);
        border-radius: var(--border-radius);
    }
    
    .device-card:hover {
        transform: translateY(-5px);
        box-shadow: var(--hover-shadow);
    }
    
    .device-ip {
        color: var(--primary-color);
        cursor: pointer;
        font-weight: 500;
        transition: var(--transition-normal);
    }
    
    .device-ip:hover {
        color: var(--primary-hover);
        text-decoration: underline;
    }
    
    .device-group-title {
        margin-top: 30px;
        padding-bottom: 10px;
        border-bottom: 2px solid var(--primary-color);
        color: #333;
        font-weight: 600;
    }
    
    .auth-modal .modal-body {
        padding: 1.5rem;
    }
    
    .device-list-container {
        display: none;
    }
    
    .hidden {
        display: none;
    }
    
    #deviceSearchInput {
        margin-bottom: 20px;
    }
    
    .section-divider {
        height: 40px;
    }
    
    .device-meta {
        color: #6c757d;
        font-size: 0.85rem;
    }
    
    .device-credentials {
        background-color: var(--light-bg);
        padding: 12px;
        border-radius: 0.4rem;
        margin-top: 15px;
    }
    
    /* 左侧导航增强 */
    .list-group-item {
        border: none;
        padding: 0.8rem 1rem;
        transition: var(--transition-normal);
        margin-bottom: 2px;
        border-radius: 0.3rem !important;
    }
    
    .list-group-item:hover {
        background-color: rgba(67, 97, 238, 0.05);
        color: var(--primary-color);
    }
    
    .list-group-item.active {
        background-color: var(--primary-color);
        font-weight: 500;
    }
    
    .list-group-item.active:hover {
        background-color: var(--primary-hover);
    }
    
    .list-group-item-action:focus, .list-group-item-action:hover {
        transform: translateX(3px);
    }
    
    /* 导航药丸增强 */
    .nav-pills .nav-link {
        border-radius: 0.4rem;
        padding: 0.5rem 1rem;
        transition: var(--transition-normal);
        font-weight: 500;
    }
    
    .nav-pills .nav-link:not(.active) {
        color: #495057;
    }
    
    .nav-pills .nav-link:not(.active):hover {
        background-color: rgba(67, 97, 238, 0.05);
        color: var(--primary-color);
    }
    
    .nav-pills .nav-link.active {
        background-color: var(--primary-color);
    }
    
    /* 加载动画增强 */
    .spinner-border {
        width: 2.5rem;
        height: 2.5rem;
        border-width: 0.25rem;
        color: var(--primary-color);
    }
    
    /* 表格内链接按钮增强 */
    .btn-outline-primary {
        color: var(--primary-color);
        border-color: var(--primary-color);
    }
    
    .btn-outline-primary:hover {
        background-color: var(--primary-color);
        border-color: var(--primary-color);
        color: white;
    }
    
    .btn-outline-success {
        color: var(--success-color);
        border-color: var(--success-color);
    }
    
    .btn-outline-success:hover {
        background-color: var(--success-color);
        border-color: var(--success-color);
        color: white;
    }
    
    /* 问答验证区增强 */
    .input-group {
        border-radius: 0.4rem;
        overflow: hidden;
    }
    
    .border-bottom {
        border-bottom: 2px solid rgba(67, 97, 238, 0.2) !important;
    }
    
    /* 动态效果 */
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    .table-responsive {
        animation: fadeIn 0.4s ease-out;
    }
    
    /* 响应式优化 */
    @media (max-width: 768px) {
        .card-header {
            padding: 0.75rem;
        }
        
        .card-body {
            padding: 1rem;
        }
        
        .btn-sm {
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
        }
    }

    /* 模态框可访问性增强 */
    .modal {
        outline: none;
    }

    .modal.fade:not(.show) {
        display: none !important;
    }

    .modal.show {
        display: block !important;
    }

    .modal-dialog {
        outline: none;
    }

    .modal-content {
        outline: none;
    }

    .modal-footer .btn:focus {
        box-shadow: none;
    }

    /* 确保模态框按钮在关闭时失去焦点 */
    .modal.fade .modal-footer .btn {
        transition: all 0.15s ease-in-out;
    }

    .modal.fade:not(.show) .modal-footer .btn {
        pointer-events: none;
        opacity: 0;
    }

    /* 组标签样式 */
    .nav-tabs {
        border-bottom: 2px solid var(--primary-color);
    }

    .nav-tabs .nav-link {
        border: none;
        color: #333333; /* 更深的颜色 */
        font-weight: 500; /* 字体加粗 */
        padding: 0.6rem 1.2rem; /* 增大内边距 */
        margin-right: 0.5rem;
        border-radius: 0.4rem 0.4rem 0 0;
        transition: var(--transition-normal);
    }
    
    /* 确保所有标签内文字可见 */
    .nav-tabs .nav-link span {
        color: #333333; /* 确保文字颜色是深色 */
    }

    .nav-tabs .nav-link:hover {
        color: var(--primary-color);
        border: none;
        background-color: rgba(67, 97, 238, 0.15); /* 更明显的背景 */
        transform: translateY(-3px); /* 悬停时上移效果 */
    }
    
    .nav-tabs .nav-link:hover span {
        color: var(--primary-color); /* 悬停时文字颜色改变 */
    }

    .nav-tabs .nav-link.active {
        color: white; /* 白色文字 */
        background-color: var(--primary-color); /* 主题色背景 */
        border: none;
        font-weight: 600;
        box-shadow: 0 3px 10px rgba(67, 97, 238, 0.3); /* 添加阴影 */
    }
    
    /* 活动标签内的文字颜色为白色 */
    .nav-tabs .nav-link.active span {
        color: white;
    }

    /* 禁用状态样式 */
    .disabled-group {
        opacity: 1 !important; /* 使用!important确保不会被覆盖 */
        pointer-events: auto !important;
        cursor: auto !important;
        user-select: auto !important;
        -webkit-user-select: auto !important;
    }

    .disabled-group .btn,
    .disabled-group .table,
    .disabled-group * {
        opacity: 1 !important;
        pointer-events: auto !important;
        cursor: auto !important;
        user-select: auto !important;
        -webkit-user-select: auto !important;
    }
    
    /* 批量操作样式 */
    #script-tree ul {
        list-style: none;
        padding-left: 1.5rem;
    }
    
    #script-tree li {
        margin-bottom: 0.25rem;
        cursor: pointer;
    }
    
    #script-tree .script-item, #script-tree .dir-item {
        padding: 0.2rem 0.5rem;
        border-radius: 0.3rem;
        transition: var(--transition-normal);
    }
    
    #script-tree .script-item:hover, #script-tree .dir-item:hover {
        background-color: rgba(67, 97, 238, 0.05);
    }
    
    #script-tree .selected-script {
        background-color: rgba(67, 97, 238, 0.15);
        font-weight: bold;
    }
    
    #script-tree i {
        margin-right: 0.5rem;
        width: 1em;
    }
    
    #script-tree .delete-btn {
        margin-left: 0.5rem;
        color: #dc3545;
        opacity: 0.6;
        transition: opacity 0.2s;
    }
    
    #script-tree .delete-btn:hover {
        opacity: 1;
    }
    
    #device-grid .device-block {
        border: 1px solid #dee2e6;
        padding: 0.5rem 0.8rem;
        border-radius: 0.3rem;
        cursor: pointer;
        transition: var(--transition-normal);
        text-align: center;
        min-width: 120px;
        background-color: white;
    }
    
    #device-grid .device-block:hover {
        border-color: var(--accent-color);
        background-color: rgba(72, 149, 239, 0.05);
    }
    
    #device-grid .device-block.selected {
        background-color: var(--primary-color);
        color: white;
        border-color: var(--primary-color);
        font-weight: bold;
    }

    .device-block {
        border: 1px solid #ddd;
        border-radius: 5px;
        padding: 10px;
        margin: 5px;
        text-align: center;
        cursor: pointer;
        transition: all 0.2s ease;
        min-width: 120px;
        display: inline-block;
    }

    .device-block:hover {
        background-color: #f5f5f5;
        border-color: #aaa;
    }

    .device-block.selected {
        background-color: #e6f7ff;
        border-color: #1890ff;
    }

    .btn-delete-device {
        opacity: 0.2;
        padding: 0.1rem 0.3rem;
        line-height: 1;
        font-size: 0.7rem;
    }

    .device-block:hover .btn-delete-device {
        opacity: 1;
    }

    .selected-dir {
        background-color: #d1ecf1;
        border-color: #0dcaf0;
        border-radius: 4px;
    }

    .script-deploy-info {
        background-color: #f8f9fa;
        border-radius: 4px;
        padding: 10px;
        margin-top: 15px;
        border-left: 3px solid #0dcaf0;
    }

    .deployment-indicator {
        font-size: 14px;
        color: #666;
        border-bottom: 1px solid #eee;
        padding-bottom: 5px;
        margin-bottom: 10px;
    }

    .deployment-alert {
        background-color: rgba(255, 193, 7, 0.1);
        border-left: 3px solid #ffc107;
        padding: 10px;
        margin: 10px 0;
    }

    /* NAS管理器样式 */
    .nav-tabs .nav-link.active {
        font-weight: 500;
        border-bottom: 3px solid #007bff;
    }
    
    /* 设备卡片样式 */
    .device-card {
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        transition: all 0.2s ease;
        cursor: pointer;
    }
    
    .device-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    .device-card.selected {
        border-color: #28a745;
        background-color: #f8fff8;
    }
    
    /* 脚本和目录项样式 */
    .script-item, .dir-item {
        padding: 8px 12px;
        border-radius: 4px;
        margin-bottom: 4px;
        cursor: pointer;
    }
    
    .script-item:hover, .dir-item:hover {
        background-color: #f5f5f5;
    }
    
    .dir-item {
        color: #007bff;
    }
    
    .script-item.selected-script {
        background-color: #e9f5ff !important;
        border-left: 3px solid #007bff !important;
        font-weight: bold;
    }
    
    .selected-dir {
        background-color: #e9fff5;
        border-left: 3px solid #28a745;
    }
    
    /* 状态指示器 */
    .status-indicator {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        display: inline-block;
        margin-right: 5px;
    }
    
    .status-online {
        background-color: #28a745;
    }
    
    .status-offline {
        background-color: #dc3545;
    }
    
    /* 统一无样式列表 */
    ul.ps-0 {
        list-style-type: none;
    }
    
    /* 设备IP链接样式 */
    .device-ip {
        color: #007bff;
        text-decoration: none;
    }
    
    .device-ip:hover {
        text-decoration: underline;
    }
    
    /* 部署信息样式 */
    .deployment-indicator {
        background-color: #f8f9fa;
        padding: 10px;
        border-radius: 4px;
        margin-bottom: 10px;
        border-left: 3px solid #007bff;
    }
    
    /* 操作按钮白色文字 */
    .btn-success, .btn-primary, .btn-danger {
        color: white !important;
    }
    
    /* 添加圆角阴影卡片 */
    .card {
        border-radius: 8px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }
    
    /* 设备选中状态样式 */
    .device-block {
        border: 1px solid #ddd;
        padding: 10px;
        border-radius: 8px;
        margin-bottom: 12px;
        cursor: pointer;
        transition: all 0.2s ease;
        position: relative;
    }
    
    .device-block:hover {
        background-color: #f8f9fa;
        border-color: #c8c9ca;
    }
    
    .device-block.selected {
        background-color: #e8f4ff;
        border-color: #4a89dc;
        box-shadow: 0 0 0 1px #4a89dc;
    }
    
    /* 设备操作按钮样式 */
    .device-actions {
        position: absolute;
        right: 10px;
        top: 10px;
        visibility: hidden;
        opacity: 0;
        transition: opacity 0.2s ease;
    }
    
    .device-block:hover .device-actions {
        visibility: visible;
        opacity: 1;
    }
    
    /* 确保按钮点击后不会影响设备的选择状态 */
    .device-actions .btn {
        z-index: 10;
    }
    
    /* 运行脚本按钮高亮样式 */
    #runScriptBtn {
        background-color: #ff9800;
        border-color: #e88e00;
        color: white;
        font-weight: bold;
    }
    
    #runScriptBtn:hover {
        background-color: #e88e00;
        border-color: #d67d00;
    }
    
    /* 防止按钮点击事件冒泡到父元素 */
    .btn-outline-info, .btn-danger {
        position: relative;
    }
</style>
<!-- 使用本地Toastr样式 -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/toastr.min.css') }}" 
      onerror="this.onerror=null;this.href='https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css';">
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <!-- 左侧功能导航 -->
        <div class="col-md-2">
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-primary text-white">
                    <i class="fas fa-th-large me-2"></i>功能导航
                </div>
                <div class="list-group list-group-flush" id="functionNav">
                    <a href="#deviceSearch" class="list-group-item list-group-item-action active" data-bs-toggle="list">
                        <i class="fas fa-search me-2"></i>设备查询
                    </a>
                    <a href="#commonDevices" class="list-group-item list-group-item-action" data-bs-toggle="list">
                        <i class="fas fa-star me-2"></i>常用设备
                    </a>
                    <a href="#batchOperation" class="list-group-item list-group-item-action" data-bs-toggle="list">
                        <i class="fas fa-tasks me-2"></i>批量操作
                    </a>
                    <a href="#deviceMonitor" class="list-group-item list-group-item-action" data-bs-toggle="list">
                        <i class="fas fa-desktop me-2"></i>设备监控
                    </a>
                    <a href="#dataAnalysis" class="list-group-item list-group-item-action" data-bs-toggle="list">
                        <i class="fas fa-chart-bar me-2"></i>数据分析
                    </a>
                </div>
            </div>
        </div>

        <!-- 主要内容区 -->
        <div class="col-md-10">
            <div class="tab-content">
                <!-- 设备查询面板 -->
                <div class="tab-pane fade show active" id="deviceSearch">
                    <!-- 设备查询卡片 -->
                    <div class="card shadow mb-4">
                        <div class="card-header bg-white">
                            <ul class="nav nav-pills card-header-pills">
                                <li class="nav-item">
                                    <a class="nav-link active" href="#quick-search" data-bs-toggle="tab" onclick="clearSearchForm()">
                                        <i class="fas fa-search me-2"></i>普通查询
                                    </a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" href="#pointer-search" data-bs-toggle="tab" onclick="clearSearchForm()">
                                        <i class="fas fa-crosshairs me-2"></i>指针查询
                                    </a>
                                </li>
                            </ul>
                        </div>
                        <div class="card-body">
                            <div class="tab-content">
                                <!-- 普通查询面板 -->
                                <div class="tab-pane fade show active" id="quick-search">
                                    <div class="input-group mb-3">
                                        <input type="text" id="searchKeyword" class="form-control" 
                                               placeholder="请输入设备名称、设备SN后四位或型号...">
                                        <button class="btn btn-primary" type="button" onclick="searchDevices()">
                                            <i class="fas fa-search me-1"></i>搜索
                                        </button>
                                    </div>
                                    <small class="text-muted">提示：可以输入设备名称、设备SN后四位或型号进行搜索</small>
                                </div>

                                <!-- 指针查询面板 -->
                                <div class="tab-pane fade" id="pointer-search">
                                    <form id="pointerSearchForm">
                                        <div class="mb-3">
                                            <label class="form-label">网段列表 <span class="text-danger">*</span></label>
                                            <input type="text" id="networkSegments" class="form-control" 
                                                   placeholder="请输入网段，多个网段用空格分隔（如：172.17.20 172.17.80）" required>
                                            <small class="text-muted">必填，支持输入多个网段，用空格分隔</small>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">设备名称</label>
                                            <input type="text" id="deviceName" class="form-control" 
                                                   placeholder="请输入设备名称（支持模糊匹配）">
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">设备型号</label>
                                            <input type="text" id="deviceModel" class="form-control" 
                                                   placeholder="请输入设备型号（支持模糊匹配）">
                                        </div>
                                        <button type="button" class="btn btn-primary" onclick="startPointerSearch()">
                                            <i class="fas fa-search me-1"></i>开始查询
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 搜索结果区域 -->
                    <div id="searchResults" class="mb-4"></div>

                    <!-- 加载动画 -->
                    <div id="loadingSpinner" class="text-center d-none mb-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">搜索中...</span>
                        </div>
                        <p class="mt-2">正在搜索设备，请稍候...</p>
                    </div>
                </div>

                <!-- 常用设备面板 -->
                <div class="tab-pane fade" id="commonDevices">
                    <div class="card shadow">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0 fw-bold">常用设备列表</h5>
                            {% if is_admin %}
                            <div>
                                <button class="btn btn-success btn-sm me-2" data-bs-toggle="modal" data-bs-target="#addGroupModal">
                                    <i class="fas fa-plus me-1"></i>新增组
                                </button>
                                <button class="btn btn-info btn-sm me-2" data-bs-toggle="modal" data-bs-target="#setGroupNameModal">
                                    <i class="fas fa-tags me-1"></i>设置组名称
                                </button>
                                <button class="btn btn-primary btn-sm me-2" data-bs-toggle="modal" data-bs-target="#setQuestionModal">
                                    <i class="fas fa-question-circle me-1"></i>设置问题
                                </button>
                                <button class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#addDeviceModal">
                                    <i class="fas fa-plus me-1"></i>添加设备
                                </button>
                            </div>
                            {% endif %}
                        </div>
                        <div class="card-body">
                            <!-- 组导航标签 -->
                            <ul class="nav nav-tabs mb-4" id="groupTabs" role="tablist">
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link active" id="storage-tab" data-bs-toggle="tab" data-bs-target="#storage-content" type="button" role="tab">
                                        <span id="storage-group-name">{{ storage_name }}</span>
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="performance-tab" data-bs-toggle="tab" data-bs-target="#performance-content" type="button" role="tab">
                                        <span id="performance-group-name">{{ performance_name }}</span>
                                    </button>
                                </li>
                            </ul>
                            
                            <!-- 组内容区域 -->
                            <div class="tab-content" id="groupTabContent">
                                <!-- 存储组内容 -->
                                <div class="tab-pane fade show active" id="storage-content" role="tabpanel">
                                    <div class="d-flex justify-content-between mb-3">
                                        {% if is_admin %}
                                        <button class="btn btn-outline-danger btn-sm" onclick="deleteSystemGroup('storage', '存储组')">
                                            <i class="fas fa-trash me-1"></i>删除此组设备
                                        </button>
                                        {% else %}
                                        <div></div>
                                        {% endif %}
                                    <button class="btn btn-outline-primary btn-sm" onclick="refreshDevices('storage')">
                                        <i class="fas fa-sync-alt me-1"></i>刷新列表
                                    </button>
                                </div>
                                <div id="storage-devices">
                                    {% if not is_admin %}
                                    <div class="text-center py-3" id="storage-auth-form">
                                        <p>请回答问题以查看设备列表：</p>
                                        <p id="storage-question" class="fw-bold text-primary">{{ storage_question }}</p>
                                        <div class="input-group mb-3" style="max-width: 300px; margin: 0 auto;">
                                            <input type="text" class="form-control" id="storage-answer" placeholder="请输入答案">
                                            <button class="btn btn-primary" onclick="verifyAnswer('storage')">确认</button>
                                        </div>
                                    </div>
                                    {% endif %}
                                    <div id="storage-devices-content" {% if not is_admin %}style="display: none;"{% endif %}>
                                        <div class="table-responsive">
                                            <table class="table table-hover">
                                                <thead>
                                                    <tr>
                                                        <th>设备品牌</th>
                                                        <th>设备型号</th>
                                                        <th>IP地址</th>
                                                        <th>账号</th>
                                                        <th>密码</th>
                                                        {% if is_admin %}<th>操作</th>{% endif %}
                                                    </tr>
                                                </thead>
                                                <tbody id="storage-devices-list"></tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                                
                                <!-- 性能组内容 -->
                                <div class="tab-pane fade" id="performance-content" role="tabpanel">
                                    <div class="d-flex justify-content-between mb-3">
                                        {% if is_admin %}
                                        <button class="btn btn-outline-danger btn-sm" onclick="deleteSystemGroup('performance', '性能组')">
                                            <i class="fas fa-trash me-1"></i>删除此组设备
                                        </button>
                                        {% else %}
                                        <div></div>
                                        {% endif %}
                                    <button class="btn btn-outline-primary btn-sm" onclick="refreshDevices('performance')">
                                        <i class="fas fa-sync-alt me-1"></i>刷新列表
                                    </button>
                                </div>
                                <div id="performance-devices">
                                    {% if not is_admin %}
                                    <div class="text-center py-3" id="performance-auth-form">
                                        <p>请回答问题以查看设备列表：</p>
                                        <p id="performance-question" class="fw-bold text-primary">{{ performance_question }}</p>
                                        <div class="input-group mb-3" style="max-width: 300px; margin: 0 auto;">
                                            <input type="text" class="form-control" id="performance-answer" placeholder="请输入答案">
                                            <button class="btn btn-primary" onclick="verifyAnswer('performance')">确认</button>
                                        </div>
                                    </div>
                                    {% endif %}
                                    <div id="performance-devices-content" {% if not is_admin %}style="display: none;"{% endif %}>
                                        <div class="table-responsive">
                                            <table class="table table-hover">
                                                <thead>
                                                    <tr>
                                                        <th>设备品牌</th>
                                                        <th>设备型号</th>
                                                        <th>IP地址</th>
                                                        <th>账号</th>
                                                        <th>密码</th>
                                                        {% if is_admin %}<th>操作</th>{% endif %}
                                                    </tr>
                                                </thead>
                                                <tbody id="performance-devices-list"></tbody>
                                            </table>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 批量操作标签页 -->
                <div class="tab-pane fade" id="batchOperation" role="tabpanel">
                    <div class="alert alert-warning alert-dismissible fade show" id="batch-security-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>安全警告:</strong> SSH连接涉及敏感凭据，脚本执行可能对设备造成不可逆影响，请谨慎操作。
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card mb-3">
                                <div class="card-header bg-light">
                                    <strong><i class="fas fa-folder me-2"></i>脚本目录管理</strong>
                                </div>
                        <div class="card-body">
                                    <div id="script-tree" class="script-tree">
                                        <div class="text-center p-3">
                                            <i class="fas fa-spinner fa-spin me-2"></i>加载中...
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="card mb-3">
                                <div class="card-header bg-light">
                                    <strong><i class="fas fa-server me-2"></i>设备管理</strong>
                                    <button class="btn btn-sm btn-outline-primary float-end" onclick="showAddDeviceModal()">
                                        <i class="fas fa-plus me-1"></i>添加设备
                                    </button>
                                </div>
                                <div class="card-body">
                                    <div id="device-grid" class="device-grid">
                                        <div class="text-center">
                                            <i class="fas fa-spinner fa-spin me-2"></i>加载中...
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header bg-light">
                                    <strong><i class="fas fa-tools me-2"></i>批量操作</strong>
                                </div>
                                <div class="card-body">
                                    <!-- 脚本部署区域 -->
                                    <div id="script-deploy-section">
                                        <div class="deployment-controls">
                                            <button id="deployScriptBtn" class="btn btn-success mb-3 me-2" onclick="deploySelectedScriptToDevices()" disabled>
                                                <i class="fas fa-upload me-1"></i> 部署脚本到设备
                                            </button>
                                            <button id="runScriptBtn" class="btn btn-warning mb-3" onclick="showRunScriptModal()" disabled>
                                                <i class="fas fa-play me-1"></i> 批量运行脚本
                                            </button>
                                            <div class="mb-3 text-muted small">
                                                在左侧脚本树中单击选择一个脚本文件，然后在下方设备列表中选择目标设备，最后点击上方按钮执行对应操作。
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- 目录部署区域，默认隐藏 -->
                                    <div id="directory-deploy-section" style="display:none;">
                                        <div class="deployment-controls">
                                            <button id="deployDirectoryBtn" class="btn btn-primary mb-3" onclick="deployDirectoryToDevices()" disabled>
                                                <i class="fas fa-upload me-1"></i> 部署目录到设备
                                            </button>
                                            <div class="mb-3 text-muted small">
                                                已选择目录进行部署，请在下方设备列表中选择目标设备，然后点击上方部署按钮。
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div id="batch-action-status" class="mt-3">
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle me-2"></i>
                                            请先选择要部署的脚本或目录以及目标设备。
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 设备监控面板 -->
                <div class="tab-pane fade" id="deviceMonitor">
                    <div class="card shadow">
                        <div class="card-body">
                            <h5 class="card-title mb-4 fw-bold">设备监控</h5>
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle me-2"></i>
                                该功能正在开发中，敬请期待...
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 数据分析面板 -->
                <div class="tab-pane fade" id="dataAnalysis">
                    <div class="card shadow">
                        <div class="card-body">
                            <h5 class="card-title mb-4 fw-bold">数据分析</h5>
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle me-2"></i>
                                该功能正在开发中，敬请期待...
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 添加设备模态框 -->
<div class="modal fade" id="addDeviceModal" tabindex="-1" aria-labelledby="addDeviceModalLabel">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addDeviceModalLabel">添加设备</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addDeviceForm">
                    <div class="mb-3">
                        <label class="form-label">设备类型</label>
                        <select class="form-select" name="type">
                            <option value="storage">存储组</option>
                            <option value="performance">性能组</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">设备品牌</label>
                        <input type="text" class="form-control" name="brand" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">设备型号</label>
                        <input type="text" class="form-control" name="model" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">IP地址</label>
                        <input type="text" class="form-control" name="ip" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">账号</label>
                        <input type="text" class="form-control" name="username" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">密码</label>
                        <input type="password" class="form-control" name="password" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="submitAddDevice()">确认添加</button>
            </div>
        </div>
    </div>
</div>

<!-- 设置问题模态框 -->
<div class="modal fade" id="setQuestionModal" tabindex="-1" aria-labelledby="setQuestionModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="setQuestionModalLabel">设置访问问题</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="setQuestionForm">
                    <div class="mb-4">
                        <h6 class="fw-bold">存储组设置</h6>
                        <div class="mb-3">
                            <label class="form-label">组名称</label>
                            <input type="text" class="form-control" id="storageName" placeholder="例如：存储组" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">问题</label>
                            <input type="text" class="form-control" id="storageQuestion" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">答案</label>
                            <input type="text" class="form-control" id="storageAnswer" required>
                        </div>
                    </div>
                    <div class="mb-3">
                        <h6 class="fw-bold">性能组设置</h6>
                        <div class="mb-3">
                            <label class="form-label">组名称</label>
                            <input type="text" class="form-control" id="performanceName" placeholder="例如：性能专项组" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">问题</label>
                            <input type="text" class="form-control" id="performanceQuestion" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">答案</label>
                            <input type="text" class="form-control" id="performanceAnswer" required>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="submitSetQuestion()">确认设置</button>
            </div>
        </div>
    </div>
</div>

<!-- 编辑设备模态框 -->
<div class="modal fade" id="editDeviceModal" tabindex="-1" aria-labelledby="editDeviceModalLabel">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editDeviceModalLabel">编辑设备</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editDeviceForm">
                    <input type="hidden" id="editDeviceId">
                    <input type="hidden" id="editDeviceType">
                    <div class="mb-3">
                        <label class="form-label">设备品牌</label>
                        <input type="text" class="form-control" id="editDeviceBrand" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">设备型号</label>
                        <input type="text" class="form-control" id="editDeviceModel" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">IP地址</label>
                        <input type="text" class="form-control" id="editDeviceIP" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">账号</label>
                        <input type="text" class="form-control" id="editDeviceUsername" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">密码</label>
                        <input type="password" class="form-control" id="editDevicePassword" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="submitEditDevice()">保存修改</button>
            </div>
        </div>
    </div>
</div>

<!-- 设置组名称模态框 -->
<div class="modal fade" id="setGroupNameModal" tabindex="-1" aria-labelledby="setGroupNameModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="setGroupNameModalLabel">设置组名称</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="setGroupNameForm">
                    <div class="mb-3">
                        <label class="form-label">存储组名称</label>
                        <input type="text" class="form-control" id="groupNameStorage" placeholder="例如：存储组" required>
                        <small class="text-muted">设置后将替换"存储组"显示名称</small>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">性能组名称</label>
                        <input type="text" class="form-control" id="groupNamePerformance" placeholder="例如：性能专项组" required>
                        <small class="text-muted">设置后将替换"性能专项组"显示名称</small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="submitSetGroupName()">确认设置</button>
            </div>
        </div>
    </div>
</div>

<!-- 新增组模态框 -->
<div class="modal fade" id="addGroupModal" tabindex="-1" aria-labelledby="addGroupModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addGroupModalLabel">新增设备组</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addGroupForm">
                    <div class="mb-3">
                        <label class="form-label">组名称</label>
                        <input type="text" class="form-control" id="newGroupName" placeholder="请输入组名称" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">访问问题</label>
                        <input type="text" class="form-control" id="newGroupQuestion" placeholder="请输入访问问题" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">访问答案</label>
                        <input type="text" class="form-control" id="newGroupAnswer" placeholder="请输入访问答案" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="submitAddGroup()">确认添加</button>
            </div>
        </div>
    </div>
</div>

<!-- 创建目录模态框 -->
<div class="modal fade" id="createDirModal" tabindex="-1" aria-labelledby="createDirModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="createDirModalLabel">创建新目录</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="createDirForm">
                    <div class="mb-3">
                        <label for="parentDirectoryPath" class="form-label">父目录路径</label>
                        <input type="text" class="form-control" id="parentDirectoryPath" readonly>
                    </div>
                    <div class="mb-3">
                        <label for="createDirName" class="form-label">新目录名称</label>
                        <input type="text" class="form-control" id="createDirName" required placeholder="仅包含字母、数字、下划线和连字符">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="createDirectory()">创建目录</button>
            </div>
        </div>
    </div>
</div>

<!-- 上传脚本模态框 -->
<div class="modal fade" id="uploadScriptModal" tabindex="-1" aria-labelledby="uploadScriptModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="uploadScriptModalLabel">上传脚本</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="uploadScriptForm" enctype="multipart/form-data">
                    <div class="mb-3">
                        <label for="uploadDirectory" class="form-label">上传目录</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="uploadDirectory" required readonly>
                            <button class="btn btn-outline-secondary" type="button" onclick="showDirectorySelector()">
                                <i class="fas fa-folder-open"></i> 选择
                            </button>
                        </div>
                        <div class="form-text">当前目录: <span id="currentUploadPath"></span></div>
                    </div>
                    
                    <!-- 目录选择器区域，默认隐藏 -->
                    <div id="directorySelectorArea" class="mb-3 p-2 border rounded bg-light" style="display: none; max-height: 200px; overflow-y: auto;">
                        <div id="directorySelector"></div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="scriptFile" class="form-label">选择脚本文件</label>
                        <input type="file" class="form-control" id="scriptFile" required accept=".sh,.py,.pl,.rb">
                        <div class="form-text">支持Shell (.sh), Python (.py), Perl (.pl), Ruby (.rb)脚本文件</div>
                    </div>
                    
                    <!-- 添加上传状态区域 -->
                    <div id="upload-status" class="mt-3"></div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="uploadScript()">上传</button>
            </div>
        </div>
    </div>
</div>

<!-- 编辑设备模态框（增强版，包含SSH端口） -->
<div class="modal fade" id="editDeviceModalEnhanced" tabindex="-1" aria-labelledby="editDeviceModalEnhancedLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editDeviceModalEnhancedLabel">编辑设备信息 (批量操作)</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editDeviceFormEnhanced">
                    <input type="hidden" id="editDeviceIdEnhanced">
                    <input type="hidden" id="editDeviceTypeEnhanced">
                    <div class="mb-3">
                        <label class="form-label">IP地址</label>
                        <input type="text" class="form-control" id="editDeviceIPEnhanced" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">SSH 端口</label>
                        <input type="number" class="form-control" id="editDeviceSshPortEnhanced" value="22" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">SSH 账号</label>
                        <input type="text" class="form-control" id="editDeviceUsernameEnhanced" required placeholder="例如：root 或 admin">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">SSH 密码</label>
                        <input type="password" class="form-control" id="editDevicePasswordEnhanced" required>
                        <div class="form-text text-danger">警告：密码将仅用于本次操作，不会被存储。但直接处理密码存在安全风险。</div>
                    </div>
                     <div class="mb-3">
                        <label class="form-label">设备品牌 (可选)</label>
                        <input type="text" class="form-control" id="editDeviceBrandEnhanced">
                    </div>
                     <div class="mb-3">
                        <label class="form-label">设备型号 (可选)</label>
                        <input type="text" class="form-control" id="editDeviceModelEnhanced">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="submitEditDeviceEnhanced()">保存修改 (仅本次)</button>
            </div>
        </div>
    </div>
</div>

<!-- 添加设备模态框（批量操作专用） -->
<div class="modal fade" id="addDeviceModalBatch" tabindex="-1" role="dialog" aria-labelledby="addDeviceModalBatchLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addDeviceModalBatchLabel">添加设备（批量操作）</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addDeviceFormBatch">
                    <div class="mb-3">
                        <label for="addDeviceIPBatch" class="form-label">设备IP地址 <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="addDeviceIPBatch" required>
                    </div>
                    <div class="mb-3">
                        <label for="addDeviceSshPortBatch" class="form-label">SSH端口 <span class="text-danger">*</span></label>
                        <input type="number" class="form-control" id="addDeviceSshPortBatch" value="22" required>
                    </div>
                    <div class="mb-3">
                        <label for="addDeviceUsernameBatch" class="form-label">SSH用户名 <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="addDeviceUsernameBatch" required>
                    </div>
                    <div class="mb-3">
                        <label for="addDevicePasswordBatch" class="form-label">SSH密码 <span class="text-danger">*</span></label>
                        <input type="password" class="form-control" id="addDevicePasswordBatch" required>
                        <div class="form-text text-warning">
                            <i class="fas fa-exclamation-triangle me-1"></i>
                            注意：密码仅保存在浏览器内存中，刷新页面后需重新输入
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="addDeviceBrandBatch" class="form-label">设备品牌</label>
                        <input type="text" class="form-control" id="addDeviceBrandBatch">
                    </div>
                    <div class="mb-3">
                        <label for="addDeviceModelBatch" class="form-label">设备型号</label>
                        <input type="text" class="form-control" id="addDeviceModelBatch">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="submitAddDeviceBatch()">添加</button>
            </div>
        </div>
    </div>
</div>

<!-- 设置执行命令模态框 -->
<div class="modal fade" id="setCommandModal" tabindex="-1" role="dialog" aria-labelledby="setCommandModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="setCommandModalLabel">设置执行命令</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="scriptPathDisplay" class="form-label">脚本路径</label>
                    <input type="text" class="form-control" id="scriptPathDisplay" readonly>
                </div>
                <div class="mb-3">
                    <label for="commandParams" class="form-label">命令参数</label>
                    <input type="text" class="form-control" id="commandParams" placeholder="例如: -a -b 参数1 参数2">
                    <div class="form-text">这些参数将作为命令行参数传递给脚本</div>
                </div>
                <div class="mb-3">
                    <label for="commandPreview" class="form-label">命令预览</label>
                    <input type="text" class="form-control" id="commandPreview" readonly>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="useRootCheck">
                    <label class="form-check-label" for="useRootCheck">
                        使用root权限执行 (sudo)
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-success" onclick="confirmExecution()">确认执行</button>
            </div>
        </div>
    </div>
</div>

<!-- 部署配置模态框 -->
<div class="modal fade" id="deploymentConfigModal" tabindex="-1" aria-labelledby="deploymentConfigModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deploymentConfigModalLabel">部署配置</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="deploymentSourceDir" class="form-label">源目录</label>
                    <input type="text" class="form-control" id="deploymentSourceDir" readonly>
                </div>
                <div class="mb-3">
                    <label for="deploymentTargetPath" class="form-label">目标路径</label>
                    <input type="text" class="form-control" id="deploymentTargetPath" required>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="confirmDeployment()">确认部署</button>
            </div>
        </div>
    </div>
</div>

<!-- 运行脚本模态框 -->
<div class="modal fade" id="runScriptModal" tabindex="-1" aria-labelledby="runScriptModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="runScriptModalLabel">批量运行脚本</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form>
                    <div class="mb-3">
                        <label class="form-label">脚本路径</label>
                        <input type="text" class="form-control" id="runScriptPath" readonly>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">选中设备数量</label>
                        <input type="text" class="form-control" id="runScriptDeviceCount" readonly>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">运行参数 <small class="text-muted">(可选)</small></label>
                        <input type="text" class="form-control" id="runScriptParams" placeholder="如: -v --debug">
                    </div>
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="useRootCheck" checked>
                        <label class="form-check-label" for="useRootCheck">使用root权限运行</label>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">命令预览</label>
                        <input type="text" class="form-control" id="commandPreview" readonly>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-warning" onclick="runScriptOnDevices()"><i class="fas fa-play me-1"></i> 运行脚本</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    var isAdmin = "{{ 'true' if is_admin else 'false' }}";
    isAdmin = (isAdmin === "true");
</script>
<!-- 先加载jQuery -->
<script src="{{ url_for('static', filename='js/jquery.min.js') }}"></script>
<!-- 再加载toastr -->
<script src="{{ url_for('static', filename='js/toastr.min.js') }}"></script>
<!-- 最后加载bootstrap -->
<script src="{{ url_for('static', filename='js/bootstrap.bundle.min.js') }}"></script>

<script>
// 等待jQuery和toastr加载完成后再配置
$(document).ready(function() {
// Toast 配置
toastr.options = {
    closeButton: true,
    progressBar: true,
    positionClass: "toast-top-right",
    timeOut: 5000,
    preventDuplicates: true,
    newestOnTop: true,
    maxOpened: 1,
    hideDuration: 300,
    onclick: null,
    showMethod: 'fadeIn',
    hideMethod: 'fadeOut',
    closeMethod: 'fadeOut',
    closeOnHover: true
};
});

// 刷新设备列表
function refreshDevices(type) {
    if (!type) {
        console.error('设备类型不能为空');
        return;
    }
    
    // 如果不是管理员，且未通过验证，则显示验证表单
    if (!isAdmin) {
        const authForm = document.getElementById(`${type}-auth-form`);
        const devicesContent = document.getElementById(`${type}-devices-content`);
        
        if (authForm && devicesContent) {
            // 检查是否已经通过验证
            const isAuthenticated = sessionStorage.getItem(`${type}-authenticated`) === 'true';
            
            if (!isAuthenticated) {
                // 未通过验证，显示验证表单
                authForm.style.display = 'block';
                devicesContent.style.display = 'none';
                return;
            }
        }
    }
    
    // 加载设备列表
    loadDevices(type, true); // 显示提示
}

// 验证答案
function verifyAnswer(type) {
    const answer = document.getElementById(`${type}-answer`).value;
    
    if (!answer) {
        toastr.error('请输入答案');
        return;
    }
    
    fetch('/api/knowledge/nas_auth', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            type: type,
            answer: answer
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.authenticated) {
            // 保存验证状态到会话存储
            sessionStorage.setItem(`${type}-authenticated`, 'true');
            
            // 隐藏验证表单，显示设备列表
            document.getElementById(`${type}-auth-form`).style.display = 'none';
            document.getElementById(`${type}-devices-content`).style.display = 'block';
            
            // 加载设备列表
            loadDevices(type, true);
            
            // 确保移除置灰效果
            removeDisabledGroupClass();
            
            toastr.success('验证成功');
        } else {
            toastr.error('答案错误，请重试');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        toastr.error('验证过程中发生错误');
    });
}

// 加载设备列表
function loadDevices(type, showToast = true) {
    if (!type) {
        console.error('设备类型不能为空');
        return;
    }
    
    fetch('/api/knowledge/nas_devices?type=' + type)
        .then(response => response.json())
        .then(data => {
            const tbody = document.getElementById(`${type}-devices-list`);
            if (!tbody) {
                console.error(`找不到元素: ${type}-devices-list`);
                return;
            }
            
            tbody.innerHTML = '';
            
            if (!data.devices || data.devices.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = `<td colspan="6" class="text-center">暂无设备</td>`;
                tbody.appendChild(row);
                if (showToast) {
                    toastr.info('暂无设备数据');
                }
                
                // 确保移除置灰效果
                removeDisabledGroupClass();
                return;
            }
            
            data.devices.forEach(device => {
                const row = document.createElement('tr');
                
                // 构建可点击的 IP 地址链接
                let ipDisplay = device.ip || '-';
                if (ipDisplay !== '-') {
                    // 检查是否已包含http协议
                    let ipUrl = ipDisplay;
                    // 移除可能存在的http或https前缀
                    if (ipUrl.startsWith('http://') || ipUrl.startsWith('https://')) {
                        // 如果已经是完整URL，直接使用
                        ipDisplay = `<a href="${ipUrl}" target="_blank" class="device-ip">${ipUrl}</a>`;
                    } else {
                        // 否则按原来的逻辑处理
                    if (!ipUrl.includes(':')) {
                        ipUrl += ':9999'; // 默认添加端口号
                    }
                    // 构建链接
                        ipDisplay = `<a href="http://${ipUrl}" target="_blank" class="device-ip">${ipUrl}</a>`;
                    }
                }
                
                row.innerHTML = `
                    <td>${device.brand || '-'}</td>
                    <td>${device.model || '-'}</td>
                    <td>${ipDisplay}</td>
                    <td>${device.username || '-'}</td>
                    <td>${device.password || '-'}</td>
                    ${isAdmin ? `
                    <td>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-primary" onclick="editDevice('${type}', ${JSON.stringify(device).replace(/"/g, '&quot;')})">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-danger" onclick="deleteDevice('${type}', '${device.id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                    ` : ''}
                `;
                tbody.appendChild(row);
            });
            
            // 确保移除置灰效果 
            removeDisabledGroupClass();
            
            if (showToast) {
                toastr.success('设备列表已刷新');
            }
        })
        .catch(error => {
            console.error('Error loading devices:', error);
            if (showToast) {
                toastr.error('加载设备列表失败');
            }
            
            // 即使发生错误也确保移除置灰效果
            removeDisabledGroupClass();
        });
}

// 安全关闭模态框的通用函数
function safeCloseModal(modalId) {
    console.log('正在安全关闭模态框:', modalId);
    
    const modalElement = document.getElementById(modalId);
    if (!modalElement) {
        console.error('找不到模态框:', modalId);
        return;
    }
    
    try {
        // 移除所有按钮的焦点
        modalElement.querySelectorAll('button').forEach(button => {
            button.blur();
        });
        
        // 获取模态框实例
        const modal = bootstrap.Modal.getInstance(modalElement);
        if (modal) {
            // 在隐藏模态框之前移除aria-hidden属性
            modalElement.removeAttribute('aria-hidden');
            modal.hide();
        }
        
        // 手动修复模态框状态
        modalElement.classList.remove('show');
        modalElement.style.display = 'none';
        modalElement.setAttribute('aria-hidden', 'true');
        modalElement.removeAttribute('aria-modal');
        modalElement.removeAttribute('role');
        
        // 清理模态框相关的DOM状态
        document.body.classList.remove('modal-open');
        document.body.style.removeProperty('padding-right');
        document.body.style.overflow = '';
        document.body.style.removeProperty('overflow');
        
        // 移除所有模态框背景
        document.querySelectorAll('.modal-backdrop').forEach(backdrop => {
            backdrop.classList.remove('show');
            backdrop.remove();
        });
        
        // 清理HTML元素上的样式
        document.documentElement.style.removeProperty('overflow');
        document.documentElement.style.removeProperty('padding-right');
        
        // 将焦点转移到body
        document.body.focus();
        
        // 移除置灰效果
        removeDisabledGroupClass();
        
        // 二次检查并移除任何残留的modal-backdrop
        setTimeout(() => {
            document.querySelectorAll('.modal-backdrop').forEach(backdrop => backdrop.remove());
            document.body.classList.remove('modal-open');
            document.body.style.removeProperty('overflow');
            removeDisabledGroupClass();
            console.log('模态框成功关闭:', modalId);
        }, 100);
    } catch (e) {
        console.error('关闭模态框时出错:', e);
        
        // 即使出错也尝试清理
        document.querySelectorAll('.modal-backdrop').forEach(backdrop => backdrop.remove());
        document.body.classList.remove('modal-open');
        document.body.style.removeProperty('padding-right');
        document.body.style.overflow = '';
        removeDisabledGroupClass();
    }
}

// 修改submitAddDevice函数
function submitAddDevice() {
    // 权限检查
    if (!isAdmin) {
        toastr.error('权限不足，只有管理员可以添加设备');
        return;
    }
    
    const form = document.getElementById('addDeviceForm');
    const formData = new FormData(form);
    
    // 获取IP并处理可能的协议前缀
    let ip = formData.get('ip');
    ip = cleanUpIpAddress(ip);
    
    const data = {
        type: formData.get('type'),
        brand: formData.get('brand'),
        model: formData.get('model'),
        ip: ip,
        username: formData.get('username'),
        password: formData.get('password')
    };

    // 检查所有字段
    if (!data.brand || data.brand.trim().length === 0) {
        toastr.error('请填写设备品牌');
        return;
    }
    if (!data.model || data.model.trim().length === 0) {
        toastr.error('请填写设备型号');
        return;
    }
    if (!data.ip || data.ip.trim().length === 0) {
        toastr.error('请填写IP地址');
        return;
    }
    if (!data.username || data.username.trim().length === 0) {
        toastr.error('请填写账号');
        return;
    }
    if (!data.password || data.password.trim().length === 0) {
        toastr.error('请填写密码');
        return;
    }

    fetch('/api/knowledge/nas_devices', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            // 安全关闭模态框
            safeCloseModal('addDeviceModal');
            
            form.reset();
            setTimeout(() => {
                // 确保使用正确的类型
                const deviceType = formData.get('type');
                if (deviceType) {
                    refreshDevices(deviceType);
                    toastr.success('设备添加成功');
                }
            }, 100);
        } else {
            toastr.error(data.message || '添加失败');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        toastr.error('添加设备时发生错误');
    });
}

// 提交设置问题表单
function submitSetQuestion() {
    // 权限检查
    if (!isAdmin) {
        toastr.error('权限不足，只有管理员可以设置问题');
        return;
    }
    
    const storageName = document.getElementById('storageName').value;
    const storageQuestion = document.getElementById('storageQuestion').value;
    const storageAnswer = document.getElementById('storageAnswer').value;
    const performanceName = document.getElementById('performanceName').value;
    const performanceQuestion = document.getElementById('performanceQuestion').value;
    const performanceAnswer = document.getElementById('performanceAnswer').value;

    if (!storageName || !storageQuestion || !storageAnswer || !performanceName || !performanceQuestion || !performanceAnswer) {
        toastr.error('请填写完整的信息');
        return;
    }

    const data = {
        storage: {
            name: storageName,
            question: storageQuestion,
            answer: storageAnswer
        },
        performance: {
            name: performanceName,
            question: performanceQuestion,
            answer: performanceAnswer
        }
    };

    fetch('/api/knowledge/nas_question', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // 先关闭模态框
            const setQuestionModal = document.getElementById('setQuestionModal');
            const modal = bootstrap.Modal.getInstance(setQuestionModal);
            if (modal) {
                modal.hide();
                // 移除模态框背景
                const modalBackdrop = document.querySelector('.modal-backdrop');
                if (modalBackdrop) {
                    modalBackdrop.remove();
                }
                // 移除 modal-open 类
                document.body.classList.remove('modal-open');
                document.body.style.overflow = '';
                document.body.style.paddingRight = '';
            }
            
            // 清空表单
            document.getElementById('setQuestionForm').reset();
            
            // 更新问题和组名称显示
            setTimeout(() => {
                if (document.getElementById('storage-question')) {
                    document.getElementById('storage-question').textContent = storageQuestion;
                }
                if (document.getElementById('performance-question')) {
                    document.getElementById('performance-question').textContent = performanceQuestion;
                }
                // 更新组名称
                if (document.getElementById('storage-group-name')) {
                    document.getElementById('storage-group-name').textContent = storageName;
                }
                if (document.getElementById('performance-group-name')) {
                    document.getElementById('performance-group-name').textContent = performanceName;
                }
                toastr.success('设置成功');
            }, 100);
        } else {
            toastr.error(data.message || '设置失败');
        }
    })
    .catch(error => {
        toastr.error('设置问题时发生错误');
        console.error('Error:', error);
    });
}

// 搜索设备
let currentSearchAbortController = null; // 添加AbortController全局变量

function searchDevices() {
    const keyword = document.getElementById('searchKeyword').value.trim();
    if (!keyword) {
        toastr.error('请输入搜索关键词');
        return;
    }
    
    // 如果有正在进行的搜索请求，先中断它
    if (currentSearchAbortController) {
        currentSearchAbortController.abort();
    }
    
    // 创建新的AbortController
    currentSearchAbortController = new AbortController();
    const signal = currentSearchAbortController.signal;
    
    // 显示加载动画
    document.getElementById('loadingSpinner').classList.remove('d-none');
    document.getElementById('searchResults').innerHTML = '';
    
    // 发送搜索请求
    fetch('/api/search_nas', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: `keyword=${encodeURIComponent(keyword)}`,
        signal: signal // 添加信号，以便可以中断请求
    })
    .then(response => response.json())
    .then(data => {
        // 隐藏加载动画
        document.getElementById('loadingSpinner').classList.add('d-none');
        
        if (data.error) {
            toastr.error(data.error);
            return;
        }
        
        displayResults(data.devices);
    })
    .catch(error => {
        // 如果是因为用户中断请求，不显示错误
        if (error.name === 'AbortError') {
            console.log('搜索已被用户中断');
        } else {
        document.getElementById('loadingSpinner').classList.add('d-none');
        toastr.error('搜索设备时发生错误');
        console.error('Error:', error);
        }
    });
}

// 检查单个设备（完全重写的设备检测逻辑）
async function checkDevice(ip, deviceName, deviceModel) {
    try {
        // 创建设备信息对象
        let deviceInfo = {
            name: '-',
            model: '-',
            ipv4: ip
        };
        
        // 更直接、稳定的检测方法
        try {
            // 更短的超时时间，提高响应速度
            const timeout = 1500;
            const controller = new AbortController();
            const id = setTimeout(() => controller.abort(), timeout);
            
            // 尝试连接设备以获取名称
            const response = await fetch(`http://${ip}:9999/ugreen/v1/wizard/is_initialize?token=`, {
                signal: controller.signal,
                cache: 'no-cache'
            });
            clearTimeout(id);
            
            if (response.ok) {
                const data = await response.json();
                if (data.code === 200 && data.data && data.data.device_name) {
                    deviceInfo.name = data.data.device_name;
                    console.log(`找到设备名称: ${deviceInfo.name} (${ip})`);
                    
                    // 如果获取到设备名称，直接尝试推导型号
                    const modelMap = {
                        'DXP8800PRO': 'DXP8800 Pro',
                        'DXP6800PLUS': 'DXP6800 Plus',
                        'DXP6800PRO': 'DXP6800 Pro',
                        'DXP2800': 'DXP2800',
                        'DXP480TPLUS': 'DXP480T Plus',
                        'DH2300': 'DH2300',
                        'DXP4800': 'DXP4800',
                        'DXP8800PLUS': 'DXP8800 Plus',
                        'DX4600': 'DX4600',
                        'DH2600': 'DH2600',
                        'DX4700': 'DX4700+',
                        'DXP4800PLUS': 'DXP4800 Plus',
                        'DH4300PLUS': 'DH4300 Plus',
                        'DH4300P': 'DH4300 Plus'
                    };
                    
                    // 从设备名称提取型号
                    for (const prefix in modelMap) {
                        if (deviceInfo.name.startsWith(prefix) || 
                            deviceInfo.name.includes(`-${prefix}`) || 
                            deviceInfo.name.includes(`_${prefix}`)) {
                            deviceInfo.model = modelMap[prefix];
                            break;
                        }
                    }
                    
                    // 如果还没有找到型号，尝试正则表达式匹配
                    if (deviceInfo.model === '-') {
                        const match = deviceInfo.name.match(/D[HX][0-9P]+(?:PLUS|PRO)?/i);
                        if (match && match[0]) {
                            const foundPrefix = match[0].toUpperCase();
                            if (modelMap[foundPrefix]) {
                                deviceInfo.model = modelMap[foundPrefix];
                            }
                        }
                    }
                }
            }
        } catch (error) {
            // 超时或请求错误，设备可能不在线
            return null;
        }
        
        // 如果已经获取到名称但没有型号，尝试直接获取型号
        if (deviceInfo.name !== '-' && deviceInfo.model === '-') {
            try {
                const timeout = 1500;
                const controller = new AbortController();
                const id = setTimeout(() => controller.abort(), timeout);
                
                const modelResponse = await fetch(`http://${ip}:9999/system/check`, {
                    signal: controller.signal,
                    cache: 'no-cache'
                });
                clearTimeout(id);
                
                if (modelResponse.ok) {
                    const modelData = await modelResponse.json();
                    if (modelData.code === 200 && modelData.data && modelData.data.model) {
                        deviceInfo.model = modelData.data.model;
                        console.log(`找到设备型号: ${deviceInfo.model} (${ip})`);
                    }
                }
            } catch (error) {
                // 忽略型号获取错误
            }
        }
        
        // 最终判断是否符合筛选条件
        if (deviceName && deviceInfo.name !== '-') {
            if (!deviceInfo.name.toLowerCase().includes(deviceName.toLowerCase())) {
                return null; // 名称不匹配条件
            }
        }
        
        if (deviceModel && deviceInfo.model !== '-') {
            if (!deviceInfo.model.toLowerCase().includes(deviceModel.toLowerCase())) {
                return null; // 型号不匹配条件
            }
        }
        
        // 设备在线且符合筛选条件
        return deviceInfo;
    } catch (error) {
        console.error(`设备检测错误 ${ip}:`, error);
        return null;
    }
}

// 查询单个网段
async function searchSegment(segment, deviceName, deviceModel) {
    const devices = [];
    
    // 生成1-254的IP地址分组
    const ipGroups = [];
    const batchSize = 10;
    
    for (let i = 1; i <= 254; i += batchSize) {
        const group = [];
        for (let j = i; j < i + batchSize && j <= 254; j++) {
            group.push(`${segment}.${j}`);
        }
        ipGroups.push(group);
    }
    
    // 逐组处理IP地址
    for (const group of ipGroups) {
        const promises = group.map(ip => 
            checkDevice(ip, deviceName, deviceModel)
                .then(device => {
                    if (device) {
                        devices.push(device);
                    }
                })
                .catch(() => {})
        );
        
        await Promise.all(promises);
    }
    
    return devices;
}

// 修复显示搜索结果函数
function displayResults(devices) {
    const resultsDiv = document.getElementById('searchResults');
    resultsDiv.innerHTML = '';
    
    if (!devices || devices.length === 0 || (devices.length === 1 && devices[0].message)) {
        resultsDiv.innerHTML = `
            <div class="alert alert-warning" role="alert">
                <i class="fas fa-exclamation-triangle me-2"></i>
                ${devices && devices[0] && devices[0].message ? devices[0].message : '没有找到匹配的设备'}
            </div>`;
        return;
    }
    
    // 先按照设备的来源分组
    const serverDevices = devices.filter(d => d.source === 'server');
    const clientDevices = devices.filter(d => d.source === 'client');
    
    // 显示从服务器获取的设备
    if (serverDevices.length > 0) {
        const serverCard = document.createElement('div');
        serverCard.className = 'card shadow mb-4';
        
        const serverCardHeader = document.createElement('div');
        serverCardHeader.className = 'card-header bg-white d-flex justify-content-between align-items-center';
        serverCardHeader.innerHTML = `
            <h5 class="mb-0">中央服务器设备列表</h5>
            <span class="badge bg-primary">${serverDevices.length}台设备</span>
        `;
        
        const serverCardBody = document.createElement('div');
        serverCardBody.className = 'card-body';
        
        const serverTableResponsive = document.createElement('div');
        serverTableResponsive.className = 'table-responsive';
        
        const serverTable = document.createElement('table');
        serverTable.className = 'table table-hover';
        serverTable.innerHTML = `
        <thead>
            <tr>
                <th>设备名称</th>
                <th>型号</th>
                <th>IPV4地址</th>
                <th>操作</th>
            </tr>
        </thead>
        <tbody>
        </tbody>
    `;
    
        const serverTbody = serverTable.querySelector('tbody');
        serverDevices.forEach(device => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${device.name || '-'}</td>
            <td>${device.model || '-'}</td>
                <td class="device-ip">${device.ipv4}</td>
            <td>
                <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline-primary" onclick="window.open('http://${device.ipv4}:9999')">
                        <i class="fas fa-external-link-alt me-1"></i>HTTP
                    </button>
                    <button class="btn btn-outline-success" onclick="window.open('https://${device.ipv4}:9443')">
                        <i class="fas fa-lock me-1"></i>HTTPS
                    </button>
                </div>
            </td>
        `;
            serverTbody.appendChild(row);
        });
        
        serverTableResponsive.appendChild(serverTable);
        serverCardBody.appendChild(serverTableResponsive);
        serverCard.appendChild(serverCardHeader);
        serverCard.appendChild(serverCardBody);
        resultsDiv.appendChild(serverCard);
    }
    
    // 显示从本地网络获取的设备
    if (clientDevices.length > 0) {
        const clientCard = document.createElement('div');
        clientCard.className = 'card shadow';
        
        const clientCardHeader = document.createElement('div');
        clientCardHeader.className = 'card-header bg-white d-flex justify-content-between align-items-center';
        clientCardHeader.innerHTML = `
            <h5 class="mb-0">本地网络设备列表</h5>
            <span class="badge bg-primary">${clientDevices.length}台设备</span>
        `;
        
        const clientCardBody = document.createElement('div');
        clientCardBody.className = 'card-body';
        
        const clientTableResponsive = document.createElement('div');
        clientTableResponsive.className = 'table-responsive';
        
        const clientTable = document.createElement('table');
        clientTable.className = 'table table-hover';
        clientTable.innerHTML = `
            <thead>
                <tr>
                    <th>设备名称</th>
                    <th>型号</th>
                    <th>IPV4地址</th>
                    <th>操作</th>
                </tr>
            </thead>
            <tbody>
            </tbody>
        `;
        
        const clientTbody = clientTable.querySelector('tbody');
        clientDevices.forEach(device => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${device.name || '-'}</td>
                <td>${device.model || '-'}</td>
                <td class="device-ip">${device.ipv4}</td>
                <td>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-primary" onclick="window.open('http://${device.ipv4}:9999')">
                            <i class="fas fa-external-link-alt me-1"></i>HTTP
                        </button>
                        <button class="btn btn-outline-success" onclick="window.open('https://${device.ipv4}:9443')">
                            <i class="fas fa-lock me-1"></i>HTTPS
                        </button>
                    </div>
                </td>
            `;
            clientTbody.appendChild(row);
        });
        
        clientTableResponsive.appendChild(clientTable);
        clientCardBody.appendChild(clientTableResponsive);
        clientCard.appendChild(clientCardHeader);
        clientCard.appendChild(clientCardBody);
        resultsDiv.appendChild(clientCard);
    }
}

// 开始指针查询
function startPointerSearch() {
    const networkSegments = document.getElementById('networkSegments').value.trim();
    const deviceName = document.getElementById('deviceName').value.trim();
    const deviceModel = document.getElementById('deviceModel').value.trim();
    
    if (!networkSegments) {
        toastr.error('请输入要查询的网段');
        return;
    }
    
    // 显示加载动画
    document.getElementById('loadingSpinner').classList.remove('d-none');
    document.getElementById('searchResults').innerHTML = '';
    
    // 存储所有找到的设备
    const foundDevices = [];
    const segments = networkSegments.split(' ').filter(Boolean);
    let completedSegments = 0;
    
    // 定义进度更新函数
    const updateProgress = (segment, total, found) => {
        const loadingText = document.querySelector('#loadingSpinner p');
        loadingText.textContent = `正在搜索网段 ${segment}... 已找到 ${found} 台设备（${completedSegments}/${segments.length}）`;
    };
    
    segments.forEach(segment => {
        // 更新进度提示
        updateProgress(segment, segments.length, foundDevices.length);
        
        // 对每个网段执行查询
        searchSegment(segment, deviceName, deviceModel)
            .then(devices => {
                foundDevices.push(...devices);
                completedSegments++;
                
                // 更新进度
                updateProgress(segment, segments.length, foundDevices.length);
                
                // 如果所有网段都已查询完成
                if (completedSegments === segments.length) {
                    document.getElementById('loadingSpinner').classList.add('d-none');
                    displayResults(foundDevices);
                }
            })
            .catch(error => {
                console.error('网段搜索错误:', error);
                completedSegments++;
                
                // 如果所有网段都已查询完成
                if (completedSegments === segments.length) {
                    document.getElementById('loadingSpinner').classList.add('d-none');
                    displayResults(foundDevices);
                }
            });
    });
}

// 清空搜索表单和结果
function clearSearchForm() {
    // 中断当前正在进行的查询
    if (currentSearchAbortController) {
        currentSearchAbortController.abort();
        currentSearchAbortController = null;
    }
    
    // 隐藏加载动画
    document.getElementById('loadingSpinner').classList.add('d-none');
    
    document.getElementById('searchResults').innerHTML = '';
    document.getElementById('searchKeyword').value = '';
    document.getElementById('networkSegments').value = '';
    document.getElementById('deviceName').value = '';
    document.getElementById('deviceModel').value = '';
}

// 添加一个更强大的移除置灰效果的辅助函数
function removeDisabledGroupClass() {
    console.log('执行移除置灰效果');
    
    // 获取所有的标签内容面板
    const contentElements = document.querySelectorAll('.tab-pane');
    contentElements.forEach(element => {
        // 移除disabled-group类
        if (element.classList.contains('disabled-group')) {
            element.classList.remove('disabled-group');
            console.log('已移除置灰效果：', element.id);
        }
        
        // 确保内容面板可见性
        if (element.classList.contains('active')) {
            element.style.opacity = '1';
            element.style.pointerEvents = 'auto';
        }
    });
    
    // 移除所有可能含有disabled-group类的元素
    document.querySelectorAll('.disabled-group').forEach(el => {
        el.classList.remove('disabled-group');
        console.log('移除其他元素的置灰效果');
    });
    
    // 强制刷新视图
    setTimeout(() => {
        // 确保标签切换正常
        document.querySelectorAll('.nav-link').forEach(tab => {
            tab.style.pointerEvents = 'auto';
        });
        
        // 确保表单元素可交互
        document.querySelectorAll('input, button, select, textarea').forEach(el => {
            el.style.pointerEvents = 'auto';
            el.style.opacity = '1';
        });
    }, 0);
}

// 页面加载完成后执行
document.addEventListener('DOMContentLoaded', function() {
    console.log("页面加载完成，开始初始化...");
    
    // 立即移除置灰效果
    removeDisabledGroupClass();

    // 初始化所有模态框
    const modals = document.querySelectorAll('.modal');
    modals.forEach(modal => {
        new bootstrap.Modal(modal);
    });

    // 监听所有标签页切换事件
    document.querySelectorAll('[data-bs-toggle="tab"]').forEach(tab => {
        tab.addEventListener('shown.bs.tab', function (e) {
            console.log('标签页切换，移除置灰效果');
            removeDisabledGroupClass();
        });
    });
    
    // 监听所有模态框事件
    document.querySelectorAll('.modal').forEach(modal => {
        modal.addEventListener('shown.bs.modal', function() {
            console.log('模态框显示，移除置灰效果');
            removeDisabledGroupClass();
        });
        
        modal.addEventListener('hidden.bs.modal', function() {
            console.log('模态框隐藏，移除置灰效果');
            removeDisabledGroupClass();
            
            // 等待DOM更新后再次检查
            setTimeout(() => {
                // 确保页面完全恢复交互性
                document.querySelectorAll('.modal-backdrop').forEach(backdrop => backdrop.remove());
                document.body.classList.remove('modal-open');
                document.body.style.removeProperty('padding-right');
                document.body.style.overflow = '';
                document.body.style.removeProperty('overflow');
                
                removeDisabledGroupClass();
            }, 100);
            
            setTimeout(removeDisabledGroupClass, 500);
        });
    });
    
    // 监听所有表单提交按钮
    document.querySelectorAll('button[type="submit"], button[onclick*="submit"]').forEach(btn => {
        btn.addEventListener('click', function() {
            console.log('提交按钮点击，移除置灰效果');
            removeDisabledGroupClass();
            
            // 稍后再次检查以确保表单提交后页面状态正常
            setTimeout(() => {
                // 自动清理任何模态框残留
                document.querySelectorAll('.modal-backdrop').forEach(backdrop => backdrop.remove());
                document.body.classList.remove('modal-open');
                document.body.style.removeProperty('padding-right');
                document.body.style.overflow = '';
                document.body.style.removeProperty('overflow');
                
                removeDisabledGroupClass();
            }, 200);
            
            setTimeout(removeDisabledGroupClass, 1000);
        });
    });

    // 设置定时检查，确保页面不会置灰
    setInterval(() => {
        // 如果页面上存在模态框背景但没有显示的模态框，则清除背景
        const hasOpenModal = document.querySelector('.modal.show');
        const hasBackdrop = document.querySelector('.modal-backdrop');
        
        if (!hasOpenModal && hasBackdrop) {
            console.log('检测到孤立的模态框背景，正在清理');
            hasBackdrop.remove();
            document.body.classList.remove('modal-open');
            document.body.style.removeProperty('padding-right');
            document.body.style.overflow = '';
            removeDisabledGroupClass();
        }
    }, 2000);

    // 初始化所有工具提示
    const tooltips = document.querySelectorAll('[data-bs-toggle="tooltip"]');
    tooltips.forEach(tooltip => {
        new bootstrap.Tooltip(tooltip);
    });

    // 初始化所有下拉菜单
    const dropdowns = document.querySelectorAll('.dropdown-toggle');
    dropdowns.forEach(dropdown => {
        new bootstrap.Dropdown(dropdown);
    });

    // 设置预加载资源的crossorigin
    document.querySelectorAll('link[rel="preload"]').forEach(link => {
        if (!link.hasAttribute('crossorigin')) {
            link.setAttribute('crossorigin', 'anonymous');
        }
    });

    // 自动修复页面，防止可能的模态框问题
    document.addEventListener('click', function(e) {
        // 如果点击了页面但存在模态框背景且没有显示的模态框，则清除背景
        setTimeout(() => {
            const hasOpenModal = document.querySelector('.modal.show');
            const hasBackdrop = document.querySelector('.modal-backdrop');
            
            if (!hasOpenModal && hasBackdrop) {
                console.log('点击事件后检测到孤立的模态框背景，正在清理');
                hasBackdrop.remove();
                document.body.classList.remove('modal-open');
                document.body.style.removeProperty('padding-right');
                document.body.style.overflow = '';
                removeDisabledGroupClass();
            }
        }, 300);
    });

    // 如果是管理员，加载相关设置
    if (typeof isAdmin !== 'undefined' && isAdmin) {
        // 加载问题和组名称设置
        loadQuestionSettings();
        
        // 加载所有组的设备列表
        setTimeout(() => {
            // 加载默认组
            loadDevices('storage', false);
            loadDevices('performance', false);
            
            // 加载其他自定义组
            fetch('/api/knowledge/nas_question')
                .then(response => response.json())
                .then(data => {
                    Object.keys(data).forEach(groupId => {
                        if (groupId !== 'storage' && groupId !== 'performance') {
                            loadDevices(groupId, false);
                        }
                    });
                    
                    // 再次确保没有置灰效果
                    removeDisabledGroupClass();
                })
                .catch(error => {
                    console.error('加载自定义组时发生错误:', error);
                });
        }, 300);
    } else {
        // 非管理员，检查是否已经通过验证
        const storageAuthenticated = sessionStorage.getItem('storage-authenticated') === 'true';
        const performanceAuthenticated = sessionStorage.getItem('performance-authenticated') === 'true';
        
        // 加载问题和组名称设置
        loadQuestionSettings();
        
        if (storageAuthenticated) {
            document.getElementById('storage-auth-form').style.display = 'none';
            document.getElementById('storage-devices-content').style.display = 'block';
            loadDevices('storage', false); // 不显示提示
        }
        
        if (performanceAuthenticated) {
            document.getElementById('performance-auth-form').style.display = 'none';
            document.getElementById('performance-devices-content').style.display = 'block';
            loadDevices('performance', false); // 不显示提示
        }
    }
    
    // 最后再次确保移除所有置灰效果
    setTimeout(removeDisabledGroupClass, 1000);
    setTimeout(removeDisabledGroupClass, 2000);
    
    console.log("页面初始化完成");
    
    // 监听普通搜索框回车事件
    document.getElementById('searchKeyword').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            searchDevices();
        }
    });
    
    // 监听指针查询页面的三个输入框回车事件
    document.getElementById('networkSegments').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault(); // 阻止表单默认提交行为
            startPointerSearch();
        }
    });
    
    document.getElementById('deviceName').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault(); // 阻止表单默认提交行为
            startPointerSearch();
        }
    });
    
    document.getElementById('deviceModel').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault(); // 阻止表单默认提交行为
            startPointerSearch();
        }
    });
});

function toggleCommonDevices(){
  var section = document.getElementById('commonDevicesSection');
  if(section.classList.contains('d-none')){
    section.classList.remove('d-none');
    toastr.info('常用设备列表已展开');
  } else {
    section.classList.add('d-none');
    toastr.info('常用设备列表已收起');
  }
}

// 删除设备函数
function deleteDevice(type, id) {
    // 权限检查
    if (!isAdmin) {
        toastr.error('权限不足，只有管理员可以删除设备');
        return;
    }
    
    if (confirm('确定要删除此设备吗？')) {
        // 使用 POST 方法并使用正确的删除API路径
        fetch('/api/knowledge/nas_devices/delete', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                id: id,
                type: type
            })
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                toastr.success('设备删除成功');
                refreshDevices(type);
            } else {
                toastr.error(data.message || '删除失败');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            toastr.error('删除设备时发生错误');
        });
    }
}

// 编辑设备函数
function editDevice(type, device) {
    // 权限检查
    if (!isAdmin) {
        toastr.error('权限不足，只有管理员可以编辑设备');
        return;
    }
    
    const form = document.getElementById('editDeviceForm');
    
    // 填充表单
    form.querySelector('#editDeviceId').value = device.id;
    form.querySelector('#editDeviceType').value = type;
    form.querySelector('#editDeviceBrand').value = device.brand;
    form.querySelector('#editDeviceModel').value = device.model;
    form.querySelector('#editDeviceIP').value = device.ip;
    form.querySelector('#editDeviceUsername').value = device.username;
    form.querySelector('#editDevicePassword').value = device.password;
    
    // 显示编辑模态框
    const editModal = new bootstrap.Modal(document.getElementById('editDeviceModal'));
    editModal.show();
}

// 修改submitEditDevice函数
function submitEditDevice() {
    // 权限检查
    if (!isAdmin) {
        toastr.error('权限不足，只有管理员可以更新设备信息');
        return;
    }
    
    const form = document.getElementById('editDeviceForm');
    const id = form.querySelector('#editDeviceId').value;
    
    // 获取IP并处理可能的协议前缀
    let ip = form.querySelector('#editDeviceIP').value.trim();
    ip = cleanUpIpAddress(ip);
    
    const data = {
        id: id,
        type: form.querySelector('#editDeviceType').value,
        brand: form.querySelector('#editDeviceBrand').value.trim(),
        model: form.querySelector('#editDeviceModel').value.trim(),
        ip: ip,
        username: form.querySelector('#editDeviceUsername').value.trim(),
        password: form.querySelector('#editDevicePassword').value.trim()
    };

    // 验证所有字段
    if (!data.brand) {
        toastr.error('请填写设备品牌');
        return;
    }
    if (!data.model) {
        toastr.error('请填写设备型号');
        return;
    }
    if (!data.ip) {
        toastr.error('请填写IP地址');
        return;
    }
    if (!data.username) {
        toastr.error('请填写账号');
        return;
    }
    if (!data.password) {
        toastr.error('请填写密码');
        return;
    }

    fetch('/api/knowledge/nas_devices/update', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            // 安全关闭模态框
            safeCloseModal('editDeviceModal');
            
            setTimeout(() => {
                refreshDevices(data.type || form.querySelector('#editDeviceType').value);
                toastr.success('设备信息更新成功');
            }, 100);
        } else {
            toastr.error(data.message || '更新失败');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        toastr.error('更新设备信息时发生错误');
    });
}

// 清理IP地址，移除协议前缀
function cleanUpIpAddress(ip) {
    if (!ip) return ip;
    
    // 移除http或https前缀
    if (ip.startsWith('http://')) {
        ip = ip.substring(7);
    } else if (ip.startsWith('https://')) {
        ip = ip.substring(8);
    }
    
    // 移除可能的路径
    const pathIndex = ip.indexOf('/');
    if (pathIndex > 0) {
        ip = ip.substring(0, pathIndex);
    }
    
    return ip;
}

// 提交新增组表单
function submitAddGroup() {
    // 权限检查
    if (!isAdmin) {
        toastr.error('权限不足，只有管理员可以添加新组');
        return;
    }
    
    // 获取表单数据
    const groupName = document.getElementById('newGroupName').value;
    const groupQuestion = document.getElementById('newGroupQuestion').value;
    const groupAnswer = document.getElementById('newGroupAnswer').value;

    // 表单验证
    if (!groupName || !groupQuestion || !groupAnswer) {
        toastr.error('请填写完整的信息');
        return;
    }
    
    // 先关闭模态框 - 直接使用bootstrap API
    const addGroupModal = document.getElementById('addGroupModal');
    const modal = bootstrap.Modal.getInstance(addGroupModal);
            if (modal) {
                modal.hide();
        // 移除模态框背景
        const modalBackdrop = document.querySelector('.modal-backdrop');
        if (modalBackdrop) {
            modalBackdrop.remove();
            }
        // 移除 modal-open 类
            document.body.classList.remove('modal-open');
        document.body.style.overflow = '';
        document.body.style.paddingRight = '';
    }
    
    // 先清空表单
    document.getElementById('addGroupForm').reset();
    
    // 再次确保没有置灰效果
    removeDisabledGroupClass();
    
    // 显示加载提示
    toastr.info('正在添加新组，请稍候...');
    
    // 获取现有组设置
    fetch('/api/knowledge/nas_question')
        .then(response => response.json())
        .then(currentData => {
            // 生成新的组ID
            const newGroupId = 'group_' + Date.now();
            
            // 添加新组
            currentData[newGroupId] = {
                name: groupName,
                question: groupQuestion,
                answer: groupAnswer
            };

            // 保存设置
            return fetch('/api/knowledge/nas_question', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(currentData)
            });
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // 添加新的tab
                const groupTabs = document.getElementById('groupTabs');
                const groupTabContent = document.getElementById('groupTabContent');
                
                // 创建新的tab按钮
                const newTabId = 'group_' + Date.now();
                const newTabButton = document.createElement('li');
                newTabButton.className = 'nav-item';
                newTabButton.setAttribute('role', 'presentation');
                newTabButton.innerHTML = `
                    <button class="nav-link" id="${newTabId}-tab" data-bs-toggle="tab" data-bs-target="#${newTabId}-content" type="button" role="tab">
                        <span id="${newTabId}-group-name">${groupName}</span>
                    </button>
                `;
                
                // 创建新的内容面板
                const newContent = document.createElement('div');
                newContent.className = 'tab-pane fade';
                newContent.id = `${newTabId}-content`;
                newContent.setAttribute('role', 'tabpanel');
                newContent.innerHTML = `
                    <div class="d-flex justify-content-between mb-3">
                        <button class="btn btn-outline-danger btn-sm" onclick="deleteGroup('${newTabId}')">
                            <i class="fas fa-trash me-1"></i>删除此组
                        </button>
                        <button class="btn btn-outline-primary btn-sm" onclick="refreshDevices('${newTabId}')">
                            <i class="fas fa-sync-alt me-1"></i>刷新列表
                        </button>
                    </div>
                    <div id="${newTabId}-devices">
                        <div id="${newTabId}-devices-content">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>设备品牌</th>
                                            <th>设备型号</th>
                                            <th>IP地址</th>
                                            <th>账号</th>
                                            <th>密码</th>
                                            ${isAdmin ? '<th>操作</th>' : ''}
                                        </tr>
                                    </thead>
                                    <tbody id="${newTabId}-devices-list"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                `;
                
                // 添加到DOM
                groupTabs.appendChild(newTabButton);
                groupTabContent.appendChild(newContent);
                
                // 激活新添加的tab
                const newTab = document.getElementById(`${newTabId}-tab`);
                new bootstrap.Tab(newTab).show();
                
                // 加载新组的设备列表
                loadDevices(newTabId, true);
                
                // 确保移除所有置灰效果
                removeDisabledGroupClass();
                
                toastr.success('新组添加成功');
            } else {
                toastr.error(data.message || '添加组失败');
            }
            
            // 再次确保移除所有置灰效果
            removeDisabledGroupClass();
        })
        .catch(error => {
            toastr.error('添加组时发生错误');
            console.error('Error:', error);
            
            // 发生错误时也需要移除置灰效果
            removeDisabledGroupClass();
        });
}

// 加载问题和组名称设置
function loadQuestionSettings() {
    fetch('/api/knowledge/nas_question')
        .then(response => response.json())
        .then(data => {
            // 设置问题和组名称的默认值
            const storageData = data.storage || {};
            const performanceData = data.performance || {};
            
            // 设置问题
            if (document.getElementById('storage-question')) {
                document.getElementById('storage-question').textContent = storageData.question || '请输入存储组访问密码:';
            }
            if (document.getElementById('performance-question')) {
                document.getElementById('performance-question').textContent = performanceData.question || '请输入性能专项组访问密码:';
            }
            
            // 设置组名称
            if (document.getElementById('storage-group-name')) {
                document.getElementById('storage-group-name').textContent = storageData.name || '存储组';
            }
            if (document.getElementById('performance-group-name')) {
                document.getElementById('performance-group-name').textContent = performanceData.name || '性能专项组';
            }
            
            // 如果是管理员，同时设置模态框中的值
            if (isAdmin) {
                if (document.getElementById('storageName')) {
                    document.getElementById('storageName').value = storageData.name || '存储组';
                }
                if (document.getElementById('storageQuestion')) {
                    document.getElementById('storageQuestion').value = storageData.question || '请输入存储组访问密码:';
                }
                if (document.getElementById('storageAnswer')) {
                    document.getElementById('storageAnswer').value = storageData.answer || '';
                }
                
                if (document.getElementById('performanceName')) {
                    document.getElementById('performanceName').value = performanceData.name || '性能专项组';
                }
                if (document.getElementById('performanceQuestion')) {
                    document.getElementById('performanceQuestion').value = performanceData.question || '请输入性能专项组访问密码:';
                }
                if (document.getElementById('performanceAnswer')) {
                    document.getElementById('performanceAnswer').value = performanceData.answer || '';
                }
                
                // 设置组名称模态框
                if (document.getElementById('groupNameStorage')) {
                    document.getElementById('groupNameStorage').value = storageData.name || '存储组';
                }
                if (document.getElementById('groupNamePerformance')) {
                    document.getElementById('groupNamePerformance').value = performanceData.name || '性能专项组';
                }
            }
            
            // 加载自定义组标签
            Object.keys(data).forEach(groupId => {
                if (groupId !== 'storage' && groupId !== 'performance') {
                    const groupInfo = data[groupId];
                    // 检查是否已存在该组的标签
                    if (!document.getElementById(`${groupId}-tab`)) {
                        addGroupTab(groupId, groupInfo.name);
                    }
                }
            });
        })
        .catch(error => {
            console.error('加载问题设置时发生错误:', error);
        });
}

// 添加组标签的辅助函数
function addGroupTab(groupId, groupName) {
    const groupTabs = document.getElementById('groupTabs');
    const groupTabContent = document.getElementById('groupTabContent');
    
    if (!groupTabs || !groupTabContent) return;
    
    // 创建新的tab按钮
    const newTabButton = document.createElement('li');
    newTabButton.className = 'nav-item';
    newTabButton.setAttribute('role', 'presentation');
    newTabButton.innerHTML = `
        <button class="nav-link" id="${groupId}-tab" data-bs-toggle="tab" data-bs-target="#${groupId}-content" type="button" role="tab">
            <span id="${groupId}-group-name">${groupName}</span>
        </button>
    `;
    
    // 创建新的内容面板
    const newContent = document.createElement('div');
    newContent.className = 'tab-pane fade';
    newContent.id = `${groupId}-content`;
    newContent.setAttribute('role', 'tabpanel');
    newContent.innerHTML = `
        <div class="d-flex justify-content-between mb-3">
            <button class="btn btn-outline-danger btn-sm" onclick="deleteGroup('${groupId}')">
                <i class="fas fa-trash me-1"></i>删除此组
            </button>
            <button class="btn btn-outline-primary btn-sm" onclick="refreshDevices('${groupId}')">
                <i class="fas fa-sync-alt me-1"></i>刷新列表
            </button>
        </div>
        <div id="${groupId}-devices">
            <div id="${groupId}-devices-content">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>设备品牌</th>
                                <th>设备型号</th>
                                <th>IP地址</th>
                                <th>账号</th>
                                <th>密码</th>
                                ${isAdmin ? '<th>操作</th>' : ''}
                            </tr>
                        </thead>
                        <tbody id="${groupId}-devices-list"></tbody>
                    </table>
                </div>
            </div>
        </div>
    `;
    
    // 添加到DOM
    groupTabs.appendChild(newTabButton);
    groupTabContent.appendChild(newContent);
}

// 删除组函数
function deleteGroup(groupId) {
    // 权限检查
    if (!isAdmin) {
        toastr.error('权限不足，只有管理员可以删除组');
        return;
    }
    
    if (confirm('确定要删除此组吗？删除后组内的所有设备也会被删除！')) {
        // 先从DOM中移除标签和内容
        const tabElement = document.getElementById(`${groupId}-tab`);
        const contentElement = document.getElementById(`${groupId}-content`);
        
        if (tabElement && tabElement.parentNode) {
            tabElement.parentNode.removeChild(tabElement);
        }
        
        if (contentElement && contentElement.parentNode) {
            contentElement.parentNode.removeChild(contentElement);
        }
        
        // 切换到存储组标签
        const storageTab = document.getElementById('storage-tab');
        if (storageTab) {
            new bootstrap.Tab(storageTab).show();
        }
        
        // 获取现有组设置
        fetch('/api/knowledge/nas_question')
            .then(response => response.json())
            .then(currentData => {
                // 从数据中删除该组
                delete currentData[groupId];
                
                // 保存更新后的设置
                return fetch('/api/knowledge/nas_question', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(currentData)
                });
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    toastr.success('组删除成功');
                    
                    // 删除该组的所有设备
                    deleteDevicesByType(groupId);
                } else {
                    toastr.error(data.message || '删除组失败');
                }
            })
            .catch(error => {
                toastr.error('删除组时发生错误');
                console.error('Error:', error);
            });
    }
}

// 删除系统组（仅删除设备不删除组）
function deleteSystemGroup(groupId, groupName) {
    // 权限检查
    if (!isAdmin) {
        toastr.error('权限不足，只有管理员可以删除组设备');
        return;
    }
    
    if (confirm(`确定要删除${groupName}中的所有设备吗？组本身不会被删除，但组内所有设备将被清空！`)) {
        // 显示加载提示
        toastr.info('正在删除组内设备，请稍候...');
        
        // 删除该组的所有设备
        deleteDevicesByType(groupId)
            .then(() => {
                toastr.success(`${groupName}设备已清空`);
                // 刷新设备列表
                refreshDevices(groupId);
            })
            .catch(error => {
                console.error('删除组设备出错:', error);
                toastr.error('删除组设备时发生错误');
            });
    }
}

// 按类型删除所有设备的辅助函数
async function deleteDevicesByType(type) {
    try {
        // 1. 获取该类型的所有设备
        const response = await fetch(`/api/knowledge/nas_devices?type=${type}`);
        const data = await response.json();
        
        if (!data.devices || data.devices.length === 0) {
            console.log(`组 ${type} 内没有设备可删除`);
            return;
        }
        
        const deviceIds = data.devices.map(device => device.id);
        console.log(`准备删除组 ${type} 内的 ${deviceIds.length} 个设备`);
        
        // 2. 逐个删除设备
        const deletePromises = deviceIds.map(deviceId => {
            return fetch('/api/knowledge/nas_devices/delete', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ id: deviceId, type: type }) 
            })
            .then(response => response.json())
            .then(result => {
                if (!result.success) {
                    console.warn(`删除设备 ${deviceId} 失败:`, result.message);
                }
            })
            .catch(error => {
                console.error(`删除设备 ${deviceId} 时发生错误:`, error);
            });
        });
        
        // 等待所有删除请求完成
        await Promise.all(deletePromises);
        console.log(`组 ${type} 内的所有设备删除完成`);
        
    } catch (error) {
        console.error(`按类型删除设备时出错 (类型: ${type}):`, error);
        throw error; // 将错误向上抛出，以便调用者处理
    }
}

// 设置组名称函数
function submitSetGroupName() {
    // 权限检查
    if (!isAdmin) {
        toastr.error('权限不足，只有管理员可以设置组名称');
        return;
    }
    
    const storageName = document.getElementById('groupNameStorage').value;
    const performanceName = document.getElementById('groupNamePerformance').value;

    if (!storageName || !performanceName) {
        toastr.error('请填写完整的组名称');
        return;
    }
    
    // 先关闭模态框 - 直接使用bootstrap API
    const setGroupNameModal = document.getElementById('setGroupNameModal');
    const modal = bootstrap.Modal.getInstance(setGroupNameModal);
    if (modal) {
        modal.hide();
        // 移除模态框背景
        const modalBackdrop = document.querySelector('.modal-backdrop');
        if (modalBackdrop) {
            modalBackdrop.remove();
        }
        // 移除 modal-open 类
        document.body.classList.remove('modal-open');
        document.body.style.overflow = '';
        document.body.style.paddingRight = '';
    }
    
    // 再次确保没有置灰效果
    removeDisabledGroupClass();
    
    // 显示加载提示
    toastr.info('正在设置组名称，请稍候...');

    // 获取现有问题和答案
    fetch('/api/knowledge/nas_question')
        .then(response => response.json())
        .then(currentData => {
            const data = {
                storage: {
                    name: storageName,
                    question: currentData.storage?.question || '请输入存储组访问密码:',
                    answer: currentData.storage?.answer || 'admin'
                },
                performance: {
                    name: performanceName,
                    question: currentData.performance?.question || '请输入性能专项组访问密码:',
                    answer: currentData.performance?.answer || 'admin'
                }
            };

            // 如果有其他自定义组，保留它们
            Object.keys(currentData).forEach(key => {
                if (key !== 'storage' && key !== 'performance') {
                    data[key] = currentData[key];
                }
            });

            // 保存设置
            return fetch('/api/knowledge/nas_question', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            });
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // 更新组名称显示
            setTimeout(() => {
                    if (document.getElementById('storage-group-name')) {
                        document.getElementById('storage-group-name').textContent = storageName;
                    }
                    if (document.getElementById('performance-group-name')) {
                        document.getElementById('performance-group-name').textContent = performanceName;
                    }
                    
                    // 确保页面状态正常，移除所有可能的残留
                    removeDisabledGroupClass();
                    document.querySelectorAll('.modal-backdrop').forEach(backdrop => backdrop.remove());
                    document.body.classList.remove('modal-open');
                    document.body.style.removeProperty('padding-right');
                    document.body.style.overflow = '';
                    
                    toastr.success('组名称设置成功');
            }, 100);
        } else {
                toastr.error(data.message || '设置失败');
            }
            
            // 无论成功与否都确保移除置灰效果
            removeDisabledGroupClass();
            document.querySelectorAll('.modal-backdrop').forEach(backdrop => backdrop.remove());
            document.body.classList.remove('modal-open');
            document.body.style.removeProperty('padding-right');
            document.body.style.overflow = '';
    })
    .catch(error => {
            toastr.error('设置组名称时发生错误');
        console.error('Error:', error);
            
            // 发生错误时也确保移除置灰效果
            removeDisabledGroupClass();
            document.querySelectorAll('.modal-backdrop').forEach(backdrop => backdrop.remove());
            document.body.classList.remove('modal-open');
            document.body.style.removeProperty('padding-right');
            document.body.style.overflow = '';
        });
}

// 标记是否使用模拟数据
let USE_MOCK_DATA = false;

// 模拟数据
const MOCK_DATA = {
    scripts: {
        "/scripts": {
            directories: [],
            scripts: []
        }
    }
};

// 批量操作变量
let selectedScriptPath = null; // 当前选中的脚本路径
let selectedDevices = []; // 当前选中的设备列表
let deviceInfoCache = {}; // 设备信息缓存 {deviceId: {ip, username, password, sshPort, ...}}
let currentScriptDir = "/scripts"; // 当前打开的脚本目录
let currentUploadDir = "/scripts"; // 当前上传目录
let selectedDirectory = null; // 当前选中的目录路径（用于部署）

// 批量操作标签被激活时加载设备列表和脚本列表
document.addEventListener('DOMContentLoaded', function() {
    // 从localStorage加载设备信息
    loadDevicesFromStorage();
    
    // 如果没有设备，添加一个测试设备
    if (Object.keys(deviceInfoCache).length === 0) {
        // 添加一个默认测试设备
        const testDeviceId = 'device-' + new Date().getTime();
        deviceInfoCache[testDeviceId] = {
            id: testDeviceId,
            type: 'storage',
            ip: '192.168.1.100',
            username: 'admin',
            password: 'password',
            sshPort: 22,
            brand: '测试设备',
            model: 'TestNAS'
        };
        saveDevicesToStorage();
        console.log('添加了一个测试设备');
    }
    
    // 监听批量操作标签点击
    document.querySelectorAll('a[href="#batchOperation"]').forEach(tab => {
        tab.addEventListener('shown.bs.tab', function (e) {
            loadScriptList();
            loadDevicesForBatch();
            
            // 设置安全警告5秒后自动消失
            setTimeout(function() {
                const securityWarning = document.getElementById('batch-security-warning');
                if (securityWarning) {
                    const bsAlert = new bootstrap.Alert(securityWarning);
                    bsAlert.close();
                }
            }, 5000);
        });
    });
});

// 从localStorage加载设备信息
function loadDevicesFromStorage() {
    try {
        const savedDevices = localStorage.getItem('batchOperationDevices');
        if (savedDevices) {
            deviceInfoCache = JSON.parse(savedDevices);
            console.log('已从localStorage加载', Object.keys(deviceInfoCache).length, '台设备');
        }
    } catch (e) {
        console.error('加载保存的设备信息失败', e);
        deviceInfoCache = {};
    }
}

// 保存设备信息到localStorage
function saveDevicesToStorage() {
    try {
        localStorage.setItem('batchOperationDevices', JSON.stringify(deviceInfoCache));
        console.log('已保存', Object.keys(deviceInfoCache).length, '台设备到localStorage');
    } catch (e) {
        console.error('保存设备信息失败', e);
        toastr.warning('设备信息保存失败，刷新页面后可能丢失');
    }
}

// 加载脚本列表
function loadScriptList() {
    const scriptTree = document.getElementById('script-tree');
    scriptTree.innerHTML = '<div class="text-center p-3"><i class="fas fa-spinner fa-spin me-2"></i>加载中...</div>';
    
    console.log('加载脚本目录:', currentScriptDir);
    
    // 直接从服务器加载目录结构
    const dirPath = currentScriptDir.replace('/scripts/', '');
    
    fetch(`/scripts/list?path=${encodeURIComponent(dirPath)}`)
        .then(response => {
            if (!response.ok) {
                throw new Error('获取脚本列表失败: ' + response.status);
            }
            return response.json();
        })
        .then(data => {
            console.log('脚本列表:', data);
            
            // 转换为我们的格式
            const formattedData = {
                directories: data.directories || [],
                scripts: data.scripts || []
            };
            
            // 渲染脚本树
            renderScriptTree(formattedData);
        })
        .catch(error => {
            console.error('加载脚本列表失败:', error);
            console.warn('使用空目录结构');
            
            // 使用空目录结构
            const emptyData = {
                directories: [],
                scripts: []
            };
            
            renderScriptTree(emptyData);
        });
}

// 切换模拟数据
function toggleMockData(enabled) {
    USE_MOCK_DATA = enabled;
    toastr.info(`已${enabled ? '启用' : '禁用'}模拟数据模式`);
    loadScriptList();
}

// 渲染脚本树
function renderScriptTree(data) {
    const scriptTree = document.getElementById('script-tree');
    if (!data || (!data.directories && !data.scripts) || (data.directories.length === 0 && data.scripts.length === 0)) {
        scriptTree.innerHTML = `
            <div class="alert alert-info">
                <i class="fas fa-info-circle me-2"></i>
                当前目录为空，请创建目录或上传脚本文件。
            </div>
            <div class="d-flex justify-content-center">
                <button class="btn btn-outline-success btn-sm me-2" onclick="showCreateDirModal('${currentScriptDir}')">
                    <i class="fas fa-folder-plus me-1"></i> 创建目录
                </button>
                <button class="btn btn-outline-primary btn-sm" onclick="showUploadModal('${currentScriptDir}')">
                    <i class="fas fa-upload me-1"></i> 上传脚本
                </button>
            </div>
        `;
        return;
    }
    
    let html = `<ul class="ps-0">`;
    
    // 显示当前路径和返回上级
    if (currentScriptDir !== "/scripts") {
        const parentDir = currentScriptDir.substring(0, currentScriptDir.lastIndexOf('/')) || '/scripts'; // Ensure parent is at least /scripts
        html += `
            <li>
                <div class="dir-item" onclick="navigateScriptDir('${parentDir}')">
                    <i class="fas fa-arrow-up me-1"></i>
                    返回上级目录
                </div>
            </li>
        `;
    }
    
    // 渲染子目录
    if (data.directories && data.directories.length > 0) {
        data.directories.forEach(dir => {
            const dirPath = currentScriptDir + '/' + dir;
            const isSelected = selectedDirectory === dirPath; // 恢复目录选择状态判断
            html += `
                <li>
                    <div class="dir-item d-flex justify-content-between align-items-center">
                        <span onclick="navigateScriptDir('${dirPath}')">
                            <i class="fas fa-folder me-1"></i>${dir}
                        </span>
                        <div>
                            <button class="btn btn-sm btn-outline-primary me-1" onclick="event.stopPropagation(); selectDirectoryForDeploy('${dirPath}')">
                                <i class="fas fa-${isSelected ? 'check' : 'upload'}"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="event.stopPropagation(); confirmDeleteItem('${dirPath}', true)">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </div>
                    </div>
                </li>
            `;
        });
    }
    
    // 渲染脚本文件 - Make the entire item clickable for selection
    if (data.scripts && data.scripts.length > 0) {
        data.scripts.forEach(script => {
            const scriptPath = currentScriptDir + '/' + script;
            const isSelected = selectedScriptPath === scriptPath;
            html += `
                <li>
                    <div class="script-item d-flex justify-content-between align-items-center ${isSelected ? 'selected-script' : ''}"
                         data-path="${scriptPath}"
                         onclick="toggleScriptSelection('${scriptPath}')">  <!-- Use toggleScriptSelection -->
                        <span>
                            <i class="fas fa-file-code me-1"></i>${script}
                        </span>
                        <button class="btn btn-sm btn-outline-danger" onclick="event.stopPropagation(); confirmDeleteItem('${scriptPath}', false)">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </div>
                </li>
            `;
        });
    }
    
    html += `</ul>`;
    
    // 显示当前目录路径
    html = `
        <div class="mb-2 ps-1 text-secondary">
            <small><i class="fas fa-folder-open me-1"></i>当前目录: ${currentScriptDir}</small>
        </div>
    ` + html;
    
    // 添加目录操作按钮
    html += `
        <div class="mt-3 d-flex justify-content-around border-top pt-3">
            <button class="btn btn-outline-success btn-sm" onclick="showCreateDirModal('${currentScriptDir}')">
                <i class="fas fa-folder-plus me-1"></i> 创建目录
            </button>
            <button class="btn btn-outline-primary btn-sm" onclick="showUploadModal('${currentScriptDir}')">
                <i class="fas fa-upload me-1"></i> 上传脚本
            </button>
        </div>
    `;
    
    scriptTree.innerHTML = html;
    updateActionStatus(); // Update status after rendering
}

// 导航到脚本目录
function navigateScriptDir(dirPath) {
    console.log('导航到目录:', dirPath);
    currentScriptDir = dirPath;
    // selectedScriptPath = null; // Deselect script when navigating
    // selectedDirectory = null; // Deselect directory when navigating
    loadScriptList();
}

// 确认删除项目
function confirmDeleteItem(path, isDirectory) {
    const itemType = isDirectory ? '目录' : '脚本';
    const itemName = path.split('/').pop();
    
    if (confirm(`确定要删除${itemType} "${itemName}" 吗？`)) {
        console.log('删除' + itemType + ':', path);
        toastr.info(`正在删除${itemType} ${itemName}...`, { timeOut: 0 });

        // 调用删除API
        fetch(`/api/knowledge/scripts`, { // 修改为正确的API端点
            method: 'DELETE', // 使用DELETE方法
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                path: path, // 不要修改路径格式
                isDirectory: isDirectory // 确保后端能区分目录和文件
            })
        })
        .then(response => {
             if (!response.ok) {
                 return response.json().then(err => { throw new Error(err.message || '删除失败'); });
             }
            return response.json();
        })
        .then(data => {
            console.log('删除结果:', data);
            toastr.clear();
             if (data.success) {
                 toastr.success(`${itemType} ${itemName} 已删除`);
                 // 刷新当前目录
                 loadScriptList();
             } else {
                 toastr.error(`删除失败: ${data.message}`);
             }
        })
        .catch(error => {
            console.error('删除失败:', error);
            toastr.clear();
            toastr.error(`删除失败: ${error.message}`);
        });
    }
}

// 删除脚本或目录
function deleteScriptItem(path, isDirectory) {
    if (USE_MOCK_DATA) {
        // 模拟删除操作
        setTimeout(() => {
            const pathParts = path.split('/');
            const itemName = pathParts.pop();
            const parentPath = pathParts.join('/');
            
            // 更新模拟数据
            if (isDirectory) {
                // 删除目录及其所有内容
                delete MOCK_DATA.scripts[path];
                // 从父目录中移除
                if (MOCK_DATA.scripts[parentPath]) {
                    MOCK_DATA.scripts[parentPath].directories = MOCK_DATA.scripts[parentPath].directories.filter(dir => dir !== itemName);
                }
                
                // 删除所有子目录
                Object.keys(MOCK_DATA.scripts).forEach(key => {
                    if (key.startsWith(path + '/')) {
                        delete MOCK_DATA.scripts[key];
                    }
                });
                
                toastr.success(`目录 ${itemName} 已删除（模拟）`);
            } else {
                // 删除文件
                if (MOCK_DATA.scripts[parentPath]) {
                    MOCK_DATA.scripts[parentPath].scripts = MOCK_DATA.scripts[parentPath].scripts.filter(script => script !== itemName);
                    toastr.success(`脚本 ${itemName} 已删除（模拟）`);
                }
            }
            
            // 如果删除的是当前选中的脚本，清除选择
            if (selectedScriptPath === path) {
                selectedScriptPath = null;
            }
            
            // 重新加载脚本列表
            loadScriptList();
        }, 500); // 模拟网络延迟
        return;
    }
    
    fetch('/api/knowledge/scripts', {
        method: 'DELETE',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            path: path,
            isDirectory: isDirectory
        })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('删除失败: ' + response.status);
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            toastr.success(`删除${isDirectory ? '目录' : '脚本'}成功`);
            
            // 如果删除的是当前选中的脚本，清除选择
            if (selectedScriptPath === path) {
                selectedScriptPath = null;
            }
            
            // 重新加载脚本列表
            loadScriptList();
        } else {
            toastr.error(data.message || '删除失败');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        toastr.error('删除时发生错误: ' + error.message);
        // 提示使用模拟模式
        if (confirm('后端API不可用，是否切换到模拟模式？')) {
            toggleMockData(true);
            // 重试操作
            deleteScriptItem(path, isDirectory);
        }
    });
}

// 显示创建目录模态框
function showCreateDirModal(dirPath) {
    // 清理和标准化路径
    let cleanPath = (dirPath || currentScriptDir || '/scripts');
    
    // 移除空白字符和特殊字符
    cleanPath = cleanPath.replace(/\s+/g, '').replace(/['"<>&]/g, '');
    
    // 修正/scripts/scripts问题
    if (cleanPath.includes('/scripts/scripts')) {
        // 从第二个/scripts开始获取子路径
        const parts = cleanPath.split('/scripts/', 2);
        if (parts.length > 1) {
            // 例如/scripts/scripts/test会变成/scripts/test
            cleanPath = '/scripts/' + parts[1];
        } else {
            // 如果就是/scripts/scripts，修正为/scripts
            cleanPath = '/scripts';
        }
    }
    
    // 移除连续的斜杠
    cleanPath = cleanPath.replace(/\/+/g, '/');
    console.log('创建目录父路径:', cleanPath);
    
    document.getElementById('parentDirectoryPath').value = cleanPath;
    document.getElementById('createDirName').value = '';
    
    // 显示模态框
    const modal = new bootstrap.Modal(document.getElementById('createDirModal'));
    modal.show();
}

// 创建目录
function createDirectory() {
    const dirName = document.getElementById('createDirName').value.trim(); // 使用正确的ID
    if (!dirName) {
        toastr.error('请输入目录名称');
        return;
    }

    // 验证目录名称格式
    if (!/^[a-zA-Z0-9_-]+$/.test(dirName)) {
        toastr.error('目录名称只能包含字母、数字、下划线和连字符');
        return;
    }

    const parentPath = document.getElementById('parentDirectoryPath').value; // 使用正确的ID
    console.log('创建目录父路径:', parentPath);

    // 构建完整的目录路径
    const fullPath = parentPath === '/scripts' ? 
        `${parentPath}/${dirName}` : 
        `${parentPath}/${dirName}`;

    // 发送创建目录请求
    fetch('/api/scripts/create_directory', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            parentPath: parentPath,
            dirName: dirName
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            toastr.success('目录创建成功');
            // 关闭模态框
            $('#createDirModal').modal('hide');
            // 清空输入框
            document.getElementById('createDirName').value = ''; // 清空正确的输入框
            // 立即刷新当前目录的列表
            loadScriptList(); // 直接刷新当前目录
            // 刷新目录选择器
            loadDirectoryStructure();
        } else {
            toastr.error(data.message || '创建目录失败');
        }
    })
    .catch(error => {
        console.error('创建目录失败:', error);
        toastr.error('创建目录失败: ' + error.message);
    });
}

// 显示上传脚本模态框
function showUploadModal(dirPath) {
    // 清理并标准化路径
    let cleanPath = (dirPath || currentScriptDir || '/scripts');
    
    // 移除所有空白字符并确保路径安全
    cleanPath = cleanPath.replace(/\\/g, '/').replace(/\s+/g, '').replace(/['"<>&]/g, '');
    
    // 确保路径以/scripts开头
    if (!cleanPath.startsWith('/scripts')) {
        cleanPath = '/scripts' + (cleanPath.startsWith('/') ? '' : '/') + cleanPath;
    }
    
    // 修正/scripts/scripts问题
    if (cleanPath.includes('/scripts/scripts')) {
        // 从第二个/scripts开始获取子路径
        const parts = cleanPath.split('/scripts/', 2);
        if (parts.length > 1) {
            // 例如/scripts/scripts/test会变成/scripts/test
            cleanPath = '/scripts/' + parts[1];
        } else {
            // 如果就是/scripts/scripts，修正为/scripts
            cleanPath = '/scripts';
        }
    }
    
    // 移除连续重复的斜杠
    cleanPath = cleanPath.replace(/\/+/g, '/');
    
    console.log('格式化后的上传目录路径:', cleanPath);
    
    currentUploadDir = cleanPath;
    document.getElementById('uploadDirectory').value = cleanPath;
    document.getElementById('currentUploadPath').textContent = cleanPath;
    
    // 清空上传状态和文件选择器
    document.getElementById('upload-status').innerHTML = '';
    document.getElementById('scriptFile').value = '';
    
    // 关闭目录选择器（如果之前打开）
    document.getElementById('directorySelectorArea').style.display = 'none';
    
    // 显示模态框
    const modal = new bootstrap.Modal(document.getElementById('uploadScriptModal'));
    modal.show();
}

// 选择上传目录
function selectUploadDirectory(dirPath) {
    // 清理目录路径，移除所有空白字符和特殊字符
    let cleanPath = dirPath.replace(/\s+/g, '').replace(/['"<>&]/g, '');
    
    // 修正两个scripts连在一起的情况 (scriptsscripts)
    cleanPath = cleanPath.replace(/scriptsscripts/g, 'scripts');
    
    // 修正/scripts/scripts问题
    if (cleanPath.includes('/scripts/scripts')) {
        // 从第二个/scripts开始获取子路径
        const parts = cleanPath.split('/scripts/', 2);
        if (parts.length > 1) {
            // 例如/scripts/scripts/test会变成/scripts/test
            cleanPath = '/scripts/' + parts[1];
        } else {
            // 如果就是/scripts/scripts，修正为/scripts
            cleanPath = '/scripts';
        }
    }
    
    // 移除连续重复的斜杠
    cleanPath = cleanPath.replace(/\/+/g, '/');
    
    console.log('选择的目录路径:', cleanPath);
    
    document.getElementById('uploadDirectory').value = cleanPath;
    document.getElementById('currentUploadPath').textContent = cleanPath;
    
    // 更新当前上传目录
    currentUploadDir = cleanPath;
    
    // 关闭目录选择器
    document.getElementById('directorySelectorArea').style.display = 'none';
}

// 显示目录选择器
function showDirectorySelector() {
    const selectorArea = document.getElementById('directorySelectorArea');
    
    // 切换显示状态
    if (selectorArea.style.display === 'none') {
        selectorArea.style.display = 'block';
        // 加载目录结构
        loadDirectoryStructure();
    } else {
        selectorArea.style.display = 'none';
    }
}

// 加载目录结构（用于选择上传目录）
function loadDirectoryStructure() {
    const directorySelector = document.getElementById('directorySelector');
    directorySelector.innerHTML = '<div class="text-center"><i class="fas fa-spinner fa-spin me-2"></i>加载目录结构...</div>';
    
    // 调用API获取目录结构
    fetch('/api/scripts/list_all_directories')
        .then(response => {
            if (!response.ok) {
                throw new Error('获取目录结构失败');
            }
            return response.json();
        })
        .then(data => {
            renderDirectoryStructure(data);
        })
        .catch(error => {
            console.error('加载目录结构失败', error);
            directorySelector.innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    加载目录结构失败: ${error.message}
                </div>
                <div class="mt-3 text-center">
                    <button class="btn btn-sm btn-outline-primary" onclick="loadDirectoryStructure()">
                        <i class="fas fa-sync-alt me-1"></i>重试
                    </button>
                </div>
            `;
        });
}

// 渲染目录结构
function renderDirectoryStructure(data) {
    const directorySelector = document.getElementById('directorySelector');
    
    // 检查API返回的数据格式并提取目录列表
    let directories = [];
    if (data.success && data.directories) {
        // 标准API返回的格式
        directories = data.directories.map(dir => {
            // 检查是对象还是字符串
            return typeof dir === 'object' ? dir.path : dir;
        });
    } else if (Array.isArray(data.directories)) {
        // 直接是数组的情况
        directories = data.directories;
    } else if (Array.isArray(data)) {
        // 直接是数组的情况
        directories = data;
    }
    
    // 处理目录路径，确保没有空格和特殊字符
    directories = directories.map(dir => {
        // 移除所有空白字符
        let cleanDir = dir.replace(/\s+/g, '');
        // 修正合并的scriptsscripts
        cleanDir = cleanDir.replace(/scriptsscripts/g, 'scripts');
        // 修正/scripts/scripts路径
        if (cleanDir.includes('/scripts/scripts')) {
            const parts = cleanDir.split('/scripts/', 2);
            if (parts.length > 1) {
                cleanDir = '/scripts/' + parts[1];
            } else {
                cleanDir = '/scripts';
            }
        }
        // 处理连续斜杠
        cleanDir = cleanDir.replace(/\/+/g, '/');
        return cleanDir;
    });
    
    // 移除重复的路径
    directories = [...new Set(directories)];
    
    console.log('处理后的目录列表:', directories);
    
    if (!directories || directories.length === 0) {
        directorySelector.innerHTML = `
            <div class="alert alert-info">
                <i class="fas fa-info-circle me-2"></i>
                没有找到任何目录
            </div>
            <div class="mt-3 text-center">
                <button class="btn btn-outline-success btn-sm" onclick="showCreateDirModal('/scripts')">
                    <i class="fas fa-folder-plus me-1"></i>创建目录
                </button>
            </div>
        `;
        return;
    }
    
    // 确保根目录存在
    if (!directories.includes('/scripts')) {
        directories.unshift('/scripts');
    }
    
    // 创建目录树
    let html = '<ul class="list-group">';
    
    // 确保根目录在最前面
    const sortedDirs = [...directories].sort((a, b) => {
        if (a === "/scripts") return -1;
        if (b === "/scripts") return 1;
        return a.localeCompare(b);
    });
    
    sortedDirs.forEach(dir => {
        // 编码目录名以防止XSS和HTML注入
        const safeDir = dir.replace(/['"<>&]/g, '');
        const displayDir = safeDir; // 显示给用户看的
        const isSelected = safeDir === document.getElementById('uploadDirectory').value;
        
        html += `
            <li class="list-group-item list-group-item-action ${isSelected ? 'active' : ''}" 
                style="cursor: pointer" 
                onclick="selectUploadDirectory('${safeDir}')">
                <i class="fas fa-folder me-2"></i>${displayDir}
            </li>
        `;
    });
    
    html += '</ul>';
    directorySelector.innerHTML = html;
}

// 上传脚本
function uploadScript() {
    // 获取表单元素值
    let uploadDirectory = document.getElementById('uploadDirectory').value;
    const scriptFileInput = document.getElementById('scriptFile');
    const scriptFile = scriptFileInput.files[0];
    const statusElement = document.getElementById('upload-status');
    
    // 验证选择了文件
    if (!scriptFile) {
        toastr.error('请选择要上传的脚本文件');
        return;
    }
    
    // 验证文件类型
    const allowedExtensions = ['.sh', '.py', '.bat', '.cmd', '.ps1'];
    const fileExtension = scriptFile.name.substring(scriptFile.name.lastIndexOf('.')).toLowerCase();
    if (!allowedExtensions.includes(fileExtension)) {
        toastr.error(`文件类型不允许，只支持以下类型: ${allowedExtensions.join(', ')}`);
        return;
    }
    
    // 标准化上传路径
    if (!uploadDirectory) {
        uploadDirectory = '/scripts';
    }
    
    // 确保路径使用正斜杠并去除所有空白字符
    uploadDirectory = uploadDirectory.replace(/\\/g, '/');
    uploadDirectory = uploadDirectory.replace(/\s+/g, ''); // 移除所有空格、制表符等空白字符
    uploadDirectory = uploadDirectory.replace(/['"<>&]/g, ''); // 移除特殊字符
    
    // 修正两个scripts连在一起的情况 (scriptsscripts)
    uploadDirectory = uploadDirectory.replace(/scriptsscripts/g, 'scripts');
    
    // 确保以/scripts开头
    if (!uploadDirectory.startsWith('/scripts')) {
        uploadDirectory = '/scripts' + (uploadDirectory.startsWith('/') ? '' : '/') + uploadDirectory;
    }
    
    // 修正/scripts/scripts问题
    if (uploadDirectory.includes('/scripts/scripts')) {
        // 从第二个/scripts开始获取子路径
        const parts = uploadDirectory.split('/scripts/', 2);
        if (parts.length > 1) {
            // 例如/scripts/scripts/test会变成/scripts/test
            uploadDirectory = '/scripts/' + parts[1];
        } else {
            // 如果就是/scripts/scripts，修正为/scripts
            uploadDirectory = '/scripts';
        }
    }
    
    // 移除连续重复的斜杠
    uploadDirectory = uploadDirectory.replace(/\/+/g, '/');
    
    console.log('格式化后的上传目录:', uploadDirectory);
    
    // 准备表单数据
    const formData = new FormData();
    formData.append('scriptFile', scriptFile);
    formData.append('uploadDirectory', uploadDirectory);
    
    // 显示上传状态
    toastr.info('正在上传脚本...');
    statusElement.innerHTML = `
        <div class="alert alert-info">
            <i class="fas fa-spinner fa-spin me-2"></i>
            <strong>正在上传脚本:</strong> ${scriptFile.name}
            <div>目标目录: ${uploadDirectory}</div>
        </div>
    `;

    // 使用原生XMLHttpRequest以便有更好的错误处理
    const xhr = new XMLHttpRequest();
    xhr.open('POST', '/api/scripts/handle_upload');
    
    xhr.onload = function() {
        let response;
        try {
            response = JSON.parse(xhr.responseText);
        } catch(e) {
            console.error('解析响应失败:', e);
            console.log('原始响应:', xhr.responseText.substr(0, 500) + '...');
            
            toastr.clear();
            toastr.error('服务器返回了无效的响应，请检查控制台日志');
            
            statusElement.innerHTML = `
                <div class="alert alert-danger">
                    <strong>上传失败 - 无效响应</strong>
                    <p>服务器返回了无法解析的数据。</p>
                    <p>可能原因:</p>
                    <ul>
                        <li>服务器内部错误</li>
                        <li>目录权限问题</li>
                        <li>文件名包含特殊字符</li>
                    </ul>
                    <p>请尝试使用不同的文件名或目录。</p>
                </div>
            `;
            return;
        }
        
        toastr.clear();
        
        if (xhr.status >= 200 && xhr.status < 300 && response.success) {
            toastr.success('脚本上传成功');
            
            // 关闭模态框
            const modal = bootstrap.Modal.getInstance(document.getElementById('uploadScriptModal'));
            if (modal) {
                modal.hide();
            }
            
            // 如果返回了目录路径，确保导航到正确的目录
            if (response.directory) {
                // 规范化目录路径
                let dirPath = response.directory;
                console.log('服务器返回的目录路径:', dirPath);
                
                // 修正路径格式
                // 特殊处理/scripts/scripts情况
                if (dirPath.includes('/scripts/scripts')) {
                    // 从第二个/scripts开始获取子路径
                    const parts = dirPath.split('/scripts/', 2);
                    if (parts.length > 1) {
                        // 例如/scripts/scripts/test会变成/scripts/test
                        dirPath = '/scripts/' + parts[1];
                    } else {
                        // 如果就是/scripts/scripts，修正为/scripts
                        dirPath = '/scripts';
                    }
                }
                
                // 移除连续的斜杠
                dirPath = dirPath.replace(/\/+/g, '/');
                console.log('格式化后的目录路径:', dirPath);
                
                // 导航到正确的目录
                if (currentScriptDir !== dirPath) {
                    console.log('导航到目录:', dirPath);
                    currentScriptDir = dirPath;
                    
                    // 强制刷新目录内容
                    setTimeout(() => {
                        loadScriptList();
                    }, 300);
                } else {
                    // 即使在相同目录，也需要刷新以显示新上传的文件
                    loadScriptList();
                }
            } else {
                // 没有返回目录路径，直接刷新当前目录
                loadScriptList();
            }
            
            // 清除状态信息
            statusElement.innerHTML = '';
        } else {
            const errorMsg = response.message || '未知错误';
            toastr.error(`上传失败: ${errorMsg}`);
            
            // 显示详细错误信息
            statusElement.innerHTML = `
                <div class="alert alert-danger">
                    <strong>上传失败</strong>
                    <p>${errorMsg}</p>
                    <p>请检查以下几点:</p>
                    <ol>
                        <li>上传目录是否存在</li>
                        <li>服务器是否有写入权限</li>
                        <li>文件名是否包含特殊字符</li>
                    </ol>
                </div>
            `;
        }
    };
    
    xhr.onerror = function() {
        console.error('上传请求失败');
        toastr.clear();
        toastr.error('网络错误，无法连接到服务器');
        
        statusElement.innerHTML = `
            <div class="alert alert-danger">
                <strong>网络错误</strong>
                <p>无法连接到服务器，请检查网络连接。</p>
            </div>
        `;
    };
    
    xhr.send(formData);
}

// 加载用于批量操作的设备列表
function loadDevicesForBatch() {
    const deviceGrid = document.getElementById('device-grid');
    deviceGrid.innerHTML = '<div class="text-center p-3"><i class="fas fa-spinner fa-spin me-2"></i>加载中...</div>';
    
    // 使用缓存的设备信息渲染网格
    const devices = Object.values(deviceInfoCache);
    
    // 等待一点时间以显示加载动画
    setTimeout(() => {
        renderDeviceGrid(devices);
        
        // 更新部署状态信息
        updateDeploymentStatus();
    }, 300);
}

// 切换设备选择状态
function toggleDeviceSelection(deviceId) {
    console.log("切换设备选择", deviceId);
    const deviceInfo = deviceInfoCache[deviceId];
    if (!deviceInfo) {
        console.error('设备信息未找到:', deviceId);
        return;
    }
    
    // 防止按钮点击事件冒泡
    if (event && event.target && (event.target.closest('.btn') || event.target.closest('.device-actions'))) {
        console.log("点击了按钮，不切换设备选择状态");
        return;
    }
    
    const deviceElement = document.getElementById(`device-${deviceId}`);
    const index = selectedDevices.findIndex(d => d.id === deviceId);
    
    if (index >= 0) {
        // 设备已选中，取消选择
        console.log("取消选择设备:", deviceId);
        selectedDevices.splice(index, 1);
        deviceElement.classList.remove('selected');
    } else {
        // 设备未选中，添加选择
        console.log("选择设备:", deviceId);
        selectedDevices.push(deviceInfo);
        deviceElement.classList.add('selected');
    }
    
    // 更新操作状态提示
    updateActionStatus();
    
    // 如果有选中的目录，更新部署状态
    if (selectedDirectory) {
        updateDeploymentStatus();
    }
}

// 更新操作状态提示
function updateActionStatus() {
    console.log("更新操作状态，脚本:", selectedScriptPath, "目录:", selectedDirectory);
    const statusElement = document.getElementById('batch-action-status');
    let statusText = '';
    
    // 获取部署脚本按钮并重置其状态
    const deployScriptBtn = document.getElementById('deployScriptBtn');
    const runScriptBtn = document.getElementById('runScriptBtn');
    
    if (deployScriptBtn) {
        // 根据是否有脚本被选中和设备被选中来启用/禁用按钮
        deployScriptBtn.disabled = !(selectedScriptPath && selectedDevices.length > 0);
    }
    
    if (runScriptBtn) {
        // 根据是否有脚本被选中和设备被选中来启用/禁用按钮
        runScriptBtn.disabled = !(selectedScriptPath && selectedDevices.length > 0);
    }
    
    // 根据当前选择的是脚本还是目录，显示对应的部署区域
    const scriptDeploySection = document.getElementById('script-deploy-section');
    const directoryDeploySection = document.getElementById('directory-deploy-section');
    
    if (selectedScriptPath) {
        // 显示脚本部署区域，隐藏目录部署区域
        if (scriptDeploySection) scriptDeploySection.style.display = 'block';
        if (directoryDeploySection) directoryDeploySection.style.display = 'none';
    } else if (selectedDirectory) {
        // 显示目录部署区域，隐藏脚本部署区域
        if (scriptDeploySection) scriptDeploySection.style.display = 'none';
        if (directoryDeploySection) directoryDeploySection.style.display = 'block';
    } else {
        // 都未选择时，默认显示脚本部署区域
        if (scriptDeploySection) scriptDeploySection.style.display = 'block';
        if (directoryDeploySection) directoryDeploySection.style.display = 'none';
    }
    
    // 更新状态文本
    if (!selectedScriptPath && !selectedDirectory) {
        statusText = '<span class="text-warning"><i class="fas fa-exclamation-triangle me-1"></i>请先选择一个脚本或目录</span>';
    } else if (selectedDevices.length === 0) {
        if (selectedScriptPath) {
            const scriptName = selectedScriptPath.split('/').pop();
            statusText = `<span class="text-info"><i class="fas fa-info-circle me-1"></i>已选择脚本: ${scriptName}, 请选择要操作的设备</span>`;
        } else {
            const dirName = selectedDirectory.split('/').pop();
            statusText = `<span class="text-info"><i class="fas fa-info-circle me-1"></i>已选择目录: ${dirName}, 请选择要操作的设备</span>`;
        }
    } else {
        if (selectedScriptPath) {
            const scriptName = selectedScriptPath.split('/').pop();
            statusText = `<span class="text-success"><i class="fas fa-check-circle me-1"></i>已选择脚本: ${scriptName}, 已选择 ${selectedDevices.length} 台设备, 可以开始操作</span>`;
        } else if (selectedDirectory) {
            const dirName = selectedDirectory.split('/').pop();
            statusText = `<span class="text-success"><i class="fas fa-check-circle me-1"></i>已选择目录: ${dirName}, 已选择 ${selectedDevices.length} 台设备, 可以开始操作</span>`;
        } else {
            statusText = '<span class="text-info"><i class="fas fa-info-circle me-2"></i>请先选择要部署的脚本或目录以及目标设备。</span>';
        }
    }
    
    statusElement.innerHTML = statusText;
}

// 显示编辑设备模态框
function showEditDeviceModal(deviceId) {
    const deviceInfo = deviceInfoCache[deviceId];
    if (!deviceInfo) {
        console.error('设备信息未找到:', deviceId);
        return;
    }
    
    // 填充表单
    document.getElementById('editDeviceIdEnhanced').value = deviceInfo.id;
    document.getElementById('editDeviceTypeEnhanced').value = deviceInfo.type;
    document.getElementById('editDeviceIPEnhanced').value = deviceInfo.ip;
    document.getElementById('editDeviceUsernameEnhanced').value = deviceInfo.username || '';
    document.getElementById('editDevicePasswordEnhanced').value = deviceInfo.password || '';
    document.getElementById('editDeviceSshPortEnhanced').value = deviceInfo.sshPort || 22;
    
    // 可选字段
    if (deviceInfo.brand) {
        document.getElementById('editDeviceBrandEnhanced').value = deviceInfo.brand;
    }
    if (deviceInfo.model) {
        document.getElementById('editDeviceModelEnhanced').value = deviceInfo.model;
    }
    
    // 显示模态框
    const modal = new bootstrap.Modal(document.getElementById('editDeviceModalEnhanced'));
    modal.show();
}

// 保存编辑后的设备信息
function submitEditDeviceEnhanced() {
    const deviceId = document.getElementById('editDeviceIdEnhanced').value;
    const deviceType = document.getElementById('editDeviceTypeEnhanced').value;
    const ip = document.getElementById('editDeviceIPEnhanced').value;
    const username = document.getElementById('editDeviceUsernameEnhanced').value;
    const password = document.getElementById('editDevicePasswordEnhanced').value;
    const sshPort = document.getElementById('editDeviceSshPortEnhanced').value;
    const brand = document.getElementById('editDeviceBrandEnhanced').value;
    const model = document.getElementById('editDeviceModelEnhanced').value;
    
    // 验证必填字段
    if (!ip || !username || !password || !sshPort) {
        toastr.error('请填写所有必填字段');
        return;
    }
    
    // 更新缓存中的设备信息
    deviceInfoCache[deviceId] = {
        ...deviceInfoCache[deviceId],
        ip,
        username,
        password,
        sshPort: parseInt(sshPort),
        brand,
        model
    };
    
    // 保存到localStorage
    saveDevicesToStorage();
    
    // 如果设备在选中列表中，也更新选中列表
    const selectedIndex = selectedDevices.findIndex(d => d.id === deviceId);
    if (selectedIndex >= 0) {
        selectedDevices[selectedIndex] = deviceInfoCache[deviceId];
    }
    
    // 更新UI中的设备IP显示
    const deviceElement = document.getElementById(`device-${deviceId}`);
    if (deviceElement) {
        const ipDisplay = deviceElement.querySelector('div');
        if (ipDisplay) {
            // 清空当前内容后再设置，避免重复
            ipDisplay.innerHTML = '';
            ipDisplay.textContent = ip;
        }
    }
    
    // 关闭模态框
    const modal = bootstrap.Modal.getInstance(document.getElementById('editDeviceModalEnhanced'));
    if (modal) {
        modal.hide();
    }
    
    toastr.success('设备信息已更新');
}

// 部署选中脚本到设备
function deploySelectedScriptToDevices() {
    // 直接调用已有的部署函数
    deploySelectedScript();
}

// 部署选中脚本
function deploySelectedScript() {
    if (!validateSelections()) {
        return;
    }
    
    // 获取脚本文件名
    const scriptName = selectedScriptPath.split('/').pop();
    
    // 设置操作状态
    const statusElement = document.getElementById('batch-action-status');
    statusElement.innerHTML = `<span class="text-primary"><i class="fas fa-spinner fa-spin me-1"></i>正在将脚本 ${scriptName} 部署到 ${selectedDevices.length} 台设备, 请稍候...</span>`;
    
    if (USE_MOCK_DATA) {
        // 模拟部署脚本
        setTimeout(() => {
            // 模拟部署结果
            const results = [];
            let hasError = false;
            
            // 随机生成一些成功和失败的结果
            selectedDevices.forEach(device => {
                const success = Math.random() > 0.2; // 80%成功率
                results.push({
                    ip: device.ip,
                    success: success,
                    message: success ? undefined : '模拟错误：连接超时'
                });
                
                if (!success) {
                    hasError = true;
                }
            });
            
            // 更新状态
            statusElement.innerHTML = `<span class="text-success"><i class="fas fa-check-circle me-1"></i>脚本 ${scriptName} 已部署（模拟）</span>`;
            
            // 显示详细结果
            let resultDetails = '<div class="mt-3 alert alert-info"><strong>部署结果详情（模拟）:</strong><ul class="mb-0">';
            
            results.forEach(result => {
                if (result.success) {
                    resultDetails += `<li>${result.ip}: 部署成功</li>`;
                } else {
                    resultDetails += `<li class="text-danger">${result.ip}: 部署失败 - ${result.message}</li>`;
                }
            });
            
            resultDetails += '</ul></div>';
            
            if (hasError) {
                toastr.warning('部分设备部署失败，请查看详情（模拟）');
            } else {
                toastr.success('所有设备部署成功（模拟）');
            }
            
            // 显示详情
            document.getElementById('batch-action-status').insertAdjacentHTML('beforeend', resultDetails);
        }, 1500); // 模拟较长的网络延迟
        return;
    }
    
    // 准备部署参数
    const deployData = {
        scriptPath: selectedScriptPath,
        targetPath: '/test',  // 添加目标路径参数
        devices: selectedDevices.map(device => ({
            id: device.id,
            ip: device.ip,
            username: device.username,
            password: device.password,
            sshPort: device.sshPort || 22
        }))
    };
    
    // 调用后端API部署脚本
    fetch('/api/knowledge/scripts/deploy', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(deployData)
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('部署脚本失败: ' + response.status);
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            statusElement.innerHTML = `<span class="text-success"><i class="fas fa-check-circle me-1"></i>脚本 ${scriptName} 已成功部署到所有设备</span>`;
            
            // 显示详细结果
            let resultDetails = '';
            let hasError = false;
            
            if (data.results && data.results.length > 0) {
                resultDetails = '<div class="mt-3 alert alert-info"><strong>部署结果详情:</strong><ul class="mb-0">';
                
                data.results.forEach(result => {
                    if (result.success) {
                        resultDetails += `<li>${result.ip}: 部署成功</li>`;
                    } else {
                        hasError = true;
                        resultDetails += `<li class="text-danger">${result.ip}: 部署失败 - ${result.message}</li>`;
                    }
                });
                
                resultDetails += '</ul></div>';
            }
            
            if (hasError) {
                toastr.warning('部分设备执行失败，请查看详情');
            } else {
                toastr.success('所有设备执行成功');
            }
            
            // 显示详情
            if (resultDetails) {
                document.getElementById('batch-action-status').insertAdjacentHTML('beforeend', resultDetails);
            }
        } else {
            statusElement.innerHTML = `<span class="text-danger"><i class="fas fa-times-circle me-1"></i>执行失败: ${data.message || '未知错误'}</span>`;
            toastr.error(data.message || '执行脚本失败');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        statusElement.innerHTML = `<span class="text-danger"><i class="fas fa-times-circle me-1"></i>执行出错: ${error.message}</span>`;
        toastr.error('执行脚本时发生错误: ' + error.message);
        // 提示使用模拟模式
        if (confirm('后端API不可用，是否切换到模拟模式？')) {
            toggleMockData(true);
            // 重试操作
            deploySelectedScript();
        }
    });
}

// 验证是否已选择脚本和设备
function validateSelections() {
    if (!selectedScriptPath) {
        toastr.error('请先选择一个脚本');
        return false;
    }
    
    if (selectedDevices.length === 0) {
        toastr.error('请选择至少一台设备');
        return false;
    }
    
    return true;
}

// 执行选中脚本
function executeSelectedScript() {
    if (!validateSelections()) {
        return;
    }
    
    // 获取脚本文件名和路径
    const scriptName = selectedScriptPath.split('/').pop();
    
    // 显示模态框并填充数据
    document.getElementById('scriptPathDisplay').value = selectedScriptPath;
    document.getElementById('commandParams').value = '';
    document.getElementById('commandPreview').value = `./${scriptName}`;
    document.getElementById('useRootCheck').checked = false;
    
    // 监听参数变化实时更新命令预览
    document.getElementById('commandParams').addEventListener('input', updateCommandPreview);
    document.getElementById('useRootCheck').addEventListener('change', updateCommandPreview);
    
    // 显示模态框
    const modal = new bootstrap.Modal(document.getElementById('setCommandModal'));
    modal.show();
}

// 更新命令预览
function updateCommandPreview() {
    const scriptName = selectedScriptPath.split('/').pop();
    const params = document.getElementById('commandParams').value;
    const useRoot = document.getElementById('useRootCheck').checked;
    
    let command = '';
    if (useRoot) {
        command = `sudo ./${scriptName}`;
    } else {
        command = `./${scriptName}`;
    }
    
    if (params) {
        command += ` ${params}`;
    }
    
    document.getElementById('commandPreview').value = command;
}

// 确认执行命令
function confirmExecution() {
    // 获取命令参数
    const params = document.getElementById('commandParams').value;
    const useRoot = document.getElementById('useRootCheck').checked;
    
    // 关闭模态框
    const modal = bootstrap.Modal.getInstance(document.getElementById('setCommandModal'));
    if (modal) {
        modal.hide();
    }
    
    // 执行脚本
    executeScriptWithParams(params, useRoot);
}

// 执行带参数的脚本
function executeScriptWithParams(params, useRoot) {
    // 获取脚本文件名
    const scriptName = selectedScriptPath.split('/').pop();
    
    // 设置操作状态
    const statusElement = document.getElementById('batch-action-status');
    statusElement.innerHTML = `<span class="text-primary"><i class="fas fa-spinner fa-spin me-1"></i>正在执行脚本 ${scriptName} 于 ${selectedDevices.length} 台设备, 请稍候...</span>`;
    
    if (USE_MOCK_DATA) {
        // 模拟执行脚本
        setTimeout(() => {
            // 模拟执行结果
            const results = [];
            let hasError = false;
            
            // 随机生成一些成功和失败的结果
            selectedDevices.forEach(device => {
                const success = Math.random() > 0.15; // 85%成功率
                results.push({
                    ip: device.ip,
                    success: success,
                    message: success ? undefined : '模拟错误：命令执行失败',
                    output: success ? `模拟输出: 在设备 ${device.ip} 上执行 ${scriptName} ${params ? params : ''}${useRoot ? ' (使用root权限)' : ''} 成功\n系统信息:\nCPU: 4核\n内存: 8GB\n存储: 500GB\n执行时间: ${Math.round(Math.random() * 10 + 1)}秒` : undefined
                });
                
                if (!success) {
                    hasError = true;
                }
            });
            
            // 更新状态
            statusElement.innerHTML = `<span class="text-success"><i class="fas fa-check-circle me-1"></i>脚本 ${scriptName} 已执行（模拟）</span>`;
            
            // 显示详细结果
            let resultDetails = '<div class="mt-3 alert alert-info"><strong>执行结果详情（模拟）:</strong><ul class="mb-0">';
            
            results.forEach(result => {
                if (result.success) {
                    resultDetails += `<li>${result.ip}: 执行成功</li>`;
                    if (result.output) {
                        resultDetails += `<pre class="small bg-light p-2 mb-2">${result.output}</pre>`;
                    }
                } else {
                    resultDetails += `<li class="text-danger">${result.ip}: 执行失败 - ${result.message}</li>`;
                }
            });
            
            resultDetails += '</ul></div>';
            
            if (hasError) {
                toastr.warning('部分设备执行失败，请查看详情（模拟）');
            } else {
                toastr.success('所有设备执行成功（模拟）');
            }
            
            // 显示详情
            document.getElementById('batch-action-status').insertAdjacentHTML('beforeend', resultDetails);
        }, 2000); // 模拟较长的网络延迟
        return;
    }
    
    // 准备执行参数
    const executeData = {
        scriptPath: selectedScriptPath,
        params: params,
        useRoot: useRoot,
        devices: selectedDevices.map(device => ({
            id: device.id,
            ip: device.ip,
            username: device.username,
            password: device.password,
            sshPort: device.sshPort || 22
        }))
    };
    
    // 调用后端API执行脚本
    fetch('/api/knowledge/scripts/execute', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(executeData)
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('执行脚本失败: ' + response.status);
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            statusElement.innerHTML = `<span class="text-success"><i class="fas fa-check-circle me-1"></i>脚本 ${scriptName} 已成功在所有设备上执行</span>`;
            
            // 显示详细结果
            let resultDetails = '';
            let hasError = false;
            
            if (data.results && data.results.length > 0) {
                resultDetails = '<div class="mt-3 alert alert-info"><strong>执行结果详情:</strong><ul class="mb-0">';
                
                data.results.forEach(result => {
                    if (result.success) {
                        resultDetails += `<li>${result.ip}: 执行成功</li>`;
                        if (result.output) {
                            resultDetails += `<pre class="small bg-light p-2 mb-2">${result.output}</pre>`;
                        }
                    } else {
                        hasError = true;
                        resultDetails += `<li class="text-danger">${result.ip}: 执行失败 - ${result.message}</li>`;
                    }
                });
                
                resultDetails += '</ul></div>';
            }
            
            if (hasError) {
                toastr.warning('部分设备执行失败，请查看详情');
            } else {
                toastr.success('所有设备执行成功');
            }
            
            // 显示详情
            if (resultDetails) {
                document.getElementById('batch-action-status').insertAdjacentHTML('beforeend', resultDetails);
            }
        } else {
            statusElement.innerHTML = `<span class="text-danger"><i class="fas fa-times-circle me-1"></i>执行失败: ${data.message || '未知错误'}</span>`;
            toastr.error(data.message || '执行脚本失败');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        statusElement.innerHTML = `<span class="text-danger"><i class="fas fa-times-circle me-1"></i>执行出错: ${error.message}</span>`;
        toastr.error('执行脚本时发生错误: ' + error.message);
        // 提示使用模拟模式
        if (confirm('后端API不可用，是否切换到模拟模式？')) {
            toggleMockData(true);
            // 重试操作
            executeScriptWithParams(params, useRoot);
        }
    });
}

// 显示添加设备模态框
function showAddDeviceModal() {
    // 清空表单
    document.getElementById('addDeviceFormBatch').reset();
    
    // 显示模态框
    const modal = new bootstrap.Modal(document.getElementById('addDeviceModalBatch'));
    modal.show();
}

// 提交添加设备表单
function submitAddDeviceBatch() {
    const ip = document.getElementById('addDeviceIPBatch').value;
    const sshPort = document.getElementById('addDeviceSshPortBatch').value;
    const username = document.getElementById('addDeviceUsernameBatch').value;
    const password = document.getElementById('addDevicePasswordBatch').value;
    const brand = document.getElementById('addDeviceBrandBatch').value;
    const model = document.getElementById('addDeviceModelBatch').value;
    
    // 验证必填字段
    if (!ip || !sshPort || !username || !password) {
        toastr.error('请填写所有必填字段');
        return;
    }
    
    // 创建一个唯一ID
    const deviceId = 'device_' + Date.now();
    
    // 创建设备对象
    const device = {
        id: deviceId,
        ip: ip,
        sshPort: parseInt(sshPort),
        username: username,
        password: password,
        brand: brand || '',
        model: model || ''
    };
    
    // 添加设备到内存缓存
    deviceInfoCache[deviceId] = device;
    
    // 保存到localStorage
    saveDevicesToStorage();
    
    // 关闭模态框
    const modal = bootstrap.Modal.getInstance(document.getElementById('addDeviceModalBatch'));
    if (modal) {
        modal.hide();
    }
    
    toastr.success('设备添加成功');
    
    // 重新渲染设备网格
    renderDeviceGrid(Object.values(deviceInfoCache));
}

// 渲染设备网格
function renderDeviceGrid(devices) {
    const deviceGrid = document.getElementById('device-grid');
    
    if (!devices || devices.length === 0) {
        deviceGrid.innerHTML = `
            <div class="alert alert-info">
                <i class="fas fa-info-circle me-2"></i>
                没有找到任何设备，请点击"添加设备"按钮添加设备。
            </div>
        `;
        return;
    }
    
    let html = '<div class="device-grid-container">';
    devices.forEach(device => {
        html += createDeviceTemplate(device);
    });
    html += '</div>';
    
    deviceGrid.innerHTML = html;
    
    // 更新操作状态提示
    updateActionStatus();
}

// 删除设备
function deleteDevice(deviceId) {
    if (confirm('确定要删除此设备吗？')) {
        // 从选中设备列表中移除
        const selectedIndex = selectedDevices.findIndex(d => d.id === deviceId);
        if (selectedIndex >= 0) {
            selectedDevices.splice(selectedIndex, 1);
        }
        
        // 从缓存中移除
        delete deviceInfoCache[deviceId];
        
        // 保存到localStorage
        saveDevicesToStorage();
        
        // 重新渲染设备网格
        toastr.success('设备已删除');
        renderDeviceGrid(Object.values(deviceInfoCache));
    }
}

// 提交创建目录
function submitCreateDir() {
    const parentPath = document.getElementById('parentDirPath').value;
    const newDirName = document.getElementById('newDirName').value.trim();
    
    if (!newDirName) {
        toastr.error('请输入目录名称');
        return;
    }
    
    // 验证目录名格式
    if (!/^[a-zA-Z0-9_\-]+$/.test(newDirName)) {
        toastr.error('目录名只能包含字母、数字、下划线和连字符');
        return;
    }
    
    // 显示创建中提示
    toastr.info(`正在创建目录 ${newDirName}...`, {timeOut: 0});
    
    // 构建完整路径
    const fullPath = parentPath + '/' + newDirName;
    
    // 关闭模态框
    const modal = bootstrap.Modal.getInstance(document.getElementById('createDirModal'));
    if (modal) {
        modal.hide();
    }
    
    // 尝试创建真实目录
    createRealDirectory(parentPath, newDirName);
}

// 创建真实目录（主要方法）
function createRealDirectory(parentPath, dirName) {
    console.log('尝试创建真实目录:', parentPath, dirName);
    toastr.info(`正在创建目录 ${dirName}...`, { timeOut: 0 });

    const fullPath = (parentPath + '/' + dirName);

    fetch('/api/scripts/create_directory', { 
        method: 'POST',
        headers: {
             'Content-Type': 'application/json'
        },
        body: JSON.stringify({
             path: fullPath // 后端需要能处理 /scripts/ 前缀
         })
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(err => { throw new Error(err.message || '创建目录失败'); });
        }
        return response.json();
    })
    .then(data => {
        console.log('创建目录结果:', data);
        toastr.clear();
         if (data.success) {
            toastr.success(`目录 ${dirName} 创建成功`);
             // 直接刷新当前目录列表 (parentPath应该等于currentScriptDir)
             loadScriptList(); 
         } else {
            toastr.error(`创建失败: ${data.message}`);
        }
    })
    .catch(error => {
        console.error('创建目录失败:', error);
        toastr.clear();
        toastr.error(`创建目录失败: ${error.message}`);
    });
}

// 选择目录用于部署
function selectDirectoryForDeploy(dirPath) {
    console.log("选择目录用于部署:", dirPath);
    
    // 检查是否取消选择已选中的目录
    if (selectedDirectory === dirPath) {
        console.log("取消选择目录:", dirPath);
        selectedDirectory = null;
        
        // 还原部署区域显示
        const scriptDeploySection = document.getElementById('script-deploy-section');
        const directoryDeploySection = document.getElementById('directory-deploy-section');
        
        if (scriptDeploySection) scriptDeploySection.style.display = 'block';
        if (directoryDeploySection) directoryDeploySection.style.display = 'none';
        
        // 恢复脚本树中的选中样式
        document.querySelectorAll('.directory-item').forEach(dir => {
            dir.classList.remove('active');
        });
        
        // 更新操作状态
        updateActionStatus();
        
        toastr.info(`已取消选择目录 ${dirPath.split('/').pop()}`);
        return;
    }
    
    // 记录选中的目录
    selectedDirectory = dirPath;
    
    // 清除选中的脚本
    selectedScriptPath = null;
    
    // 刷新UI以显示选中状态
    loadScriptList();
    
    // 更新脚本树中的选中样式
    document.querySelectorAll('.directory-item').forEach(dir => {
        if (dir.getAttribute('data-path') === dirPath) {
            dir.classList.add('active');
        } else {
            dir.classList.remove('active');
        }
    });
    
    // 显示选中的目录信息
    updateDeploymentStatus();
    
    // 隐藏脚本部署相关内容，显示目录部署相关内容
    const scriptDeploySection = document.getElementById('script-deploy-section');
    const directoryDeploySection = document.getElementById('directory-deploy-section');
    
    if (scriptDeploySection) scriptDeploySection.style.display = 'none';
    if (directoryDeploySection) directoryDeploySection.style.display = 'block';
    
    toastr.success(`已选择目录 ${dirPath.split('/').pop()} 用于部署`);
}

// 更新部署状态信息
function updateDeploymentStatus() {
    console.log("更新部署状态，当前目录:", selectedDirectory);
    const statusElement = document.getElementById('batch-action-status');
    
    // 恢复脚本部署的展示
    if (!selectedDirectory) {
        const scriptDeploySection = document.getElementById('script-deploy-section');
        const directoryDeploySection = document.getElementById('directory-deploy-section');
        
        if (scriptDeploySection) scriptDeploySection.style.display = 'block';
        if (directoryDeploySection) directoryDeploySection.style.display = 'none';
        
        statusElement.innerHTML = `
            <div class="alert alert-info">
                <i class="fas fa-info-circle me-2"></i>
                请先选择要部署的脚本或目录以及目标设备。
            </div>
        `;
        return;
    }
    
    // 检查部署按钮是否存在
    const deployBtn = document.getElementById('deployDirectoryBtn');
    
    if (selectedDevices.length === 0) {
        statusElement.innerHTML = `
            <div class="deployment-alert">
                <i class="fas fa-exclamation-triangle me-2"></i>
                已选择目录 <strong>${selectedDirectory}</strong> 用于部署，但尚未选择任何设备。
            </div>
            <div class="alert alert-info mt-2">
                请选择要部署到的设备。
            </div>
        `;
        
        // 禁用部署按钮 (如果存在)
        if (deployBtn) {
            deployBtn.disabled = true;
        }
        return;
    }
    
    // 显示已准备好的部署信息
    statusElement.innerHTML = `
        <div class="script-deploy-info">
            <div class="deployment-indicator">
                <i class="fas fa-clipboard-check me-2"></i>部署配置
            </div>
            <ul class="list-group list-group-flush">
                <li class="list-group-item bg-transparent">
                    <strong>源目录:</strong> ${selectedDirectory}
                </li>
                <li class="list-group-item bg-transparent">
                    <strong>目标设备:</strong> ${selectedDevices.length} 台
                    <ul class="mt-1">
                        ${selectedDevices.slice(0, 3).map(device => `<li>${device.ip}</li>`).join('')}
                        ${selectedDevices.length > 3 ? `<li>...以及其他 ${selectedDevices.length - 3} 台设备</li>` : ''}
                    </ul>
                </li>
                <li class="list-group-item bg-transparent">
                    <strong>目标目录:</strong> /test
                </li>
            </ul>
        </div>
        
        <!-- 添加部署按钮，确保按钮始终存在 -->
        <div class="mt-3">
            <button id="deployDirectoryBtn" class="btn btn-primary" onclick="deployDirectoryToDevices()">
                <i class="fas fa-upload me-1"></i>部署目录
            </button>
        </div>
    `;
    
    // 启用新创建的部署按钮
    const newDeployBtn = document.getElementById('deployDirectoryBtn');
    if (newDeployBtn) {
        newDeployBtn.disabled = false;
    }
}

// 部署目录到NAS设备
function deployDirectoryToDevices() {
    if (!selectedDirectory) {
        toastr.error('请先选择要部署的目录');
        return;
    }
    
    if (selectedDevices.length === 0) {
        toastr.error('请先选择要部署到的设备');
        return;
    }
    
    // 调试信息
    console.log('准备部署目录:', selectedDirectory, '到设备:', selectedDevices);
    
    // 显示部署配置模态框
    try {
        // 检查模态框元素是否存在
        const modalElement = document.getElementById('deploymentConfigModal');
        if (!modalElement) {
            throw new Error('找不到模态框元素');
        }
        
        // 检查输入框元素是否存在
        const sourceElement = document.getElementById('deploymentSourceDir');
        const targetElement = document.getElementById('deploymentTargetPath');
        
        if (!sourceElement || !targetElement) {
            console.error('无法找到模态框输入元素');
            throw new Error('模态框输入元素不存在');
        }
        
        // 设置模态框内容
        sourceElement.value = selectedDirectory;
        targetElement.value = '/test';
        
        // 显示模态框
        const modal = new bootstrap.Modal(modalElement);
        modal.show();
    } catch (error) {
        console.error('显示部署模态框出错:', error);
        toastr.error('显示部署配置时出错: ' + error.message);
        
        // 显示调试信息
        document.getElementById('batch-action-status').innerHTML = `
            <div class="alert alert-danger">
                <strong>错误：</strong> ${error.message}
                <div class="mt-2">
                    <button class="btn btn-sm btn-primary" onclick="enableMockDataMode()">启用模拟模式</button>
                </div>
            </div>
        `;
    }
}

// 启用模拟数据模式
function enableMockDataMode() {
    USE_MOCK_DATA = true;
    toastr.info('已启用模拟数据模式，现在可以测试功能');
    document.getElementById('batch-action-status').innerHTML = `
        <div class="alert alert-info">
            <i class="fas fa-info-circle me-2"></i>
            已启用模拟数据模式，可以继续测试部署功能
        </div>
    `;
}

// 显示部署配置模态框
function showDeploymentConfigModal() {
    document.getElementById('deploymentSourceDir').textContent = selectedDirectory;
    document.getElementById('deploymentTargetPath').value = '/test';
    
    // 显示模态框
    const modal = new bootstrap.Modal(document.getElementById('deploymentConfigModal'));
    modal.show();
}

// 确认部署
function confirmDeployment() {
    const sourceDir = document.getElementById('deploymentSourceDir').value.trim();
    const targetPath = document.getElementById('deploymentTargetPath').value.trim();
    
    if (!sourceDir) {
        toastr.error('源目录不能为空');
        return;
    }
    
    if (!targetPath) {
        toastr.error('请输入目标路径');
        return;
    }
    
    // 关闭模态框
    const modal = bootstrap.Modal.getInstance(document.getElementById('deploymentConfigModal'));
    if (modal) {
        modal.hide();
    }
    
    // 显示部署中提示
    const statusElement = document.getElementById('batch-action-status');
    statusElement.innerHTML = `
        <div class="alert alert-info">
            <i class="fas fa-spinner fa-spin me-2"></i>
            正在将目录 ${sourceDir} 部署到 ${selectedDevices.length} 台设备的 ${targetPath} 目录...
        </div>
    `;
    
    // 构建部署请求数据
    const deployData = {
        sourceDirectory: sourceDir.replace(/^\/scripts\/?/, ''),  // 移除开头的/scripts/
        targetPath: targetPath,
        devices: selectedDevices.map(device => ({
            id: device.id,
            ip: device.ip,
            username: device.username,
            password: device.password,
            sshPort: device.sshPort || 22
        }))
    };
    
    console.log('部署请求数据:', deployData);
    
    // 发送部署请求
    if (USE_MOCK_DATA) {
        // 模拟部署操作
        setTimeout(() => {
            const mockResults = selectedDevices.map(device => ({
                ip: device.ip,
                success: Math.random() > 0.3, // 70%成功率
                message: Math.random() > 0.3 ? '' : '模拟的部署错误'
            }));
            
            handleDeployResults({ success: true, results: mockResults });
        }, 2000);
        return;
    }
    
    fetch('/api/scripts/deploy', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(deployData)
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(err => { throw new Error(err.message || '部署请求失败'); });
        }
        return response.json();
    })
    .then(data => {
        console.log('部署结果:', data);
        handleDeployResults(data);
    })
    .catch(error => {
        console.error('部署失败:', error);
        statusElement.innerHTML = `
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-circle me-2"></i>
                部署失败: ${error.message}
            </div>
        `;
        toastr.error(`部署失败: ${error.message}`);
    });
}

// 处理部署结果
function handleDeployResults(data) {
    console.log('部署结果:', data);
    
    const statusElement = document.getElementById('batch-action-status');
    const targetPath = document.getElementById('deploymentTargetPath').value.trim() || '/test';
    
    // 显示部署结果
    let hasError = false;
    let resultHtml = '<div class="mt-3 alert alert-info"><strong>部署结果详情:</strong><ul class="mb-0">';
    
    data.results.forEach(result => {
        if (result.success) {
            resultHtml += `<li>${result.ip}: 部署成功</li>`;
        } else {
            hasError = true;
            resultHtml += `<li class="text-danger">${result.ip}: 部署失败 - ${result.message}</li>`;
        }
    });
    
    resultHtml += '</ul></div>';
    
    if (hasError) {
        statusElement.innerHTML = `
            <div class="alert alert-warning">
                <i class="fas fa-exclamation-triangle me-2"></i>
                部分设备部署失败，请查看详情。
            </div>
            ${resultHtml}
        `;
        toastr.warning('部分设备部署失败，请查看详情');
    } else {
        statusElement.innerHTML = `
            <div class="alert alert-success">
                <i class="fas fa-check-circle me-2"></i>
                目录 ${selectedDirectory} 已成功部署到所有设备的 ${targetPath} 目录。
            </div>
            ${resultHtml}
        `;
        toastr.success('部署成功');
    }
}

// 处理脚本行点击事件，实现单击选择脚本功能
function toggleScriptSelection(scriptPath) {
    console.log("切换脚本选择:", scriptPath);
    
    // 清除选中的目录
    if (selectedDirectory) {
        selectedDirectory = null;
        
        // 清除目录选中样式
        document.querySelectorAll('.directory-item').forEach(dir => {
            dir.classList.remove('active');
        });
    }
    
    // 如果已经选中了这个脚本，则取消选择
    if (selectedScriptPath === scriptPath) {
        console.log("取消选择脚本:", scriptPath);
        selectedScriptPath = null;
        
        // 移除所有脚本行的选中样式
        document.querySelectorAll('.script-row').forEach(row => {
            row.classList.remove('selected');
        });
    } else {
        // 设置新的选中脚本
        console.log("选择脚本:", scriptPath);
        selectedScriptPath = scriptPath;
        
        // 移除所有脚本行的选中样式
        document.querySelectorAll('.script-row').forEach(row => {
            row.classList.remove('selected');
        });
        
        // 给当前脚本行添加选中样式
        const scriptRow = document.querySelector(`.script-row[data-path="${scriptPath.replace(/"/g, '\\"')}"]`);
        if (scriptRow) {
            scriptRow.classList.add('selected');
        }
    }
    
    // 隐藏目录部署相关内容，显示脚本部署相关内容
    const scriptDeploySection = document.getElementById('script-deploy-section');
    const directoryDeploySection = document.getElementById('directory-deploy-section');
    
    if (scriptDeploySection) scriptDeploySection.style.display = 'block';
    if (directoryDeploySection) directoryDeploySection.style.display = 'none';
    
    // 更新操作状态
    updateActionStatus();
}

// 渲染脚本文件
function renderScriptItem(scriptName, path) {
    const scriptPath = path;
    const isSelected = selectedScriptPath === scriptPath;
    
    // 添加数据属性以便事件处理
    return `
        <div class="script-row ${isSelected ? 'selected' : ''}" data-path="${scriptPath}" onclick="toggleScriptSelection('${scriptPath}')">
            <div class="d-flex align-items-center">
                <i class="script-icon fas ${getScriptIcon(scriptName)}"></i>
                <span class="script-name ms-2">${scriptName}</span>
            </div>
            <div class="script-actions">
                <button class="btn btn-sm btn-outline-success script-action-btn" onclick="event.stopPropagation(); showDeployScriptModal('${scriptPath}')">
                    <i class="fas fa-upload"></i>
                </button>
                <button class="btn btn-sm btn-outline-warning script-action-btn ms-1" onclick="event.stopPropagation(); showExecuteScriptModal('${scriptPath}')">
                    <i class="fas fa-play"></i>
                </button>
                <button class="btn btn-sm btn-outline-danger script-action-btn ms-1" onclick="event.stopPropagation(); deleteScriptFile('${scriptPath}')">
                    <i class="fas fa-trash-alt"></i>
                </button>
            </div>
        </div>
    `;
}

// 验证是否已选择脚本和设备
function validateSelections() {
    console.log("验证选择 - 脚本:", selectedScriptPath, "设备:", selectedDevices);
    
    if (!selectedScriptPath) {
        toastr.error('请先选择一个脚本');
        return false;
    }
    
    if (selectedDevices.length === 0) {
        toastr.error('请选择至少一个目标设备');
        return false;
    }
    
    return true;
}

// 显示运行脚本模态框
function showRunScriptModal() {
    console.log("显示运行脚本模态框");
    if (!validateSelections()) {
        console.error("验证选择失败");
        return;
    }
    
    // 设置模态框内容
    const scriptName = selectedScriptPath.split('/').pop();
    document.getElementById('runScriptPath').value = selectedScriptPath;
    document.getElementById('runScriptDeviceCount').value = `${selectedDevices.length} 台设备`;
    document.getElementById('runScriptParams').value = '';
    
    // 设置命令预览
    updateCommandPreview();
    
    // 监听参数变化和root选项变化
    document.getElementById('runScriptParams').addEventListener('input', updateCommandPreview);
    document.getElementById('useRootCheck').addEventListener('change', updateCommandPreview);
    
    // 显示模态框
    const runScriptModal = document.getElementById('runScriptModal');
    if (!runScriptModal) {
        console.error("找不到运行脚本模态框元素");
        toastr.error("系统错误：找不到运行脚本模态框");
        return;
    }
    
    const modal = new bootstrap.Modal(runScriptModal);
    modal.show();
}

// 更新命令预览
function updateCommandPreview() {
    const scriptName = selectedScriptPath.split('/').pop();
    const params = document.getElementById('runScriptParams').value.trim();
    const useRoot = document.getElementById('useRootCheck').checked;
    
    let command = '';
    if (useRoot) {
        command = `sudo ./${scriptName}`;
    } else {
        command = `./${scriptName}`;
    }
    
    if (params) {
        command += ` ${params}`;
    }
    
    document.getElementById('commandPreview').value = command;
}

// 在所有设备上运行脚本
function runScriptOnDevices() {
    console.log("开始执行批量运行脚本...");
    if (!validateSelections()) {
        console.error("验证选择失败");
        return;
    }
    
    // 获取参数
    const scriptName = selectedScriptPath.split('/').pop();
    const params = document.getElementById('runScriptParams').value.trim();
    const useRoot = document.getElementById('useRootCheck').checked;
    
    console.log(`运行脚本: ${scriptName}, 参数: ${params}, 使用root: ${useRoot}`);
    console.log(`选择的设备数量: ${selectedDevices.length}`);
    
    // 关闭模态框
    const modal = bootstrap.Modal.getInstance(document.getElementById('runScriptModal'));
    if (modal) {
        modal.hide();
    }
    
    // 设置操作状态
    const statusElement = document.getElementById('batch-action-status');
    statusElement.innerHTML = `<span class="text-primary"><i class="fas fa-spinner fa-spin me-1"></i>正在${selectedDevices.length}台设备上运行脚本 ${scriptName}, 请稍候...</span>`;
    
    // 准备执行参数
    const executeData = {
        scriptPath: selectedScriptPath,
        params: params,
        useRoot: useRoot,
        devices: selectedDevices.map(device => ({
            id: device.id,
            ip: device.ip,
            username: device.username,
            password: device.password,
            sshPort: device.sshPort || 22
        }))
    };
    
    console.log("发送执行请求...");
    
    // 调用后端API执行脚本
    fetch('/api/knowledge/scripts/execute', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(executeData)
    })
    .then(response => {
        console.log(`接收到响应，状态码: ${response.status}`);
        if (!response.ok) {
            throw new Error('执行脚本失败: ' + response.status);
        }
        return response.json();
    })
    .then(data => {
        console.log("处理响应数据:", data);
        if (data.success) {
            statusElement.innerHTML = `<span class="text-success"><i class="fas fa-check-circle me-1"></i>脚本 ${scriptName} 在所有设备上执行完成</span>`;
            
            // 显示详细结果
            let resultDetails = '';
            let hasError = false;
            
            if (data.results && data.results.length > 0) {
                resultDetails = '<div class="mt-3 alert alert-info"><strong>执行结果详情:</strong><ul class="mb-0">';
                
                data.results.forEach(result => {
                    if (result.success) {
                        resultDetails += `<li>${result.ip}: 执行成功`;
                        if (result.output) {
                            resultDetails += `<pre class="mt-1 p-2 bg-light">${result.output}</pre>`;
                        }
                        resultDetails += `</li>`;
                    } else {
                        hasError = true;
                        resultDetails += `<li class="text-danger">${result.ip}: 执行失败 - ${result.message}`;
                        if (result.output) {
                            resultDetails += `<pre class="mt-1 p-2 bg-light">${result.output}</pre>`;
                        }
                        resultDetails += `</li>`;
                    }
                });
                
                resultDetails += '</ul></div>';
            }
            
            if (hasError) {
                toastr.warning('部分设备执行失败，请查看详情');
            } else {
                toastr.success('所有设备执行成功');
            }
            
            // 显示详情
            if (resultDetails) {
                document.getElementById('batch-action-status').insertAdjacentHTML('beforeend', resultDetails);
            }
        } else {
            statusElement.innerHTML = `<span class="text-danger"><i class="fas fa-times-circle me-1"></i>执行失败: ${data.message || '未知错误'}</span>`;
            toastr.error(data.message || '执行脚本失败');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        statusElement.innerHTML = `<span class="text-danger"><i class="fas fa-times-circle me-1"></i>执行出错: ${error.message}</span>`;
        toastr.error('执行脚本时发生错误: ' + error.message);
    });
}

// 设备项模板
function createDeviceTemplate(device) {
    const isSelected = selectedDevices.some(d => d.id === device.id);
    return `
        <div class="device-block ${isSelected ? 'selected' : ''}" 
             id="device-${device.id}" 
             onclick="toggleDeviceSelection('${device.id}')" 
             ondblclick="showEditDeviceModal('${device.id}')">
            <div class="d-flex justify-content-between w-100 mb-1">
                <i class="fas fa-server"></i>
                <div class="device-actions">
                    <button class="btn btn-sm btn-outline-info me-1" 
                            onclick="event.stopPropagation(); openSshConnection('${device.id}')" 
                            title="SSH连接">
                        <i class="fas fa-terminal"></i>
                    </button>
                    <button class="btn btn-sm btn-danger btn-delete-device" 
                            onclick="event.stopPropagation(); deleteDevice('${device.id}')" 
                            title="删除设备">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            <div>${device.ip}</div>
            <small class="text-muted">${device.username}@${device.sshPort || 22}</small>
        </div>
    `;
}

// 打开SSH连接
function openSshConnection(deviceId) {
    // 阻止事件冒泡，防止触发设备选择
    event.stopPropagation();
    
    const device = deviceInfoCache[deviceId];
    if (!device) {
        toastr.error('设备信息不存在');
        return;
    }
    
    // 显示进度提示
    toastr.info(`正在准备SSH连接到 ${device.ip}...`);
    
    // 发送请求到后端
    fetch('/api/scripts/ssh_connect', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            ip: device.ip,
            port: device.sshPort || 22,
            username: device.username,
            password: device.password
        })
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(err => { throw new Error(err.message || 'SSH连接失败'); });
        }
        return response.json();
    })
    .then(data => {
        console.log('SSH连接结果:', data);
        if (data.success) {
            toastr.success(`SSH连接到 ${device.ip} 成功启动`);
        } else {
            toastr.error(`SSH连接失败: ${data.message}`);
        }
    })
    .catch(error => {
        console.error('SSH连接错误:', error);
        toastr.error(`SSH连接错误: ${error.message}`);
    });
}
</script>
{% endblock %} 